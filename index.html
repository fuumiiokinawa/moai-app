<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0ea5e9">
  <title>ğŸŒº æ¨¡åˆç®¡ç†</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒº</text></svg>">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>* { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: system-ui, -apple-system, sans-serif; }</style>
</head>
<body>
  <div id="root"></div>
  <script>
    // ================================
    // Supabaseè¨­å®š
    // ================================
    const SUPABASE_URL = 'https://ivirmauzgzrxxljbadve.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2aXJtYXV6Z3pyeHhsamJhZHZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTE3OTksImV4cCI6MjA4NTE2Nzc5OX0.fRKkUnw4nTDjxDpJS_ZT-TZZbz9FM9_Bx0vR5R7GB3w';

    // Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    window.storage = {
      dbId: null,
      
      async get(key) {
        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/moai_groups?select=*&limit=1`, {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          });
          const data = await res.json();
          if (data && data.length > 0) {
            this.dbId = data[0].id;
            return { value: JSON.stringify({ groups: [data[0].data] }) };
          }
          return null;
        } catch (e) {
          console.error('Supabase GET error:', e);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        }
      },
      
      async set(key, value) {
        try {
          const parsed = JSON.parse(value);
          const groupData = parsed.groups[0];
          
          if (this.dbId) {
            // æ›´æ–°
            await fetch(`${SUPABASE_URL}/rest/v1/moai_groups?id=eq.${this.dbId}`, {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
              },
              body: JSON.stringify({ data: groupData })
            });
          } else {
            // æ–°è¦ä½œæˆ
            const res = await fetch(`${SUPABASE_URL}/rest/v1/moai_groups`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
              },
              body: JSON.stringify({ data: groupData })
            });
            const data = await res.json();
            if (data && data[0]) this.dbId = data[0].id;
          }
          // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          localStorage.setItem(key, value);
          return { key, value };
        } catch (e) {
          console.error('Supabase SET error:', e);
          localStorage.setItem(key, value);
          return { key, value };
        }
      },
      
      async delete(key) {
        localStorage.removeItem(key);
        return { key, deleted: true };
      }
    };
  </script>
  <script type="text/babel">


function MoaiManager() {
  const [currentView, setCurrentView] = React.useState('dashboard');
  const [isAdmin, setIsAdmin] = React.useState(false);
  const [showLoginModal, setShowLoginModal] = React.useState(false);
  const [groups, setGroups] = React.useState([]);
  const [selectedGroup, setSelectedGroup] = React.useState(null);
  const [showModal, setShowModal] = React.useState(null);
  const [editingMember, setEditingMember] = React.useState(null);
  const [editingEvent, setEditingEvent] = React.useState(null);
  const [notification, setNotification] = React.useState(null);
  const [selectedMonth, setSelectedMonth] = React.useState(new Date().toISOString().slice(0, 7));

  // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
  const createPresetData = () => ({
    id: 'preset-moai-1',
    name: 'æ¨¡åˆã‚°ãƒ«ãƒ¼ãƒ—',
    adminPassword: '1234', // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    monthlyAmount: 10000,
    savingsAmount: 2000,
    startMonth: '2026-03',
    endMonth: '2027-05',
    bankInfo: 'ã‚†ã†ã¡ã‚‡éŠ€è¡Œ 0520405',
    lineGroupUrl: '',
    partySchedule: { type: 'none', dayOfWeek: 6, weekOfMonth: 4 }, // å®šæœŸé–‹å‚¬è¨­å®š
    createdAt: new Date().toISOString(),
    currentBalance: 1598749,
    members: [
      { id: 'p1', name: 'ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ãƒ¤ãƒ¼', phone: '', carryOver: 1270658, memo: '' },
      { id: 'p2', name: 'ä¸‹åœ° æ•¦', phone: '', carryOver: 0, memo: '' },
      { id: 'p3', name: 'å·ä¸Š é”ä¹Ÿ', phone: '', carryOver: 0, memo: '' },
      { id: 'p4', name: 'è¥¿ å‹æ²»', phone: '', carryOver: 0, memo: '' },
      { id: 'p5', name: 'æ–‡å¹³ å¤ªä¸€æœ—', phone: '', carryOver: 0, memo: '' },
      { id: 'p6', name: 'å®®å¹³ æ•¬æ¬¡', phone: '', carryOver: 0, memo: '' },
      { id: 'p7', name: 'ä¸­è¥¿ åœ­', phone: '', carryOver: 0, memo: '' },
      { id: 'p8', name: 'å¤šå˜‰å±± å‹²', phone: '', carryOver: 0, memo: '' },
      { id: 'p9', name: 'çœŸç‰æ©‹ è£•ä¹Ÿ', phone: '', carryOver: 0, memo: '' },
      { id: 'p10', name: 'å²¡éƒ¨ æ”¿å—£', phone: '', carryOver: 0, memo: '' },
      { id: 'p11', name: 'å®®åŸ åŠŸå¤ª', phone: '', carryOver: 0, memo: '' },
      { id: 'p12', name: 'ç¥åŸ å²èª ', phone: '', carryOver: 0, memo: '' },
      { id: 'p13', name: 'ä¸­æ ¹æ¬¡ å²', phone: '', carryOver: 0, memo: '' },
      { id: 'p14', name: 'é‡‘åŸ æ´²æ–—', phone: '', carryOver: 0, memo: '' },
      { id: 'p15', name: 'ãƒ¤ã‚¹ãƒ’ ãƒ’ãƒ©ã‚¿', phone: '', carryOver: 0, memo: '' },
    ],
    payments: [],
    receives: [],
    receiveRequests: [],
    balanceHistory: [],
    savingsUsage: [],
    events: [],
    pastVenues: [], // éå»ã®åº—èˆ—å±¥æ­´
    auditLog: []
  });

  React.useEffect(() => {
    const loadData = async () => {
      try {
        const saved = await window.storage.get('moai-groups-v7');
        if (saved?.value) {
          const data = JSON.parse(saved.value);
          // è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
          const today = new Date().toISOString().slice(0, 10);
          const updatedGroups = data.groups.map(group => {
            const updatedEvents = (group.events || []).map(event => {
              // é–‹å‚¬æ—¥ã‚’éããŸé£²ã¿ä¼šã‚’è‡ªå‹•ã§å®Œäº†ã«ã™ã‚‹
              if (event.status !== 'completed' && event.date && event.date < today) {
                return { ...event, status: 'completed', autoArchived: true };
              }
              return event;
            });
            return { ...group, events: updatedEvents };
          });
          setGroups(updatedGroups || []);
          if (updatedGroups?.length > 0) setSelectedGroup(updatedGroups[0]);
        } else {
          const preset = createPresetData();
          setGroups([preset]);
          setSelectedGroup(preset);
        }
      } catch (e) {
        const preset = createPresetData();
        setGroups([preset]);
        setSelectedGroup(preset);
      }
    };
    loadData();
  }, []);

  React.useEffect(() => {
    if (groups.length > 0) window.storage.set('moai-groups-v7', JSON.stringify({ groups }));
  }, [groups]);

  const notify = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const updateGroup = (updated) => {
    const newGroups = groups.map(g => g.id === updated.id ? updated : g);
    setGroups(newGroups);
    setSelectedGroup(updated);
  };

  const addLog = (action, details, group) => ({
    ...group,
    auditLog: [...(group.auditLog || []), { id: `log-${Date.now()}`, action, details, timestamp: new Date().toISOString() }]
  });

  // ===== ç®¡ç†è€…èªè¨¼ =====
  const handleLogin = (password) => {
    if (password === selectedGroup?.adminPassword) {
      setIsAdmin(true);
      setShowLoginModal(false);
      notify('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    } else {
      notify('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 'error');
    }
  };

  const handleLogout = () => {
    setIsAdmin(false);
    notify('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
  };

  const handleChangePassword = (newPassword) => {
    let updated = { ...selectedGroup, adminPassword: newPassword };
    updated = addLog('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´', 'ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´', updated);
    updateGroup(updated);
    notify('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // ===== è¨ˆç®—é–¢æ•° =====
  const getMonthList = () => {
    if (!selectedGroup?.startMonth || !selectedGroup?.endMonth) return [];
    const months = [];
    let current = new Date(selectedGroup.startMonth + '-01');
    const end = new Date(selectedGroup.endMonth + '-01');
    while (current <= end) {
      months.push(current.toISOString().slice(0, 7));
      current.setMonth(current.getMonth() + 1);
    }
    return months;
  };

  const getActivePayments = () => selectedGroup?.payments?.filter(p => p.status !== 'deleted') || [];
  const getActiveReceives = () => selectedGroup?.receives?.filter(r => r.status !== 'deleted') || [];

  const getMemberBalance = (memberId) => {
    if (!selectedGroup) return { balance: 0, unpaidMonths: [] };
    const member = selectedGroup.members.find(m => m.id === memberId);
    const carryOver = member?.carryOver || 0;
    const monthList = getMonthList();
    const currentMonth = new Date().toISOString().slice(0, 7);
    const dueMonths = monthList.filter(m => m <= currentMonth);
    const payments = getActivePayments().filter(p => p.memberId === memberId);
    const paidMonths = payments.map(p => p.month);
    const receiveMonths = getActiveReceives().filter(r => r.winnerId === memberId).map(r => r.month);
    const allPaidMonths = [...new Set([...paidMonths, ...receiveMonths])];
    const unpaidMonths = dueMonths.filter(m => !allPaidMonths.includes(m));
    const totalDue = dueMonths.length * (selectedGroup.monthlyAmount + selectedGroup.savingsAmount);
    const totalPaid = payments.reduce((sum, p) => sum + p.amount + p.savings, 0) + carryOver;
    return { balance: totalPaid - totalDue, unpaidMonths, paidCount: payments.length };
  };

  const getMonthlyStatus = (month) => {
    if (!selectedGroup) return { paid: [], unpaid: [], total: 0 };
    const payments = getActivePayments().filter(p => p.month === month);
    const paidIds = payments.map(p => p.memberId);
    const receiveWinners = getActiveReceives().filter(r => r.month === month).map(r => r.winnerId);
    const allPaidIds = [...new Set([...paidIds, ...receiveWinners])];
    return {
      paid: selectedGroup.members.filter(m => allPaidIds.includes(m.id)),
      unpaid: selectedGroup.members.filter(m => !allPaidIds.includes(m.id)),
      total: payments.reduce((sum, p) => sum + p.amount + p.savings, 0)
    };
  };

  const getTotalSavings = () => {
    const collected = getActivePayments().reduce((sum, p) => sum + (p.savings || 0), 0);
    const used = (selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').reduce((sum, u) => sum + u.amount, 0);
    return collected - used;
  };

  const getTotalUnpaid = () => {
    if (!selectedGroup) return 0;
    return selectedGroup.members.reduce((sum, m) => {
      const bal = getMemberBalance(m.id);
      return sum + (bal.balance < 0 ? Math.abs(bal.balance) : 0);
    }, 0);
  };

  const getMembersNotReceived = () => {
    const receivedIds = getActiveReceives().map(r => r.winnerId);
    return selectedGroup?.members?.filter(m => !receivedIds.includes(m.id)) || [];
  };

  const calculateReceiveAmount = (memberId) => {
    const baseAmount = selectedGroup.monthlyAmount * selectedGroup.members.length;
    const bal = getMemberBalance(memberId);
    const offsetAmount = bal.balance < 0 ? Math.abs(bal.balance) : 0;
    return { baseAmount, offsetAmount, finalAmount: baseAmount - offsetAmount };
  };

  // æ¨¡åˆã®é€²æ—æƒ…å ±
  const getProgressInfo = () => {
    const monthList = getMonthList();
    const currentMonth = new Date().toISOString().slice(0, 7);
    const passedMonths = monthList.filter(m => m <= currentMonth).length;
    const totalMonths = monthList.length;
    const receiveCount = getActiveReceives().length;
    const remainingReceives = selectedGroup?.members?.length - receiveCount;
    return {
      currentRound: passedMonths,
      totalRounds: totalMonths,
      progressPercent: totalMonths > 0 ? Math.round((passedMonths / totalMonths) * 100) : 0,
      receiveCount,
      remainingReceives: Math.max(0, remainingReceives)
    };
  };

  // æ»ç´è€…ãƒªã‚¹ãƒˆï¼ˆä½•ãƒ¶æœˆæ»ç´ã—ã¦ã„ã‚‹ã‹ï¼‰
  const getDelinquentMembers = () => {
    if (!selectedGroup) return [];
    return selectedGroup.members
      .map(m => {
        const bal = getMemberBalance(m.id);
        return {
          ...m,
          unpaidMonths: bal.unpaidMonths.length,
          unpaidAmount: bal.balance < 0 ? Math.abs(bal.balance) : 0,
          unpaidMonthsList: bal.unpaidMonths
        };
      })
      .filter(m => m.unpaidMonths > 0)
      .sort((a, b) => b.unpaidMonths - a.unpaidMonths);
  };

  // é †ç•ªåˆ¶ã®æ¬¡ã®å—å–è€…ï¼ˆãƒ¡ãƒ³ãƒãƒ¼é †ï¼‰
  const getNextReceiver = () => {
    const notReceived = getMembersNotReceived();
    if (notReceived.length === 0) return null;
    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®é †ç•ªã§æœ€åˆã®æœªå—å–è€…
    return selectedGroup.members.find(m => notReceived.some(nr => nr.id === m.id));
  };

  // å—å–é †ãƒªã‚¹ãƒˆ
  const getReceiveOrder = () => {
    const receives = getActiveReceives();
    const receivedIds = receives.map(r => r.winnerId);
    const received = receives.map((r, i) => {
      const member = selectedGroup?.members?.find(m => m.id === r.winnerId);
      return { order: i + 1, member, month: r.month, amount: r.amount, status: 'done' };
    });
    const notReceived = selectedGroup?.members?.filter(m => !receivedIds.includes(m.id)).map((m, i) => ({
      order: receives.length + i + 1,
      member: m,
      month: null,
      amount: null,
      status: 'pending'
    })) || [];
    return [...received, ...notReceived];
  };

  // ã‚¹ãƒˆãƒƒã‚¯é‡‘ï¼ˆãƒ—ãƒ¼ãƒ«é‡‘ï¼‰ã®è¨ˆç®—
  const getPoolInfo = () => {
    if (!selectedGroup) return { poolAmount: 0, availableCount: 0 };
    
    const monthList = getMonthList();
    const currentMonth = new Date().toISOString().slice(0, 7);
    const passedMonths = monthList.filter(m => m <= currentMonth);
    
    // çµŒéæœˆæ•°åˆ†ã®å—å–ãŒã‚ã‚‹ã¹ã
    const expectedReceives = passedMonths.length;
    // å®Ÿéš›ã®å—å–å›æ•°
    const actualReceives = getActiveReceives().length;
    // æœªæ¶ˆåŒ–ã®å—å–å›æ•°ï¼ˆã‚¹ãƒˆãƒƒã‚¯ï¼‰
    const pooledCount = expectedReceives - actualReceives;
    
    // 1å›ã‚ãŸã‚Šã®å—å–é¡ï¼ˆæœ¬ä½“é‡‘é¡ Ã— ãƒ¡ãƒ³ãƒãƒ¼æ•°ï¼‰
    const receivePerTime = selectedGroup.monthlyAmount * selectedGroup.members.length;
    // ã‚¹ãƒˆãƒƒã‚¯é‡‘é¡
    const poolAmount = pooledCount * receivePerTime;
    
    return {
      poolAmount: Math.max(0, poolAmount),
      availableCount: Math.max(0, pooledCount),
      receivePerTime
    };
  };

  const getMemberPaymentForMonth = (memberId, month) => {
    const payment = getActivePayments().find(p => p.memberId === memberId && p.month === month);
    if (payment) return { status: 'paid', date: payment.recordedAt?.slice(5, 10).replace('-', '/') };
    const receive = getActiveReceives().find(r => r.month === month && r.winnerId === memberId);
    if (receive) return { status: 'offset' };
    return { status: 'unpaid' };
  };

  // æ¬¡å›é–‹å‚¬æ—¥ã®è‡ªå‹•ææ¡ˆ
  const getNextPartyDate = () => {
    const schedule = selectedGroup?.partySchedule;
    if (!schedule || schedule.type === 'none') return null;
    
    const now = new Date();
    let year = now.getFullYear();
    let month = now.getMonth();
    
    // æ¬¡ã®æœˆã‹ã‚‰æ¢ã™
    for (let i = 0; i < 3; i++) {
      month++;
      if (month > 11) { month = 0; year++; }
      
      // ç¬¬Né€±ã®Xæ›œæ—¥ã‚’è¨ˆç®—
      const firstDay = new Date(year, month, 1);
      const dayOfWeek = schedule.dayOfWeek; // 0=æ—¥, 6=åœŸ
      const weekOfMonth = schedule.weekOfMonth; // 1-4, -1=æœ€çµ‚
      
      let targetDate;
      if (weekOfMonth === -1) {
        // æœ€çµ‚é€±
        const lastDay = new Date(year, month + 1, 0);
        let d = lastDay.getDate();
        while (new Date(year, month, d).getDay() !== dayOfWeek) d--;
        targetDate = new Date(year, month, d);
      } else {
        // ç¬¬Né€±
        let count = 0;
        for (let d = 1; d <= 31; d++) {
          const date = new Date(year, month, d);
          if (date.getMonth() !== month) break;
          if (date.getDay() === dayOfWeek) {
            count++;
            if (count === weekOfMonth) {
              targetDate = date;
              break;
            }
          }
        }
      }
      
      if (targetDate && targetDate > now) {
        return targetDate.toISOString().slice(0, 10);
      }
    }
    return null;
  };

  // æŠ½é¸æ©Ÿèƒ½ï¼ˆå—å–å¸Œæœ›è€…å„ªå…ˆã€å—å–æ¸ˆã¿é™¤å¤–ï¼‰
  const handleLottery = () => {
    const notReceived = getMembersNotReceived();
    if (notReceived.length === 0) {
      notify('å…¨å“¡å—å–æ¸ˆã¿ã§ã™', 'error');
      return null;
    }
    
    // å—å–å¸Œæœ›ã‚’å‡ºã—ã¦ã„ã‚‹æœªå—å–è€…ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const requests = selectedGroup.receiveRequests || [];
    const requestMemberIds = requests.map(r => r.memberId);
    const notReceivedWithRequest = notReceived.filter(m => requestMemberIds.includes(m.id));
    
    let winner;
    if (notReceivedWithRequest.length > 0) {
      // å—å–å¸Œæœ›è€…ãŒã„ã‚Œã°ã€ãã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸
      winner = notReceivedWithRequest[Math.floor(Math.random() * notReceivedWithRequest.length)];
      notify(`ğŸ² æŠ½é¸çµæœ: ${winner.name}ã•ã‚“ï¼ï¼ˆå—å–å¸Œæœ›è€…ã‹ã‚‰ï¼‰`);
    } else {
      // å—å–å¸Œæœ›è€…ãŒã„ãªã‘ã‚Œã°ã€æœªå—å–è€…å…¨å“¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸
      winner = notReceived[Math.floor(Math.random() * notReceived.length)];
      notify(`ğŸ² æŠ½é¸çµæœ: ${winner.name}ã•ã‚“ï¼`);
    }
    
    return winner;
  };

  // ===== ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ =====
  const handleBulkPayment = (memberIds, month) => {
    let updated = { ...selectedGroup };
    memberIds.forEach((memberId, idx) => {
      updated.payments = [...updated.payments, {
        id: `pay-${Date.now()}-${idx}`, memberId, month,
        amount: selectedGroup.monthlyAmount, savings: selectedGroup.savingsAmount,
        status: 'active', recordedAt: new Date().toISOString()
      }];
    });
    updated = addLog('ä¸€æ‹¬å…¥é‡‘', `${month}: ${memberIds.length}å`, updated);
    updateGroup(updated);
    notify(`${memberIds.length}åã®å…¥é‡‘ã‚’è¨˜éŒ²`);
    setShowModal(null);
  };

  const handlePayment = (data) => {
    let updated = { ...selectedGroup, payments: [...selectedGroup.payments, { id: `pay-${Date.now()}`, ...data, status: 'active', recordedAt: new Date().toISOString() }] };
    updated = addLog('å…¥é‡‘', `${data.month}`, updated);
    updateGroup(updated);
    notify('å…¥é‡‘ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleReceive = (data) => {
    let updated = { ...selectedGroup, receives: [...selectedGroup.receives, { id: `rec-${Date.now()}`, ...data, status: 'active', recordedAt: new Date().toISOString() }] };
    // å—å–å¸Œæœ›ãŒã‚ã‚Œã°å‰Šé™¤
    updated.receiveRequests = (updated.receiveRequests || []).filter(r => r.memberId !== data.winnerId);
    updated = addLog('å—å–', `Â¥${data.amount.toLocaleString()}`, updated);
    updateGroup(updated);
    notify('å—å–ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // å…¥é‡‘å–æ¶ˆï¼ˆè«–ç†å‰Šé™¤ï¼‰
  const handleCancelPayment = (paymentId) => {
    if (!confirm('ã“ã®å…¥é‡‘ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå±¥æ­´ã«ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
    const payment = selectedGroup.payments.find(p => p.id === paymentId);
    const member = selectedGroup.members.find(m => m.id === payment?.memberId);
    let updated = {
      ...selectedGroup,
      payments: selectedGroup.payments.map(p => p.id === paymentId ? { ...p, status: 'deleted', deletedAt: new Date().toISOString() } : p)
    };
    updated = addLog('å…¥é‡‘å–æ¶ˆ', `${payment?.month} ${member?.name}`, updated);
    updateGroup(updated);
    notify('å…¥é‡‘ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  };

  // å—å–å–æ¶ˆï¼ˆè«–ç†å‰Šé™¤ï¼‰
  const handleCancelReceive = (receiveId) => {
    if (!confirm('ã“ã®å—å–ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå±¥æ­´ã«ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
    const receive = selectedGroup.receives.find(r => r.id === receiveId);
    const member = selectedGroup.members.find(m => m.id === receive?.winnerId);
    let updated = {
      ...selectedGroup,
      receives: selectedGroup.receives.map(r => r.id === receiveId ? { ...r, status: 'deleted', deletedAt: new Date().toISOString() } : r)
    };
    updated = addLog('å—å–å–æ¶ˆ', `${receive?.month} ${member?.name}`, updated);
    updateGroup(updated);
    notify('å—å–ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  };

  const handleReceiveRequest = (data) => {
    // æ—¢ã«å¸Œæœ›ã‚’å‡ºã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    const existing = (selectedGroup.receiveRequests || []).find(r => r.memberId === data.memberId);
    if (existing) {
      notify('ã“ã®äººã¯æ—¢ã«å—å–å¸Œæœ›ã‚’ç™»éŒ²æ¸ˆã¿ã§ã™', 'error');
      return;
    }
    const member = selectedGroup.members.find(m => m.id === data.memberId);
    let updated = { ...selectedGroup, receiveRequests: [...(selectedGroup.receiveRequests || []), { id: `req-${Date.now()}`, ...data, createdAt: new Date().toISOString() }] };
    updated = addLog('å—å–å¸Œæœ›', member?.name, updated);
    updateGroup(updated);
    notify('å—å–å¸Œæœ›ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleAddMember = (data) => {
    let updated = { ...selectedGroup, members: [...selectedGroup.members, { id: `mem-${Date.now()}`, ...data, carryOver: (data.carryOver || 0) * 1000 }] };
    updated = addLog('ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ', data.name, updated);
    updateGroup(updated);
    notify('è¿½åŠ ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleEditMember = (data) => {
    let updated = { ...selectedGroup, members: selectedGroup.members.map(m => m.id === editingMember.id ? { ...m, ...data, carryOver: (data.carryOver || 0) * 1000 } : m) };
    updated = addLog('ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†', data.name, updated);
    updateGroup(updated);
    setEditingMember(null);
    notify('æ›´æ–°ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleDeleteMember = (id) => {
    if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const member = selectedGroup.members.find(m => m.id === id);
    let updated = { ...selectedGroup, members: selectedGroup.members.filter(m => m.id !== id) };
    updated = addLog('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤', member?.name, updated);
    updateGroup(updated);
    notify('å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  const handleUpdateGroup = (data) => {
    let updated = { ...selectedGroup, ...data };
    updated = addLog('è¨­å®šå¤‰æ›´', '', updated);
    updateGroup(updated);
    notify('æ›´æ–°ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleBalanceRecord = (data) => {
    let updated = { ...selectedGroup, balanceHistory: [...(selectedGroup.balanceHistory || []), { id: `bal-${Date.now()}`, ...data }], currentBalance: data.balance };
    updated = addLog('æ®‹é«˜è¨˜éŒ²', `Â¥${data.balance.toLocaleString()}`, updated);
    updateGroup(updated);
    notify('æ®‹é«˜ã‚’è¨˜éŒ²');
    setShowModal(null);
  };

  // ç©ç«‹é‡‘ä½¿ç”¨
  const handleUseSavings = (data) => {
    let updated = {
      ...selectedGroup,
      savingsUsage: [...(selectedGroup.savingsUsage || []), { id: `sav-${Date.now()}`, ...data, status: 'active', recordedAt: new Date().toISOString() }]
    };
    updated = addLog('ç©ç«‹é‡‘ä½¿ç”¨', `${data.purpose}: Â¥${data.amount.toLocaleString()}`, updated);
    updateGroup(updated);
    notify('ç©ç«‹é‡‘ä½¿ç”¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // ç©ç«‹é‡‘ä½¿ç”¨å–æ¶ˆ
  const handleCancelSavingsUsage = (usageId) => {
    if (!confirm('ã“ã®ç©ç«‹é‡‘ä½¿ç”¨ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    const usage = (selectedGroup.savingsUsage || []).find(u => u.id === usageId);
    let updated = {
      ...selectedGroup,
      savingsUsage: (selectedGroup.savingsUsage || []).map(u => u.id === usageId ? { ...u, status: 'deleted', deletedAt: new Date().toISOString() } : u)
    };
    updated = addLog('ç©ç«‹é‡‘ä½¿ç”¨å–æ¶ˆ', usage?.purpose, updated);
    updateGroup(updated);
    notify('å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  };

  // ===== é£²ã¿ä¼šé–¢é€£ =====
  const handleCreateEvent = (data) => {
    const newEvent = {
      id: `evt-${Date.now()}`, ...data,
      venues: [], attendance: {}, venueVotes: {},
      status: 'voting', confirmedVenue: null,
      deadline: data.deadline || null,
      expense: null, photos: [],
      createdAt: new Date().toISOString()
    };
    let updated = { ...selectedGroup, events: [...(selectedGroup.events || []), newEvent] };
    updated = addLog('é£²ã¿ä¼šä½œæˆ', data.date, updated);
    updateGroup(updated);
    notify('é£²ã¿ä¼šã‚’ä½œæˆã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleAddVenue = (eventId, venue) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venues: [...e.venues, { id: `ven-${Date.now()}`, ...venue }] } : e)
    };
    updateGroup(updated);
    notify('åº—èˆ—ã‚’è¿½åŠ ');
  };

  const handleAddVenueFromPast = (eventId, pastVenue) => {
    handleAddVenue(eventId, { ...pastVenue, id: undefined });
  };

  const handleDeleteVenue = (eventId, venueId) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venues: e.venues.filter(v => v.id !== venueId) } : e)
    };
    updateGroup(updated);
  };

  const handleAttendanceVote = (eventId, memberId, vote) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, attendance: { ...e.attendance, [memberId]: vote } } : e)
    };
    updateGroup(updated);
  };

  const handleVenueVote = (eventId, memberId, venueId) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venueVotes: { ...e.venueVotes, [memberId]: venueId } } : e)
    };
    updateGroup(updated);
  };

  const handleConfirmEvent = (eventId, venueId) => {
    const event = selectedGroup.events.find(e => e.id === eventId);
    const venue = event?.venues.find(v => v.id === venueId);
    
    // éå»åº—èˆ—ã«è¿½åŠ 
    const existsInPast = (selectedGroup.pastVenues || []).some(v => v.name === venue.name);
    let updated = { ...selectedGroup };
    if (!existsInPast && venue) {
      updated.pastVenues = [...(updated.pastVenues || []), { id: `pv-${Date.now()}`, name: venue.name, address: venue.address, url: venue.url, budget: venue.budget, usedCount: 1, lastUsed: new Date().toISOString() }];
    } else if (venue) {
      updated.pastVenues = (updated.pastVenues || []).map(v => v.name === venue.name ? { ...v, usedCount: (v.usedCount || 0) + 1, lastUsed: new Date().toISOString() } : v);
    }
    
    updated.events = updated.events.map(e => e.id === eventId ? { ...e, status: 'confirmed', confirmedVenue: venueId } : e);
    updated = addLog('äºˆç´„ç¢ºå®š', venue?.name, updated);
    updateGroup(updated);
    notify('äºˆç´„ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
  };

  const handleCompleteEvent = (eventId) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, status: 'completed' } : e)
    };
    updateGroup(updated);
    notify('é£²ã¿ä¼šã‚’å®Œäº†ã«ã—ã¾ã—ãŸ');
  };

  // é£²ã¿ä¼šä¼šè¨ˆè¨˜éŒ²
  const handleRecordExpense = (eventId, expense) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, expense } : e)
    };
    updateGroup(updated);
    notify('ä¼šè¨ˆã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // å†™çœŸURLè¿½åŠ 
  const handleAddPhoto = (eventId, photoUrl) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, photos: [...(e.photos || []), { id: `ph-${Date.now()}`, url: photoUrl, addedAt: new Date().toISOString() }] } : e)
    };
    updateGroup(updated);
    notify('å†™çœŸã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  };

  const getCurrentEvent = () => (selectedGroup?.events || []).find(e => e.status === 'voting' || e.status === 'confirmed');
  const getPastEvents = () => (selectedGroup?.events || []).filter(e => e.status === 'completed').slice(-10);

  if (!selectedGroup) return <div style={S.loading}>èª­ã¿è¾¼ã¿ä¸­...</div>;

  return (
    <div style={S.container}>
      <header style={S.header}>
        <div style={S.headerInner}>
          <div style={S.logo}><span>ğŸŒº</span><span style={S.logoText}>æ¨¡åˆ</span></div>
          {isAdmin ? (
            <button style={S.adminBadge} onClick={handleLogout}>ğŸ‘‘ç®¡ç†è€… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          ) : (
            <button style={S.loginBadge} onClick={() => setShowLoginModal(true)}>ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
          )}
        </div>
      </header>

      {notification && <div style={{...S.toast, backgroundColor: notification.type === 'success' ? '#10b981' : '#ef4444'}}>{notification.msg}</div>}

      <main style={S.main}>
        <div style={S.infoBadge}>
          {selectedGroup.name} | ğŸ’° Â¥{(selectedGroup.currentBalance || 0).toLocaleString()}
        </div>

        <nav style={S.nav}>
          {[
            { id: 'dashboard', icon: 'ğŸ ', label: 'ãƒ›ãƒ¼ãƒ ' },
            { id: 'party', icon: 'ğŸ»', label: 'é£²ã¿ä¼š' },
            { id: 'members', icon: 'ğŸ‘¥', label: 'ãƒ¡ãƒ³ãƒãƒ¼' },
            { id: 'bulk', icon: 'âœ…', label: 'å…¥é‡‘' },
            { id: 'receive', icon: 'ğŸ¯', label: 'å—å–' },
            { id: 'table', icon: 'ğŸ“Š', label: 'ä¸€è¦§' },
            { id: 'history', icon: 'ğŸ“œ', label: 'å±¥æ­´' },
          ].map(t => (
            <button key={t.id} style={{...S.navBtn, ...(currentView === t.id ? S.navActive : {})}} onClick={() => setCurrentView(t.id)}>
              <span>{t.icon}</span><span style={S.navLabel}>{t.label}</span>
            </button>
          ))}
        </nav>

        {/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */}
        {currentView === 'dashboard' && (
          <div style={S.view}>
            {/* é€²æ—ãƒãƒ¼ */}
            {(() => {
              const progress = getProgressInfo();
              return (
                <div style={S.card}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                    <span style={{fontSize: 14, fontWeight: 600}}>ğŸ“ˆ æ¨¡åˆã®é€²æ—</span>
                    <span style={{fontSize: 14, color: '#64748b'}}>{progress.currentRound} / {progress.totalRounds}å›ç›®</span>
                  </div>
                  <div style={{background: '#e2e8f0', borderRadius: 8, height: 12, overflow: 'hidden'}}>
                    <div style={{background: 'linear-gradient(90deg, #0ea5e9, #8b5cf6)', height: '100%', width: `${progress.progressPercent}%`, transition: 'width 0.3s'}}></div>
                  </div>
                  <div style={{display: 'flex', justifyContent: 'space-between', marginTop: 8, fontSize: 12, color: '#64748b'}}>
                    <span>å—å–æ¸ˆ: {progress.receiveCount}å</span>
                    <span>æ®‹ã‚Š: {progress.remainingReceives}å</span>
                  </div>
                </div>
              );
            })()}

            <div style={S.stats}>
              <div style={S.stat}><div style={S.statLabel}>ãƒ¡ãƒ³ãƒãƒ¼</div><div style={S.statVal}>{selectedGroup.members.length}</div></div>
              <div style={S.stat}><div style={S.statLabel}>æœˆé¡</div><div style={S.statVal}>Â¥{(selectedGroup.monthlyAmount + selectedGroup.savingsAmount)/1000}åƒ</div></div>
              <div style={S.stat}><div style={S.statLabel}>ç©ç«‹æ®‹</div><div style={S.statVal}>Â¥{(getTotalSavings()/1000).toFixed(0)}åƒ</div></div>
              <div style={{...S.stat, background: getTotalUnpaid() > 0 ? '#fef2f2' : '#ecfdf5'}}><div style={S.statLabel}>æœªæ‰•è¨ˆ</div><div style={{...S.statVal, color: getTotalUnpaid() > 0 ? '#dc2626' : '#10b981'}}>Â¥{(getTotalUnpaid()/1000).toFixed(0)}åƒ</div></div>
            </div>

            {/* æœªæ‰•ã„ã‚¢ãƒ©ãƒ¼ãƒˆ */}
            {(() => {
              const delinquents = getDelinquentMembers();
              const serious = delinquents.filter(d => d.unpaidMonths >= 2);
              if (serious.length > 0) {
                return (
                  <div style={{background: '#fef2f2', border: '2px solid #fecaca', borderRadius: 14, padding: 16}}>
                    <h4 style={{color: '#dc2626', fontSize: 15, fontWeight: 700, marginBottom: 10}}>âš ï¸ æ»ç´ã‚¢ãƒ©ãƒ¼ãƒˆ</h4>
                    {serious.map(m => (
                      <div key={m.id} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid #fecaca'}}>
                        <span style={{fontWeight: 600}}>{m.name}</span>
                        <div style={{textAlign: 'right'}}>
                          <div style={{color: '#dc2626', fontWeight: 700}}>{m.unpaidMonths}ãƒ¶æœˆæ»ç´</div>
                          <div style={{fontSize: 12, color: '#b91c1c'}}>Â¥{(m.unpaidAmount/1000).toFixed(0)}åƒ</div>
                        </div>
                      </div>
                    ))}
                    {isAdmin && (
                      <button style={{...S.linkBtn, color: '#dc2626', marginTop: 8}} onClick={() => setShowModal('reminderLine')}>
                        ğŸ“± å‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
                      </button>
                    )}
                  </div>
                );
              }
              return null;
            })()}

            {getCurrentEvent() && (
              <div style={S.partyBanner}>
                <div>ğŸ» {getCurrentEvent().date} {getCurrentEvent().time}</div>
                <button style={S.partyBannerBtn} onClick={() => setCurrentView('party')}>è©³ç´° â†’</button>
              </div>
            )}

            <div style={S.card}>
              <h3 style={S.cardTitle}>ğŸ“… {selectedMonth.replace('-', 'å¹´')}æœˆ</h3>
              <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
                <button 
                  style={{...S.monthNavBtn, borderRadius: '10px 0 0 10px'}} 
                  onClick={() => {
                    const d = new Date(selectedMonth + '-01');
                    d.setMonth(d.getMonth() - 1);
                    setSelectedMonth(d.toISOString().slice(0, 7));
                  }}
                >â—€</button>
                <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} style={{...S.input, flex: 1, borderRadius: 0, textAlign: 'center'}} />
                <button 
                  style={{...S.monthNavBtn, borderRadius: '0 10px 10px 0'}} 
                  onClick={() => {
                    const d = new Date(selectedMonth + '-01');
                    d.setMonth(d.getMonth() + 1);
                    setSelectedMonth(d.toISOString().slice(0, 7));
                  }}
                >â–¶</button>
              </div>
              {(() => {
                const st = getMonthlyStatus(selectedMonth);
                return <>
                  <div style={S.row}><span>âœ… æ”¯æ‰•æ¸ˆ</span><b>{st.paid.length}/{selectedGroup.members.length}</b></div>
                  <div style={S.row}><span>â³ æœªæ‰•ã„</span><b style={{color: st.unpaid.length ? '#dc2626' : '#10b981'}}>{st.unpaid.length}å</b></div>
                  {st.unpaid.length > 0 && <div style={S.unpaidBox}>{st.unpaid.map(m => m.name).join('ã€')}</div>}
                </>;
              })()}
              {isAdmin && (
                <button style={{...S.linkBtn, marginTop: 8}} onClick={() => setShowModal('paymentReminder')}>
                  ğŸ“± å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ä½œæˆ
                </button>
              )}
            </div>

            {isAdmin && (
              <div style={S.quickBtns}>
                <button style={S.qBtn} onClick={() => setShowModal('payment')}>ğŸ’°å…¥é‡‘</button>
                <button style={{...S.qBtn, background: '#8b5cf6'}} onClick={() => setShowModal('receive')}>ğŸ¯å—å–</button>
                <button style={{...S.qBtn, background: '#f59e0b'}} onClick={() => setShowModal('createEvent')}>ğŸ»é£²ã¿ä¼š</button>
                <button style={{...S.qBtn, background: '#10b981'}} onClick={() => setShowModal('savingsUsage')}>ğŸ’ç©ç«‹</button>
              </div>
            )}

            {/* æ¬¡ã®å—å–è€…ï¼ˆé †ç•ªåˆ¶ï¼‰ */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ”„ å—å–é †</h4>
              <div style={{fontSize: 13, color: '#64748b', marginBottom: 10}}>
                ãƒ¡ãƒ³ãƒãƒ¼é †ã§æ¬¡ã®å—å–è€…ã‚’è¡¨ç¤º
              </div>
              {(() => {
                const nextReceiver = getNextReceiver();
                if (!nextReceiver) {
                  return <div style={{textAlign: 'center', color: '#10b981', fontWeight: 600}}>ğŸ‰ å…¨å“¡å—å–å®Œäº†ï¼</div>;
                }
                const calc = calculateReceiveAmount(nextReceiver.id);
                return (
                  <div style={{background: '#f0f9ff', padding: 14, borderRadius: 10, border: '2px solid #0ea5e9'}}>
                    <div style={{fontSize: 12, color: '#0369a1'}}>æ¬¡ã®å—å–è€…ï¼ˆé †ç•ªåˆ¶ã®å ´åˆï¼‰</div>
                    <div style={{fontSize: 18, fontWeight: 700, color: '#0284c7', marginTop: 4}}>{nextReceiver.name}</div>
                    <div style={{fontSize: 14, color: '#0369a1', marginTop: 4}}>å—å–äºˆå®šé¡: Â¥{(calc.finalAmount/1000).toFixed(0)}åƒ</div>
                  </div>
                );
              })()}
              <button style={{...S.linkBtn, marginTop: 10}} onClick={() => setShowModal('receiveOrder')}>
                ğŸ“‹ å—å–é †ä¸€è¦§ã‚’è¦‹ã‚‹
              </button>
            </div>

            {isAdmin && (
              <div style={S.card}>
                <h4 style={S.subTitle}>ğŸ² å—å–è€…æŠ½é¸</h4>
                <div style={{fontSize: 14, color: '#64748b', marginBottom: 10}}>
                  <div>æœªå—å–: {getMembersNotReceived().length}å</div>
                  {(selectedGroup.receiveRequests || []).length > 0 ? (
                    <div style={{color: '#f59e0b', marginTop: 6}}>
                      ğŸ“ å—å–å¸Œæœ›: {(selectedGroup.receiveRequests || []).filter(r => getMembersNotReceived().some(m => m.id === r.memberId)).length}å
                      <span style={{fontSize: 12, marginLeft: 6}}>(å„ªå…ˆæŠ½é¸)</span>
                    </div>
                  ) : (
                    // å—å–å¸Œæœ›è€…ãŒã„ãªã„å ´åˆã¯ã‚¹ãƒˆãƒƒã‚¯é‡‘ã‚’è¡¨ç¤º
                    (() => {
                      const pool = getPoolInfo();
                      if (pool.availableCount > 0) {
                        return (
                          <div style={{marginTop: 10, padding: 14, background: '#fef3c7', borderRadius: 10}}>
                            <div style={{color: '#92400e', fontWeight: 600, fontSize: 15}}>
                              ğŸ’° ã‚¹ãƒˆãƒƒã‚¯: Â¥{(pool.poolAmount / 1000).toFixed(0)}åƒ
                            </div>
                            <div style={{color: '#b45309', fontSize: 14, marginTop: 6}}>
                              â†’ ç¾åœ¨ <b>{pool.availableCount}å</b> ãŒå—å–å¯èƒ½
                            </div>
                            <div style={{color: '#78350f', fontSize: 13, marginTop: 4}}>
                              (1åã‚ãŸã‚Š Â¥{(pool.receivePerTime / 1000).toFixed(0)}åƒ)
                            </div>
                          </div>
                        );
                      }
                      return null;
                    })()
                  )}
                </div>
                <button style={S.lotteryBtn} onClick={handleLottery} disabled={getMembersNotReceived().length === 0}>
                  ğŸ² æŠ½é¸ã™ã‚‹
                </button>
                {isAdmin && (
                  <button style={{...S.linkBtn, marginTop: 10, display: 'block'}} onClick={() => setShowModal('receiveRequest')}>
                    + å—å–å¸Œæœ›ã‚’ç™»éŒ²
                  </button>
                )}
              </div>
            )}

            {/* ç©ç«‹é‡‘è©³ç´° */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ’ ç©ç«‹é‡‘</h4>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '8px 0', fontSize: 14}}>
                <span>å¾´åæ¸ˆã¿</span>
                <span>Â¥{(getActivePayments().reduce((sum, p) => sum + (p.savings || 0), 0) / 1000).toFixed(0)}åƒ</span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '8px 0', fontSize: 14, color: '#dc2626'}}>
                <span>ä½¿ç”¨æ¸ˆã¿</span>
                <span>âˆ’Â¥{((selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').reduce((sum, u) => sum + u.amount, 0) / 1000).toFixed(0)}åƒ</span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderTop: '2px solid #e2e8f0', fontSize: 16, fontWeight: 700}}>
                <span>æ®‹é«˜</span>
                <span style={{color: '#10b981'}}>Â¥{(getTotalSavings() / 1000).toFixed(0)}åƒ</span>
              </div>
              {(selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').length > 0 && (
                <div style={{marginTop: 10}}>
                  <div style={{fontSize: 12, color: '#64748b', marginBottom: 6}}>ä½¿ç”¨å±¥æ­´</div>
                  {(selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').slice(-3).reverse().map(u => (
                    <div key={u.id} style={{display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: 13, borderBottom: '1px solid #f1f5f9'}}>
                      <span>{u.purpose}</span>
                      <span>Â¥{(u.amount/1000).toFixed(0)}åƒ</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* é£²ã¿ä¼š */}
        {currentView === 'party' && (
          <PartyView
            group={selectedGroup}
            isAdmin={isAdmin}
            currentEvent={getCurrentEvent()}
            pastEvents={getPastEvents()}
            getNextPartyDate={getNextPartyDate}
            onCreateEvent={() => setShowModal('createEvent')}
            onAddVenue={handleAddVenue}
            onAddVenueFromPast={handleAddVenueFromPast}
            onDeleteVenue={handleDeleteVenue}
            onAttendanceVote={handleAttendanceVote}
            onVenueVote={handleVenueVote}
            onConfirmEvent={handleConfirmEvent}
            onCompleteEvent={handleCompleteEvent}
            onRecordExpense={(eventId) => { setEditingEvent(selectedGroup.events.find(e => e.id === eventId)); setShowModal('expense'); }}
            onAddPhoto={handleAddPhoto}
            notify={notify}
          />
        )}

        {/* ãƒ¡ãƒ³ãƒãƒ¼ */}
        {currentView === 'members' && (
          <div style={S.view}>
            <div style={S.viewHeader}>
              <h3 style={S.viewTitle}>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼</h3>
              {isAdmin && <button style={S.addBtn} onClick={() => setShowModal('addMember')}>+</button>}
            </div>
            {selectedGroup.members.map((m, i) => {
              const bal = getMemberBalance(m.id);
              const receives = getActiveReceives().filter(r => r.winnerId === m.id);
              return (
                <div key={m.id} style={S.memberCard}>
                  <div style={S.memberTop}>
                    <div style={S.memberNum}>{i + 1}</div>
                    <div style={S.memberInfo}>
                      <div style={S.memberName}>{m.name}</div>
                      {m.memo && <div style={S.memberMemo}>ğŸ“ {m.memo}</div>}
                    </div>
                    {isAdmin && (
                      <div style={S.memberBtns}>
                        <button style={S.editBtn} onClick={() => { setEditingMember(m); setShowModal('editMember'); }}>âœ</button>
                        <button style={S.delBtn} onClick={() => handleDeleteMember(m.id)}>Ã—</button>
                      </div>
                    )}
                  </div>
                  <div style={S.memberStats}>
                    <div><span style={S.mLabel}>æ®‹é«˜</span><span style={{color: bal.balance >= 0 ? '#10b981' : '#dc2626', fontWeight: 700}}>Â¥{(bal.balance/1000).toFixed(0)}åƒ</span></div>
                    <div><span style={S.mLabel}>å—å–</span><span>{receives.length}å›</span></div>
                    <div><span style={S.mLabel}>æœªæ‰•</span><span style={{color: bal.unpaidMonths.length ? '#dc2626' : '#10b981'}}>{bal.unpaidMonths.length}ãƒ¶æœˆ</span></div>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* ä¸€æ‹¬å…¥é‡‘ */}
        {currentView === 'bulk' && (
          <BulkPaymentView group={selectedGroup} month={selectedMonth} setMonth={setSelectedMonth} getMonthlyStatus={getMonthlyStatus} onSubmit={handleBulkPayment} isAdmin={isAdmin} />
        )}

        {/* å—å– */}
        {currentView === 'receive' && (
          <div style={S.view}>
            <div style={S.viewHeader}>
              <h3 style={S.viewTitle}>ğŸ¯ å—å–ç®¡ç†</h3>
              {isAdmin && <button style={S.addBtn} onClick={() => setShowModal('receive')}>+</button>}
            </div>
            <div style={S.card}>
              <h4 style={S.subTitle}>æœªå—å– ({getMembersNotReceived().length}å)</h4>
              {getMembersNotReceived().map(m => {
                const calc = calculateReceiveAmount(m.id);
                return <div key={m.id} style={S.notRecItem}><span>{m.name}</span><span style={{color: '#8b5cf6'}}>Â¥{(calc.finalAmount/1000).toFixed(0)}åƒ</span></div>;
              })}
            </div>
            <div style={S.card}>
              <h4 style={S.subTitle}>å—å–å±¥æ­´</h4>
              {getActiveReceives().length === 0 ? <div style={S.empty}>å±¥æ­´ãªã—</div> : getActiveReceives().slice().reverse().map(r => {
                const m = selectedGroup.members.find(x => x.id === r.winnerId);
                return (
                  <div key={r.id} style={{...S.histRow, alignItems: 'center'}}>
                    <span>{r.month}</span>
                    <span style={{flex: 1}}>{m?.name}</span>
                    <span style={{color: '#8b5cf6', marginRight: 8}}>Â¥{(r.amount/1000).toFixed(0)}åƒ</span>
                    {isAdmin && <button style={S.cancelSmBtn} onClick={() => handleCancelReceive(r.id)}>å–æ¶ˆ</button>}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ä¸€è¦§è¡¨ */}
        {currentView === 'table' && (
          <div style={S.view}>
            <div style={S.viewHeader}>
              <h3 style={S.viewTitle}>ğŸ“Š ä¸€è¦§è¡¨</h3>
              <button style={S.exportBtn} onClick={() => setShowModal('export')}>ğŸ“¥</button>
            </div>
            <div style={S.tableWrap}>
              <table style={S.table}>
                <thead><tr>
                  <th style={S.th}>No</th>
                  <th style={{...S.th, minWidth: 70}}>åå‰</th>
                  {getMonthList().map((m, i, arr) => {
                    // å¹´ãŒå¤‰ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‹æœ€åˆã®æœˆãªã‚‰å¹´ã‚‚è¡¨ç¤º
                    const showYear = i === 0 || m.slice(0, 4) !== arr[i - 1]?.slice(0, 4);
                    const year = m.slice(2, 4); // ä¸‹2æ¡
                    const month = m.slice(5);
                    return <th key={m} style={S.th}>{showYear ? `${year}/` : ''}{month}</th>;
                  })}
                  <th style={{...S.th, background: '#fef3c7'}}>æ®‹é«˜</th>
                </tr></thead>
                <tbody>
                  {selectedGroup.members.map((m, i) => {
                    const bal = getMemberBalance(m.id);
                    return (
                      <tr key={m.id}>
                        <td style={S.td}>{i + 1}</td>
                        <td style={{...S.td, textAlign: 'left', fontSize: 12}}>{m.name}</td>
                        {getMonthList().map(month => {
                          const info = getMemberPaymentForMonth(m.id, month);
                          return <td key={month} style={{...S.td, background: info.status === 'paid' ? '#d1fae5' : info.status === 'offset' ? '#fef3c7' : '#fee2e2', fontSize: 11}}>{info.status === 'paid' ? 'âœ“' : info.status === 'offset' ? 'ç›¸' : ''}</td>;
                        })}
                        <td style={{...S.td, fontWeight: 700, color: bal.balance >= 0 ? '#059669' : '#dc2626'}}>{(bal.balance/1000).toFixed(0)}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* å±¥æ­´ */}
        {currentView === 'history' && (
          <div style={S.view}>
            <h3 style={S.viewTitle}>ğŸ“œ æ“ä½œå±¥æ­´</h3>
            
            {/* å…¥é‡‘å±¥æ­´ */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ’° å…¥é‡‘å±¥æ­´</h4>
              {selectedGroup.payments.length === 0 ? (
                <div style={S.empty}>å±¥æ­´ãªã—</div>
              ) : (
                selectedGroup.payments.slice().reverse().map(p => {
                  const m = selectedGroup.members.find(x => x.id === p.memberId);
                  const isDeleted = p.status === 'deleted';
                  return (
                    <div key={p.id} style={{...S.histRow, alignItems: 'center', opacity: isDeleted ? 0.5 : 1, background: isDeleted ? '#fef2f2' : 'transparent'}}>
                      <span style={{fontSize: 12, color: '#64748b'}}>{p.recordedAt?.slice(0, 10)}</span>
                      <span>{p.month}</span>
                      <span style={{flex: 1}}>{m?.name || 'ä¸æ˜'}</span>
                      <span style={{color: '#0ea5e9', marginRight: 8}}>Â¥{((p.amount + p.savings)/1000).toFixed(0)}åƒ</span>
                      {isDeleted ? (
                        <span style={{fontSize: 11, color: '#dc2626', padding: '2px 6px', background: '#fee2e2', borderRadius: 4}}>å–æ¶ˆæ¸ˆ</span>
                      ) : (
                        isAdmin && <button style={S.cancelSmBtn} onClick={() => handleCancelPayment(p.id)}>å–æ¶ˆ</button>
                      )}
                    </div>
                  );
                })
              )}
            </div>

            {/* å—å–å±¥æ­´ */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ¯ å—å–å±¥æ­´</h4>
              {selectedGroup.receives.length === 0 ? (
                <div style={S.empty}>å±¥æ­´ãªã—</div>
              ) : (
                selectedGroup.receives.slice().reverse().map(r => {
                  const m = selectedGroup.members.find(x => x.id === r.winnerId);
                  const isDeleted = r.status === 'deleted';
                  return (
                    <div key={r.id} style={{...S.histRow, alignItems: 'center', opacity: isDeleted ? 0.5 : 1, background: isDeleted ? '#fef2f2' : 'transparent'}}>
                      <span style={{fontSize: 12, color: '#64748b'}}>{r.recordedAt?.slice(0, 10)}</span>
                      <span>{r.month}</span>
                      <span style={{flex: 1}}>{m?.name || 'ä¸æ˜'}</span>
                      <span style={{color: '#8b5cf6', marginRight: 8}}>Â¥{(r.amount/1000).toFixed(0)}åƒ</span>
                      {isDeleted ? (
                        <span style={{fontSize: 11, color: '#dc2626', padding: '2px 6px', background: '#fee2e2', borderRadius: 4}}>å–æ¶ˆæ¸ˆ</span>
                      ) : (
                        isAdmin && <button style={S.cancelSmBtn} onClick={() => handleCancelReceive(r.id)}>å–æ¶ˆ</button>
                      )}
                    </div>
                  );
                })
              )}
            </div>

            {/* ç›£æŸ»ãƒ­ã‚° */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ“‹ ç›£æŸ»ãƒ­ã‚°</h4>
              <div style={{fontSize: 12, color: '#64748b', marginBottom: 10}}>
                â€» ã“ã®å±¥æ­´ã¯å‰Šé™¤ã§ãã¾ã›ã‚“
              </div>
              {(selectedGroup.auditLog || []).length === 0 ? (
                <div style={S.empty}>å±¥æ­´ãªã—</div>
              ) : (
                (selectedGroup.auditLog || []).slice().reverse().slice(0, 50).map(log => (
                  <div key={log.id} style={{...S.histRow, fontSize: 13}}>
                    <span style={{fontSize: 11, color: '#64748b', minWidth: 80}}>{log.timestamp?.slice(5, 16).replace('T', ' ')}</span>
                    <span style={{fontWeight: 600, color: '#334155'}}>{log.action}</span>
                    <span style={{flex: 1, color: '#64748b'}}>{log.details}</span>
                  </div>
                ))
              )}
            </div>
          </div>
        )}
      </main>

      {/* ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showLoginModal && (
        <Modal onClose={() => setShowLoginModal(false)}>
          <LoginForm onLogin={handleLogin} onCancel={() => setShowLoginModal(false)} />
        </Modal>
      )}

      {/* ãã®ä»–ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showModal && (
        <Modal onClose={() => setShowModal(null)}>
          {showModal === 'payment' && <PaymentForm group={selectedGroup} month={selectedMonth} payments={getActivePayments()} onSubmit={handlePayment} onCancel={() => setShowModal(null)} />}
          {showModal === 'receive' && <ReceiveForm group={selectedGroup} month={selectedMonth} notReceived={getMembersNotReceived()} calculateAmount={calculateReceiveAmount} onSubmit={handleReceive} onCancel={() => setShowModal(null)} />}
          {showModal === 'receiveRequest' && <ReceiveRequestForm group={selectedGroup} notReceived={getMembersNotReceived()} onSubmit={handleReceiveRequest} onCancel={() => setShowModal(null)} />}
          {showModal === 'addMember' && <MemberForm onSubmit={handleAddMember} onCancel={() => setShowModal(null)} />}
          {showModal === 'editMember' && <MemberForm member={editingMember} onSubmit={handleEditMember} onCancel={() => { setShowModal(null); setEditingMember(null); }} />}
          {showModal === 'balance' && <BalanceForm onSubmit={handleBalanceRecord} onCancel={() => setShowModal(null)} />}
          {showModal === 'createEvent' && <EventForm nextDate={getNextPartyDate()} onSubmit={handleCreateEvent} onCancel={() => setShowModal(null)} />}
          {showModal === 'expense' && editingEvent && <ExpenseForm event={editingEvent} members={selectedGroup.members} onSubmit={(data) => handleRecordExpense(editingEvent.id, data)} onCancel={() => { setShowModal(null); setEditingEvent(null); }} />}
          {showModal === 'settings' && <SettingsForm group={selectedGroup} onSubmit={handleUpdateGroup} onChangePassword={handleChangePassword} onCancel={() => setShowModal(null)} />}
          {showModal === 'export' && <ExportForm group={selectedGroup} getMonthList={getMonthList} getMemberPaymentForMonth={getMemberPaymentForMonth} getMemberBalance={getMemberBalance} onCancel={() => setShowModal(null)} />}
          {showModal === 'savingsUsage' && <SavingsUsageForm group={selectedGroup} totalSavings={getTotalSavings()} onSubmit={handleUseSavings} onCancel={() => setShowModal(null)} onCancelUsage={handleCancelSavingsUsage} />}
          {showModal === 'paymentReminder' && <PaymentReminderModal group={selectedGroup} month={selectedMonth} status={getMonthlyStatus(selectedMonth)} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'reminderLine' && <DelinquentReminderModal group={selectedGroup} delinquents={getDelinquentMembers()} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'receiveOrder' && <ReceiveOrderModal group={selectedGroup} receiveOrder={getReceiveOrder()} onClose={() => setShowModal(null)} />}
        </Modal>
      )}

      {/* è¨­å®šãƒœã‚¿ãƒ³ */}
      {isAdmin && (
        <button style={S.settingsFab} onClick={() => setShowModal('settings')}>âš™ï¸</button>
      )}
    </div>
  );
}

// ===== ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ =====

function Modal({ children, onClose }) {
  return (
    <div style={S.overlay} onClick={onClose}>
      <div style={S.modal} onClick={e => e.stopPropagation()}>{children}</div>
    </div>
  );
}

function LoginForm({ onLogin, onCancel }) {
  const [pw, setPw] = React.useState('');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
      <input type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value={pw} onChange={e => setPw(e.target.value)} style={S.input} autoFocus />
      <div style={S.hint}>åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: 1234</div>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onLogin(pw)}>ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  );
}

function PaymentForm({ group, month, payments, onSubmit, onCancel }) {
  const [memberId, setMemberId] = React.useState('');
  const [payMonth, setPayMonth] = React.useState(month);
  const [amount, setAmount] = React.useState(group.monthlyAmount / 1000);
  const [savings, setSavings] = React.useState(group.savingsAmount / 1000);
  const unpaid = group.members.filter(m => !payments.some(p => p.memberId === m.id && p.month === payMonth));
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’° å…¥é‡‘</h3>
      <input type="month" value={payMonth} onChange={e => setPayMonth(e.target.value)} style={S.input} />
      <select value={memberId} onChange={e => setMemberId(e.target.value)} style={S.input}>
        <option value="">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</option>
        {unpaid.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
      </select>
      <div style={S.row2}>
        <input type="number" value={amount} onChange={e => setAmount(+e.target.value)} style={S.input} placeholder="æœ¬ä½“(åƒå††)" />
        <input type="number" value={savings} onChange={e => setSavings(+e.target.value)} style={S.input} placeholder="ç©ç«‹(åƒå††)" />
      </div>
      <div style={S.total}>åˆè¨ˆ: Â¥{((amount + savings) * 1000).toLocaleString()}</div>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ memberId, month: payMonth, amount: amount * 1000, savings: savings * 1000 })} disabled={!memberId}>è¨˜éŒ²</button>
      </div>
    </div>
  );
}

function ReceiveForm({ group, month, notReceived, calculateAmount, onSubmit, onCancel }) {
  const [winnerId, setWinnerId] = React.useState('');
  const [recMonth, setRecMonth] = React.useState(month);
  const [useCustomAmount, setUseCustomAmount] = React.useState(false);
  const [customAmount, setCustomAmount] = React.useState('');
  
  const calc = winnerId ? calculateAmount(winnerId) : { baseAmount: 0, offsetAmount: 0, finalAmount: 0 };
  const finalAmount = useCustomAmount ? (customAmount * 1000) : calc.finalAmount;
  
  // å—å–æ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
  const receivedIds = (group.receives || []).filter(r => r.status !== 'deleted').map(r => r.winnerId);
  const isReceived = (memberId) => receivedIds.includes(memberId);
  
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ¯ å—å–ï¼ˆæ‰•ã„å‡ºã—ï¼‰</h3>
      
      <label style={S.label}>ğŸ“… å—å–æœˆ</label>
      <input type="month" value={recMonth} onChange={e => setRecMonth(e.target.value)} style={S.input} />
      
      <label style={S.label}>ğŸ‘¤ å—å–è€…</label>
      <select value={winnerId} onChange={e => { setWinnerId(e.target.value); setUseCustomAmount(false); }} style={S.input}>
        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        <optgroup label="ğŸ”´ æœªå—å–">
          {notReceived.map(m => (
            <option key={m.id} value={m.id}>{m.name}</option>
          ))}
        </optgroup>
        <optgroup label="âœ… å—å–æ¸ˆï¼ˆ2å›ç›®ä»¥é™ï¼‰">
          {group.members.filter(m => isReceived(m.id)).map(m => (
            <option key={m.id} value={m.id}>{m.name}ï¼ˆå—å–æ¸ˆï¼‰</option>
          ))}
        </optgroup>
      </select>
      
      {winnerId && (
        <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, marginTop: 8}}>
          <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 14}}>
            <span>åŸºæœ¬é¡ï¼ˆ{group.members.length}å Ã— Â¥{(group.monthlyAmount/1000).toFixed(0)}åƒï¼‰</span>
            <span style={{fontWeight: 600}}>Â¥{(calc.baseAmount/1000).toFixed(0)}åƒ</span>
          </div>
          {calc.offsetAmount > 0 && (
            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 14, color: '#dc2626'}}>
              <span>âš ï¸ æœªæ‰•ã„åˆ†ã‚’ç›¸æ®º</span>
              <span>âˆ’Â¥{(calc.offsetAmount/1000).toFixed(0)}åƒ</span>
            </div>
          )}
          <div style={{display: 'flex', justifyContent: 'space-between', paddingTop: 8, borderTop: '2px solid #e2e8f0', fontSize: 16, fontWeight: 700}}>
            <span>è¨ˆç®—ä¸Šã®å—å–é¡</span>
            <span style={{color: '#8b5cf6'}}>Â¥{(calc.finalAmount/1000).toFixed(0)}åƒ</span>
          </div>
        </div>
      )}
      
      <div style={{marginTop: 12}}>
        <label style={{display: 'flex', alignItems: 'center', gap: 8, fontSize: 14, cursor: 'pointer'}}>
          <input 
            type="checkbox" 
            checked={useCustomAmount} 
            onChange={e => setUseCustomAmount(e.target.checked)}
            style={{width: 20, height: 20}}
          />
          é‡‘é¡ã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹
        </label>
      </div>
      
      {useCustomAmount && (
        <div style={{marginTop: 8}}>
          <label style={S.label}>ğŸ’° å®Ÿéš›ã®å—å–é¡ï¼ˆåƒå††ï¼‰</label>
          <input 
            type="number" 
            value={customAmount} 
            onChange={e => setCustomAmount(e.target.value)} 
            style={S.input} 
            placeholder={`ä¾‹: ${(calc.finalAmount/1000).toFixed(0)}`}
          />
        </div>
      )}
      
      <div style={{...S.total, marginTop: 12, fontSize: 20}}>
        å—å–é¡: Â¥{(finalAmount/1000).toFixed(0)}åƒ
        <div style={{fontSize: 12, color: '#64748b', marginTop: 4}}>
          ï¼ˆÂ¥{finalAmount.toLocaleString()}ï¼‰
        </div>
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button 
          style={S.submitBtn} 
          onClick={() => onSubmit({ 
            winnerId, 
            month: recMonth, 
            amount: finalAmount, 
            baseAmount: calc.baseAmount,
            offsetAmount: useCustomAmount ? 0 : calc.offsetAmount 
          })} 
          disabled={!winnerId || (useCustomAmount && !customAmount)}
        >
          è¨˜éŒ²ã™ã‚‹
        </button>
      </div>
    </div>
  );
}

function ReceiveRequestForm({ group, notReceived, onSubmit, onCancel }) {
  const [memberId, setMemberId] = React.useState('');
  const existingRequests = (group.receiveRequests || []).map(r => r.memberId);
  // æœªå—å–ã‹ã¤å¸Œæœ›æœªç™»éŒ²ã®äººã®ã¿è¡¨ç¤º
  const availableMembers = notReceived.filter(m => !existingRequests.includes(m.id));
  
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“ å—å–å¸Œæœ›ç™»éŒ²</h3>
      <p style={{fontSize: 14, color: '#64748b', margin: '0 0 14px'}}>
        æŠ½é¸æ™‚ã«å„ªå…ˆã•ã‚Œã¾ã™
      </p>
      {availableMembers.length === 0 ? (
        <div style={S.empty}>ç™»éŒ²å¯èƒ½ãªãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>
      ) : (
        <>
          <select value={memberId} onChange={e => setMemberId(e.target.value)} style={S.input}>
            <option value="">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</option>
            {availableMembers.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
          </select>
          <div style={S.btnRow}>
            <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style={S.submitBtn} onClick={() => onSubmit({ memberId })} disabled={!memberId}>ç™»éŒ²</button>
          </div>
        </>
      )}
      {existingRequests.length > 0 && (
        <div style={{marginTop: 18, padding: 14, background: '#fef3c7', borderRadius: 10}}>
          <div style={{fontSize: 14, fontWeight: 600, marginBottom: 10}}>ğŸ“ ç¾åœ¨ã®å—å–å¸Œæœ›è€…</div>
          {(group.receiveRequests || []).map(r => {
            const m = group.members.find(x => x.id === r.memberId);
            return <div key={r.id} style={{fontSize: 14, padding: '6px 0'}}>{m?.name}</div>;
          })}
        </div>
      )}
    </div>
  );
}

function MemberForm({ member, onSubmit, onCancel }) {
  const [name, setName] = React.useState(member?.name || '');
  const [phone, setPhone] = React.useState(member?.phone || '');
  const [carryOver, setCarryOver] = React.useState((member?.carryOver || 0) / 1000);
  const [memo, setMemo] = React.useState(member?.memo || '');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>{member ? 'âœ ç·¨é›†' : '+ è¿½åŠ '}</h3>
      <input type="text" value={name} onChange={e => setName(e.target.value)} style={S.input} placeholder="åå‰" />
      <input type="tel" value={phone} onChange={e => setPhone(e.target.value)} style={S.input} placeholder="é›»è©±ç•ªå·" />
      <input type="number" value={carryOver} onChange={e => setCarryOver(+e.target.value)} style={S.input} placeholder="ç¹°è¶Š(åƒå††)" />
      <input type="text" value={memo} onChange={e => setMemo(e.target.value)} style={S.input} placeholder="ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šæ¥æœˆä¸å‚åŠ ï¼‰" />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ name, phone, carryOver, memo })} disabled={!name}>{member ? 'æ›´æ–°' : 'è¿½åŠ '}</button>
      </div>
    </div>
  );
}

function BalanceForm({ onSubmit, onCancel }) {
  const [date, setDate] = React.useState(new Date().toISOString().slice(0, 10));
  const [balance, setBalance] = React.useState('');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’³ æ®‹é«˜è¨˜éŒ²</h3>
      <input type="date" value={date} onChange={e => setDate(e.target.value)} style={S.input} />
      <input type="number" value={balance} onChange={e => setBalance(e.target.value)} style={S.input} placeholder="æ®‹é«˜(å††)" />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ date, balance: +balance })} disabled={!balance}>è¨˜éŒ²</button>
      </div>
    </div>
  );
}

function EventForm({ nextDate, onSubmit, onCancel }) {
  const [date, setDate] = React.useState(nextDate || '');
  const [time, setTime] = React.useState('19:00');
  const [deadline, setDeadline] = React.useState('');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ» é£²ã¿ä¼šä½œæˆ</h3>
      {nextDate && <div style={S.hint}>ğŸ’¡ ææ¡ˆæ—¥: {nextDate}</div>}
      <input type="date" value={date} onChange={e => setDate(e.target.value)} style={S.input} />
      <input type="time" value={time} onChange={e => setTime(e.target.value)} style={S.input} />
      <label style={S.label}>æŠ•ç¥¨ç· åˆ‡æ—¥ï¼ˆä»»æ„ï¼‰</label>
      <input type="date" value={deadline} onChange={e => setDeadline(e.target.value)} style={S.input} />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ date, time, deadline, month: date?.slice(5, 7) })} disabled={!date}>ä½œæˆ</button>
      </div>
    </div>
  );
}

function ExpenseForm({ event, members, onSubmit, onCancel }) {
  const [total, setTotal] = React.useState('');
  const [perPerson, setPerPerson] = React.useState('');
  const [paidBy, setPaidBy] = React.useState('');
  const [note, setNote] = React.useState('');
  
  const yesCount = Object.values(event.attendance || {}).filter(v => v === 'yes').length;
  
  React.useEffect(() => {
    if (total && yesCount > 0) {
      setPerPerson(Math.ceil(+total / yesCount));
    }
  }, [total, yesCount]);

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’¸ ä¼šè¨ˆè¨˜éŒ²</h3>
      <div style={S.hint}>å‚åŠ è€…: {yesCount}å</div>
      <input type="number" value={total} onChange={e => setTotal(e.target.value)} style={S.input} placeholder="åˆè¨ˆé‡‘é¡(å††)" />
      <div style={S.calcResult}>ä¸€äººã‚ãŸã‚Š: Â¥{perPerson ? (+perPerson).toLocaleString() : '-'}</div>
      <select value={paidBy} onChange={e => setPaidBy(e.target.value)} style={S.input}>
        <option value="">èª°ãŒæ‰•ã£ãŸï¼Ÿ</option>
        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
      </select>
      <input type="text" value={note} onChange={e => setNote(e.target.value)} style={S.input} placeholder="ãƒ¡ãƒ¢" />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ total: +total, perPerson: +perPerson, paidBy, note })} disabled={!total}>è¨˜éŒ²</button>
      </div>
    </div>
  );
}

function SettingsForm({ group, onSubmit, onChangePassword, onCancel }) {
  const [name, setName] = React.useState(group.name);
  const [monthlyAmount, setMonthlyAmount] = React.useState((group.monthlyAmount || 0) / 1000);
  const [savingsAmount, setSavingsAmount] = React.useState((group.savingsAmount || 0) / 1000);
  const [startMonth, setStartMonth] = React.useState(group.startMonth || '');
  const [endMonth, setEndMonth] = React.useState(group.endMonth || '');
  const [bankInfo, setBankInfo] = React.useState(group.bankInfo || '');
  const [lineUrl, setLineUrl] = React.useState(group.lineGroupUrl || '');
  const [scheduleType, setScheduleType] = React.useState(group.partySchedule?.type || 'none');
  const [dayOfWeek, setDayOfWeek] = React.useState(group.partySchedule?.dayOfWeek || 6);
  const [weekOfMonth, setWeekOfMonth] = React.useState(group.partySchedule?.weekOfMonth || 4);
  const [newPw, setNewPw] = React.useState('');
  const [showPwChange, setShowPwChange] = React.useState(false);

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>âš™ï¸ è¨­å®š</h3>
      <input type="text" value={name} onChange={e => setName(e.target.value)} style={S.input} placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" />
      
      <label style={S.label}>ğŸ’° é‡‘é¡è¨­å®š</label>
      <div style={S.row2}>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>æœ¬ä½“ï¼ˆåƒå††ï¼‰</div>
          <input type="number" value={monthlyAmount} onChange={e => setMonthlyAmount(+e.target.value)} style={S.input} placeholder="10" />
        </div>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>ç©ç«‹ï¼ˆåƒå††ï¼‰</div>
          <input type="number" value={savingsAmount} onChange={e => setSavingsAmount(+e.target.value)} style={S.input} placeholder="2" />
        </div>
      </div>
      
      <label style={S.label}>ğŸ“… æœŸé–“è¨­å®š</label>
      <div style={S.row2}>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>é–‹å§‹æœˆ</div>
          <input type="month" value={startMonth} onChange={e => setStartMonth(e.target.value)} style={S.input} />
        </div>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>çµ‚äº†æœˆ</div>
          <input type="month" value={endMonth} onChange={e => setEndMonth(e.target.value)} style={S.input} />
        </div>
      </div>
      
      <label style={S.label}>ğŸ¦ å£åº§æƒ…å ±</label>
      <input type="text" value={bankInfo} onChange={e => setBankInfo(e.target.value)} style={S.input} placeholder="ã‚†ã†ã¡ã‚‡éŠ€è¡Œ 0520405" />
      
      <label style={S.label}>ğŸ’¬ LINEã‚°ãƒ«ãƒ¼ãƒ—URL</label>
      <input type="text" value={lineUrl} onChange={e => setLineUrl(e.target.value)} style={S.input} placeholder="https://line.me/..." />
      
      <label style={S.label}>ğŸ» å®šæœŸé–‹å‚¬è¨­å®š</label>
      <select value={scheduleType} onChange={e => setScheduleType(e.target.value)} style={S.input}>
        <option value="none">è¨­å®šãªã—</option>
        <option value="monthly">æ¯æœˆ</option>
      </select>
      {scheduleType === 'monthly' && (
        <div style={S.row2}>
          <select value={weekOfMonth} onChange={e => setWeekOfMonth(+e.target.value)} style={S.input}>
            <option value={1}>ç¬¬1</option>
            <option value={2}>ç¬¬2</option>
            <option value={3}>ç¬¬3</option>
            <option value={4}>ç¬¬4</option>
            <option value={-1}>æœ€çµ‚</option>
          </select>
          <select value={dayOfWeek} onChange={e => setDayOfWeek(+e.target.value)} style={S.input}>
            <option value={0}>æ—¥æ›œ</option>
            <option value={1}>æœˆæ›œ</option>
            <option value={2}>ç«æ›œ</option>
            <option value={3}>æ°´æ›œ</option>
            <option value={4}>æœ¨æ›œ</option>
            <option value={5}>é‡‘æ›œ</option>
            <option value={6}>åœŸæ›œ</option>
          </select>
        </div>
      )}

      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ 
          name, 
          monthlyAmount: monthlyAmount * 1000, 
          savingsAmount: savingsAmount * 1000, 
          startMonth, 
          endMonth, 
          bankInfo, 
          lineGroupUrl: lineUrl, 
          partySchedule: { type: scheduleType, dayOfWeek, weekOfMonth } 
        })}>ä¿å­˜</button>
      </div>

      <hr style={{margin: '20px 0', border: 'none', borderTop: '1px solid #e2e8f0'}} />

      {showPwChange ? (
        <>
          <input type="password" value={newPw} onChange={e => setNewPw(e.target.value)} style={S.input} placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
          <div style={S.btnRow}>
            <button style={S.cancelBtn} onClick={() => setShowPwChange(false)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style={S.submitBtn} onClick={() => { onChangePassword(newPw); setShowPwChange(false); }} disabled={!newPw}>å¤‰æ›´</button>
          </div>
        </>
      ) : (
        <button style={S.linkBtn} onClick={() => setShowPwChange(true)}>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
      )}
    </div>
  );
}

function ExportForm({ group, getMonthList, getMemberPaymentForMonth, getMemberBalance, onCancel }) {
  const handleExport = () => {
    const months = getMonthList();
    let csv = '\uFEFF' + group.name + '\n';
    csv += `No,åå‰,${months.map(m => m.slice(5) + 'æœˆ').join(',')},æ®‹é«˜\n`;
    group.members.forEach((m, i) => {
      const bal = getMemberBalance(m.id);
      csv += `${i + 1},${m.name},${months.map(mo => { const info = getMemberPaymentForMonth(m.id, mo); return info.status === 'paid' ? 'âœ“' : info.status === 'offset' ? 'ç›¸æ®º' : ''; }).join(',')},${bal.balance / 1000}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `æ¨¡åˆ_${new Date().toISOString().slice(0, 10)}.csv`; a.click();
  };
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“Š ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>é–‰ã˜ã‚‹</button>
        <button style={S.submitBtn} onClick={handleExport}>ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>
  );
}

// ç©ç«‹é‡‘ä½¿ç”¨ãƒ•ã‚©ãƒ¼ãƒ 
function SavingsUsageForm({ group, totalSavings, onSubmit, onCancel, onCancelUsage }) {
  const [purpose, setPurpose] = React.useState('');
  const [amount, setAmount] = React.useState('');
  const usageHistory = (group.savingsUsage || []).filter(u => u.status !== 'deleted');
  
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’ ç©ç«‹é‡‘ç®¡ç†</h3>
      
      <div style={{background: '#f0fdf4', padding: 14, borderRadius: 10, marginBottom: 16}}>
        <div style={{fontSize: 12, color: '#166534'}}>ç¾åœ¨ã®ç©ç«‹æ®‹é«˜</div>
        <div style={{fontSize: 24, fontWeight: 700, color: '#15803d'}}>Â¥{(totalSavings/1000).toFixed(0)}åƒ</div>
      </div>
      
      <label style={S.label}>ä½¿ç”¨ç›®çš„</label>
      <input type="text" value={purpose} onChange={e => setPurpose(e.target.value)} style={S.input} placeholder="ä¾‹: é£²ã¿ä¼šè£œåŠ©ã€æ™¯å“ä»£" />
      
      <label style={S.label}>é‡‘é¡ï¼ˆå††ï¼‰</label>
      <input type="number" value={amount} onChange={e => setAmount(e.target.value)} style={S.input} placeholder="ä¾‹: 10000" />
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>é–‰ã˜ã‚‹</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ purpose, amount: +amount })} disabled={!purpose || !amount || +amount > totalSavings}>ä½¿ç”¨è¨˜éŒ²</button>
      </div>
      
      {usageHistory.length > 0 && (
        <div style={{marginTop: 20}}>
          <h4 style={{fontSize: 14, fontWeight: 600, marginBottom: 10}}>ğŸ“‹ ä½¿ç”¨å±¥æ­´</h4>
          {usageHistory.map(u => (
            <div key={u.id} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: '1px solid #f1f5f9'}}>
              <div>
                <div style={{fontWeight: 600}}>{u.purpose}</div>
                <div style={{fontSize: 12, color: '#64748b'}}>{u.recordedAt?.slice(0, 10)}</div>
              </div>
              <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                <span style={{color: '#dc2626'}}>Â¥{(u.amount/1000).toFixed(0)}åƒ</span>
                <button style={S.cancelSmBtn} onClick={() => onCancelUsage(u.id)}>å–æ¶ˆ</button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function PaymentReminderModal({ group, month, status, onClose, notify }) {
  const monthDisplay = month.replace('-', 'å¹´') + 'æœˆ';
  const unpaidNames = status.unpaid.map(m => m.name).join('ã€');
  const amount = (group.monthlyAmount + group.savingsAmount).toLocaleString();
  
  const message = `ğŸŒº ${group.name} å…¥é‡‘ã®ãŠé¡˜ã„ ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… ${monthDisplay}åˆ†
ğŸ’° é‡‘é¡: Â¥${amount}
ğŸ¦ æŒ¯è¾¼å…ˆ: ${group.bankInfo || 'ï¼ˆè¦ç¢ºèªï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${status.unpaid.length > 0 ? `â³ æœªå…¥é‡‘ã®æ–¹ï¼ˆ${status.unpaid.length}åï¼‰:
${unpaidNames}

ãŠå¿™ã—ã„ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€
ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ğŸ™` : 'âœ… å…¨å“¡å…¥é‡‘æ¸ˆã¿ã§ã™ï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ‰'}`;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“± å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰</h3>
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 300, overflow: 'auto'}}>
        {message}
      </div>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
      {group.lineGroupUrl && (
        <a href={group.lineGroupUrl} target="_blank" rel="noreferrer" style={{...S.lineLink, marginTop: 10}}>ğŸ’¬ LINEã‚’é–‹ã</a>
      )}
    </div>
  );
}

// æ»ç´è€…å‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function DelinquentReminderModal({ group, delinquents, onClose, notify }) {
  const [selectedMember, setSelectedMember] = React.useState(delinquents[0]?.id || '');
  const member = delinquents.find(d => d.id === selectedMember);
  
  const message = member ? `${member.name}ã•ã‚“

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
${group.name}ã®æ¨¡åˆã«ã¤ã„ã¦ç¢ºèªã•ã›ã¦ãã ã•ã„ã€‚

ç¾åœ¨ ${member.unpaidMonths}ãƒ¶æœˆåˆ†ï¼ˆÂ¥${(member.unpaidAmount/1000).toFixed(0)}åƒï¼‰ãŒæœªå…¥é‡‘ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

ãŠå¿™ã—ã„ã¨ã“ã‚æç¸®ã§ã™ãŒã€
ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

ä½•ã‹ã”äº‹æƒ…ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€
ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ğŸ™

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¦ æŒ¯è¾¼å…ˆ: ${group.bankInfo || 'ï¼ˆè¦ç¢ºèªï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”` : '';

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“± å‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      
      <label style={S.label}>é€ä¿¡å…ˆ</label>
      <select value={selectedMember} onChange={e => setSelectedMember(e.target.value)} style={S.input}>
        {delinquents.map(d => (
          <option key={d.id} value={d.id}>{d.name}ï¼ˆ{d.unpaidMonths}ãƒ¶æœˆæ»ç´ï¼‰</option>
        ))}
      </select>
      
      <div style={{background: '#fef2f2', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 250, overflow: 'auto', marginTop: 10}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  );
}

// å—å–é †ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
function ReceiveOrderModal({ group, receiveOrder, onClose }) {
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“‹ å—å–é †ä¸€è¦§</h3>
      <div style={{fontSize: 13, color: '#64748b', marginBottom: 12}}>
        ãƒ¡ãƒ³ãƒãƒ¼é †ã§å—å–ã—ãŸå ´åˆã®é †ç•ªã§ã™
      </div>
      
      <div style={{maxHeight: 400, overflow: 'auto'}}>
        {receiveOrder.map((item, i) => (
          <div key={i} style={{
            display: 'flex', 
            alignItems: 'center', 
            padding: '12px', 
            marginBottom: 8, 
            borderRadius: 10,
            background: item.status === 'done' ? '#d1fae5' : '#f8fafc',
            border: item.status === 'done' ? '2px solid #10b981' : '2px solid #e2e8f0'
          }}>
            <div style={{
              width: 32, 
              height: 32, 
              borderRadius: '50%', 
              background: item.status === 'done' ? '#10b981' : '#0ea5e9', 
              color: '#fff', 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center', 
              fontWeight: 700,
              marginRight: 12
            }}>
              {item.order}
            </div>
            <div style={{flex: 1}}>
              <div style={{fontWeight: 600}}>{item.member?.name}</div>
              {item.status === 'done' && (
                <div style={{fontSize: 12, color: '#059669'}}>{item.month} Â¥{(item.amount/1000).toFixed(0)}åƒ</div>
              )}
            </div>
            <div style={{
              padding: '4px 10px', 
              borderRadius: 6, 
              fontSize: 12, 
              fontWeight: 600,
              background: item.status === 'done' ? '#059669' : '#e2e8f0',
              color: item.status === 'done' ? '#fff' : '#64748b'
            }}>
              {item.status === 'done' ? 'âœ“ å—å–æ¸ˆ' : 'å¾…ã¡'}
            </div>
          </div>
        ))}
      </div>
      
      <button style={{...S.cancelBtn, width: '100%', marginTop: 12}} onClick={onClose}>é–‰ã˜ã‚‹</button>
    </div>
  );
}

function BulkPaymentView({ group, month, setMonth, getMonthlyStatus, onSubmit, isAdmin }) {
  const [selected, setSelected] = React.useState([]);
  const status = getMonthlyStatus(month);
  const toggle = (id) => setSelected(p => p.includes(id) ? p.filter(x => x !== id) : [...p, id]);

  const changeMonth = (delta) => {
    const d = new Date(month + '-01');
    d.setMonth(d.getMonth() + delta);
    setMonth(d.toISOString().slice(0, 7));
    setSelected([]);
  };

  return (
    <div style={S.view}>
      <h3 style={S.viewTitle}>âœ… ä¸€æ‹¬å…¥é‡‘</h3>
      <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
        <button style={{...S.monthNavBtn, borderRadius: '10px 0 0 10px'}} onClick={() => changeMonth(-1)}>â—€</button>
        <input type="month" value={month} onChange={e => { setMonth(e.target.value); setSelected([]); }} style={{...S.input, flex: 1, borderRadius: 0, textAlign: 'center'}} />
        <button style={{...S.monthNavBtn, borderRadius: '0 10px 10px 0'}} onClick={() => changeMonth(1)}>â–¶</button>
      </div>
      <div style={S.bulkInfo}><span>é¸æŠ: {selected.length}å</span><span>Â¥{((group.monthlyAmount + group.savingsAmount) * selected.length).toLocaleString()}</span></div>
      <div style={S.bulkBtns}>
        <button style={S.selectBtn} onClick={() => setSelected(status.unpaid.map(m => m.id))}>å…¨é¸æŠ</button>
        <button style={S.selectBtn} onClick={() => setSelected([])}>è§£é™¤</button>
      </div>
      <div style={S.bulkList}>
        {group.members.map(m => {
          const isPaid = status.paid.some(p => p.id === m.id);
          const isSel = selected.includes(m.id);
          return (
            <div key={m.id} style={{...S.bulkItem, background: isPaid ? '#d1fae5' : isSel ? '#dbeafe' : '#fff', opacity: isPaid ? 0.6 : 1}} onClick={() => !isPaid && toggle(m.id)}>
              <span>{isPaid ? 'âœ…' : isSel ? 'â˜‘ï¸' : 'â¬œ'}</span>
              <span>{m.name}</span>
            </div>
          );
        })}
      </div>
      {isAdmin && selected.length > 0 && <button style={S.fixedBtn} onClick={() => onSubmit(selected, month)}>{selected.length}åã®å…¥é‡‘ã‚’è¨˜éŒ²</button>}
    </div>
  );
}

function PartyView({ group, isAdmin, currentEvent, pastEvents, getNextPartyDate, onCreateEvent, onAddVenue, onAddVenueFromPast, onDeleteVenue, onAttendanceVote, onVenueVote, onConfirmEvent, onCompleteEvent, onRecordExpense, onAddPhoto, notify }) {
  const [selectedMemberId, setSelectedMemberId] = React.useState(group.members[0]?.id || '');
  const [showAddVenue, setShowAddVenue] = React.useState(false);
  const [showPastVenues, setShowPastVenues] = React.useState(false);
  const [newVenue, setNewVenue] = React.useState({ name: '', address: '', url: '', budget: '' });
  const [photoUrl, setPhotoUrl] = React.useState('');

  if (!currentEvent) {
    return (
      <div style={S.view}>
        <div style={S.viewHeader}>
          <h3 style={S.viewTitle}>ğŸ» é£²ã¿ä¼š</h3>
          {isAdmin && <button style={S.addBtn} onClick={onCreateEvent}>+</button>}
        </div>
        <div style={S.emptyParty}>
          <div style={{fontSize: 56}}>ğŸº</div>
          <p style={{fontSize: 16}}>äºˆå®šãªã—</p>
          {getNextPartyDate() && <p style={{...S.hint, fontSize: 14}}>ğŸ’¡ æ¬¡å›ææ¡ˆ: {getNextPartyDate()}</p>}
          {isAdmin && <button style={S.createBtn} onClick={onCreateEvent}>é£²ã¿ä¼šã‚’ä½œæˆ</button>}
        </div>
        {pastEvents.length > 0 && (
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ“¸ éå»ã®é£²ã¿ä¼š</h4>
            {pastEvents.map(e => {
              const venue = e.venues.find(v => v.id === e.confirmedVenue);
              const yesCount = Object.values(e.attendance || {}).filter(v => v === 'yes').length;
              return (
                <div key={e.id} style={S.pastRow}>
                  <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                    <span>{e.date}</span>
                    {e.autoArchived && <span style={{fontSize: 11, background: '#e2e8f0', padding: '3px 6px', borderRadius: 4}}>è‡ªå‹•</span>}
                  </div>
                  <span>{venue?.name || '-'}</span>
                  <span style={{fontSize: 13, color: '#64748b'}}>{yesCount}å</span>
                  {e.expense && <span>Â¥{e.expense.perPerson?.toLocaleString()}/äºº</span>}
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  }

  const att = currentEvent.attendance || {};
  const counts = {
    yes: Object.values(att).filter(v => v === 'yes').length,
    no: Object.values(att).filter(v => v === 'no').length,
    maybe: Object.values(att).filter(v => v === 'maybe').length,
  };
  const venueCounts = {};
  Object.values(currentEvent.venueVotes || {}).forEach(vid => { venueCounts[vid] = (venueCounts[vid] || 0) + 1; });
  const confirmedVenue = currentEvent.venues.find(v => v.id === currentEvent.confirmedVenue);
  const isDeadlinePassed = currentEvent.deadline && new Date(currentEvent.deadline) < new Date();

  return (
    <div style={S.view}>
      <div style={S.viewHeader}>
        <h3 style={S.viewTitle}>ğŸ» {currentEvent.date}</h3>
        {currentEvent.status === 'confirmed' && <span style={S.confirmedTag}>âœ“ç¢ºå®š</span>}
      </div>

      {/* åŸºæœ¬æƒ…å ± */}
      <div style={S.partyInfo}>
        <div style={{fontSize: 16}}>ğŸ“… {currentEvent.date} {currentEvent.time}</div>
        {currentEvent.deadline && <div style={{fontSize: 13, color: isDeadlinePassed ? '#dc2626' : '#64748b', marginTop: 4}}>â° ç· åˆ‡: {currentEvent.deadline} {isDeadlinePassed && '(ç· åˆ‡æ¸ˆ)'}</div>}
        {confirmedVenue && (
          <div style={S.confirmedBox}>
            <div style={{fontWeight: 700, fontSize: 16}}>ğŸ“ {confirmedVenue.name}</div>
            {confirmedVenue.address && <div style={{fontSize: 14, marginTop: 4}}>{confirmedVenue.address}</div>}
            {confirmedVenue.url && <a href={confirmedVenue.url} target="_blank" rel="noreferrer" style={S.link}>ğŸ”— è©³ç´°</a>}
          </div>
        )}
      </div>

      {/* å‚åŠ å¯å¦ */}
      <div style={S.card}>
        <h4 style={S.subTitle}>ğŸ—³ï¸ å‚åŠ å¯å¦</h4>
        <div style={S.voteBar}>
          <div style={{...S.voteSection, background: '#10b981', width: `${(counts.yes / group.members.length) * 100}%`}}></div>
          <div style={{...S.voteSection, background: '#f59e0b', width: `${(counts.maybe / group.members.length) * 100}%`}}></div>
          <div style={{...S.voteSection, background: '#ef4444', width: `${(counts.no / group.members.length) * 100}%`}}></div>
        </div>
        <div style={S.voteCounts}>
          <span style={{color: '#10b981'}}>â­•{counts.yes}</span>
          <span style={{color: '#f59e0b'}}>ğŸ”º{counts.maybe}</span>
          <span style={{color: '#ef4444'}}>âŒ{counts.no}</span>
        </div>
        <div style={S.myVote}>
          <select value={selectedMemberId} onChange={e => setSelectedMemberId(e.target.value)} style={S.input}>
            {group.members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
          </select>
          <div style={S.voteBtns}>
            {['yes', 'maybe', 'no'].map(v => (
              <button key={v} style={{...S.voteBtn, background: att[selectedMemberId] === v ? (v === 'yes' ? '#10b981' : v === 'maybe' ? '#f59e0b' : '#ef4444') : '#f1f5f9', color: att[selectedMemberId] === v ? '#fff' : '#64748b'}} onClick={() => onAttendanceVote(currentEvent.id, selectedMemberId, v)}>
                {v === 'yes' ? 'â­•' : v === 'maybe' ? 'ğŸ”º' : 'âŒ'}
              </button>
            ))}
          </div>
        </div>
        <div style={S.attList}>
          {group.members.map(m => (
            <div key={m.id} style={S.attItem}>
              <span>{m.name}</span>
              <span style={{color: att[m.id] === 'yes' ? '#10b981' : att[m.id] === 'maybe' ? '#f59e0b' : att[m.id] === 'no' ? '#ef4444' : '#94a3b8'}}>
                {att[m.id] === 'yes' ? 'â­•' : att[m.id] === 'maybe' ? 'ğŸ”º' : att[m.id] === 'no' ? 'âŒ' : 'âˆ’'}
              </span>
            </div>
          ))}
        </div>
      </div>

      {/* åº—èˆ—å€™è£œ */}
      {currentEvent.status === 'voting' && (
        <div style={S.card}>
          <h4 style={S.subTitle}>ğŸ“ åº—èˆ—å€™è£œ</h4>
          {currentEvent.venues.length === 0 && <div style={S.empty}>å€™è£œãªã—</div>}
          {currentEvent.venues.map(v => {
            const cnt = venueCounts[v.id] || 0;
            const myVote = currentEvent.venueVotes?.[selectedMemberId] === v.id;
            return (
              <div key={v.id} style={{...S.venueCard, borderColor: myVote ? '#0ea5e9' : '#e2e8f0'}}>
                <div style={S.venueTop}>
                  <div>
                    <div style={{fontWeight: 600, fontSize: 15}}>{v.name}</div>
                    {v.budget && <div style={{fontSize: 13, color: '#f59e0b'}}>ğŸ’°{v.budget}</div>}
                  </div>
                  <div style={S.voteCount}>{cnt}<span style={{fontSize: 12}}>ç¥¨</span></div>
                </div>
                <div style={S.venueActions}>
                  <button style={{...S.venueVoteBtn, background: myVote ? '#0ea5e9' : '#f1f5f9', color: myVote ? '#fff' : '#64748b'}} onClick={() => onVenueVote(currentEvent.id, selectedMemberId, v.id)}>{myVote ? 'âœ“æŠ•ç¥¨æ¸ˆ' : 'æŠ•ç¥¨'}</button>
                  {v.url && <a href={v.url} target="_blank" rel="noreferrer" style={S.venueUrlBtn}>ğŸ”—</a>}
                  {isAdmin && <button style={S.venueDelBtn} onClick={() => onDeleteVenue(currentEvent.id, v.id)}>ğŸ—‘</button>}
                </div>
              </div>
            );
          })}

          {isAdmin && (
            <>
              {showPastVenues ? (
                <div style={S.pastVenuesBox}>
                  <div style={{fontWeight: 600, marginBottom: 10, fontSize: 15}}>ğŸ® éå»ã®åº—èˆ—</div>
                  {(group.pastVenues || []).length === 0 ? <div style={S.empty}>å±¥æ­´ãªã—</div> : (group.pastVenues || []).map(v => (
                    <div key={v.id} style={S.pastVenueItem} onClick={() => { onAddVenueFromPast(currentEvent.id, v); setShowPastVenues(false); }}>
                      <span style={{fontSize: 14}}>{v.name}</span>
                      <span style={{fontSize: 12, color: '#64748b'}}>{v.usedCount}å›åˆ©ç”¨</span>
                    </div>
                  ))}
                  <button style={S.linkBtn} onClick={() => setShowPastVenues(false)}>é–‰ã˜ã‚‹</button>
                </div>
              ) : showAddVenue ? (
                <div style={S.addVenueForm}>
                  <input type="text" value={newVenue.name} onChange={e => setNewVenue({...newVenue, name: e.target.value})} style={S.input} placeholder="åº—èˆ—å *" />
                  <input type="text" value={newVenue.address} onChange={e => setNewVenue({...newVenue, address: e.target.value})} style={S.input} placeholder="ä½æ‰€" />
                  <input type="text" value={newVenue.url} onChange={e => setNewVenue({...newVenue, url: e.target.value})} style={S.input} placeholder="URL" />
                  <input type="text" value={newVenue.budget} onChange={e => setNewVenue({...newVenue, budget: e.target.value})} style={S.input} placeholder="äºˆç®—" />
                  <div style={S.btnRow}>
                    <button style={S.cancelBtn} onClick={() => setShowAddVenue(false)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button style={S.submitBtn} onClick={() => { onAddVenue(currentEvent.id, newVenue); setNewVenue({ name: '', address: '', url: '', budget: '' }); setShowAddVenue(false); }} disabled={!newVenue.name}>è¿½åŠ </button>
                  </div>
                </div>
              ) : (
                <div style={S.addVenueBtns}>
                  <button style={S.addVenueBtn} onClick={() => setShowAddVenue(true)}>+ æ–°è¦è¿½åŠ </button>
                  <button style={S.pastVenueBtn} onClick={() => setShowPastVenues(true)}>ğŸ® éå»ã‹ã‚‰é¸ã¶</button>
                </div>
              )}
            </>
          )}
        </div>
      )}

      {/* ç¢ºå®šãƒœã‚¿ãƒ³ */}
      {isAdmin && currentEvent.status === 'voting' && currentEvent.venues.length > 0 && (
        <div style={S.card}>
          <h4 style={S.subTitle}>ğŸ“¢ äºˆç´„ç¢ºå®š</h4>
          {currentEvent.venues.map(v => (
            <button key={v.id} style={S.confirmBtn} onClick={() => onConfirmEvent(currentEvent.id, v.id)}>{v.name} ã§ç¢ºå®š</button>
          ))}
        </div>
      )}

      {/* ç¢ºå®šå¾Œ */}
      {currentEvent.status === 'confirmed' && (
        <>
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ“¢ LINEé€šçŸ¥</h4>
            <button style={S.lineBtn} onClick={() => {
              const yes = Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
              const maybe = Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
              const msg = `ğŸŒº æ¨¡åˆé£²ã¿ä¼šã®ãŠçŸ¥ã‚‰ã› ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æ—¥æ™‚: ${currentEvent.date} (${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(currentEvent.date).getDay()]}æ›œæ—¥) ${currentEvent.time}ã€œ

ğŸ“ åº—èˆ—: ${confirmedVenue?.name || 'æœªå®š'}
${confirmedVenue?.address ? `ğŸ“® ä½æ‰€: ${confirmedVenue.address}` : ''}
${confirmedVenue?.budget ? `ğŸ’° äºˆç®—: ${confirmedVenue.budget}` : ''}
${confirmedVenue?.url ? `ğŸ”— è©³ç´°: ${confirmedVenue.url}` : ''}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… å‚åŠ  (${yes.length}å):
${yes.join('ã€') || 'ãªã—'}

${maybe.length > 0 ? `ğŸ”º æœªå®š (${maybe.length}å):\n${maybe.join('ã€')}\n` : ''}
ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼ğŸ»`;
              navigator.clipboard?.writeText(msg);
              notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }}>ğŸ“‹ LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼</button>
            {group.lineGroupUrl && <a href={group.lineGroupUrl} target="_blank" rel="noreferrer" style={S.lineLink}>ğŸ’¬ LINEã‚’é–‹ã</a>}
          </div>

          {/* ä¼šè¨ˆ */}
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ’¸ ä¼šè¨ˆ</h4>
            {currentEvent.expense ? (
              <div style={{fontSize: 15}}>
                <div style={{marginBottom: 6}}>åˆè¨ˆ: Â¥{currentEvent.expense.total?.toLocaleString()}</div>
                <div style={{fontWeight: 600}}>ä¸€äºº: Â¥{currentEvent.expense.perPerson?.toLocaleString()}</div>
              </div>
            ) : (
              isAdmin && <button style={S.linkBtn} onClick={() => onRecordExpense(currentEvent.id)}>+ ä¼šè¨ˆã‚’è¨˜éŒ²</button>
            )}
          </div>

          {/* å†™çœŸ */}
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ“¸ å†™çœŸã‚¢ãƒ«ãƒãƒ </h4>
            <div style={S.photoGrid}>
              {(currentEvent.photos || []).map(p => (
                <a key={p.id} href={p.url} target="_blank" rel="noreferrer" style={S.photoLink}>ğŸ–¼</a>
              ))}
            </div>
            {isAdmin && (
              <div style={S.addPhotoRow}>
                <input type="text" value={photoUrl} onChange={e => setPhotoUrl(e.target.value)} style={{...S.input, flex: 1}} placeholder="å†™çœŸURL" />
                <button style={S.addPhotoBtn} onClick={() => { onAddPhoto(currentEvent.id, photoUrl); setPhotoUrl(''); }} disabled={!photoUrl}>è¿½åŠ </button>
              </div>
            )}
          </div>

          {/* å®Œäº†ãƒœã‚¿ãƒ³ */}
          {isAdmin && (
            <button style={S.completeBtn} onClick={() => onCompleteEvent(currentEvent.id)}>âœ“ é£²ã¿ä¼šã‚’å®Œäº†ã«ã™ã‚‹</button>
          )}
        </>
      )}
    </div>
  );
}

// ===== ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–ç‰ˆï¼‰ =====
const S = {
  container: { minHeight: '100vh', background: '#f1f5f9', fontFamily: 'system-ui, sans-serif', WebkitTextSizeAdjust: '100%' },
  loading: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', fontSize: 18 },
  header: { background: 'linear-gradient(135deg, #0ea5e9, #0284c7)', padding: '14px 16px', position: 'sticky', top: 0, zIndex: 100 },
  headerInner: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', maxWidth: 600, margin: '0 auto' },
  logo: { display: 'flex', alignItems: 'center', gap: 8, color: '#fff', fontSize: 22 },
  logoText: { fontWeight: 700 },
  adminBadge: { background: 'rgba(255,255,255,0.2)', color: '#fff', border: 'none', padding: '8px 14px', borderRadius: 20, fontSize: 13, cursor: 'pointer', minHeight: 40 },
  loginBadge: { background: '#fff', color: '#0ea5e9', border: 'none', padding: '8px 14px', borderRadius: 20, fontSize: 13, fontWeight: 600, cursor: 'pointer', minHeight: 40 },
  toast: { position: 'fixed', top: 70, left: '50%', transform: 'translateX(-50%)', padding: '12px 24px', borderRadius: 10, color: '#fff', fontSize: 15, zIndex: 200, fontWeight: 500 },
  main: { maxWidth: 600, margin: '0 auto', padding: 14, paddingBottom: 90 },
  infoBadge: { textAlign: 'center', padding: 12, background: '#e0f2fe', borderRadius: 10, fontSize: 15, color: '#0369a1', marginBottom: 14, fontWeight: 600 },
  nav: { display: 'flex', gap: 4, marginBottom: 18, background: '#fff', padding: 6, borderRadius: 14 },
  navBtn: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4, padding: '10px 4px', border: 'none', borderRadius: 12, background: 'transparent', cursor: 'pointer', fontSize: 18, minHeight: 56 },
  navActive: { background: '#0ea5e9', color: '#fff' },
  navLabel: { fontSize: 11, fontWeight: 600 },
  view: { display: 'flex', flexDirection: 'column', gap: 14 },
  viewHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' },
  viewTitle: { fontSize: 18, fontWeight: 700 },
  stats: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 },
  stat: { background: '#fff', padding: '14px 6px', borderRadius: 12, textAlign: 'center' },
  statLabel: { fontSize: 11, color: '#64748b', marginBottom: 4 },
  statVal: { fontSize: 20, fontWeight: 700 },
  partyBanner: { background: 'linear-gradient(135deg, #f59e0b, #d97706)', padding: 14, borderRadius: 14, color: '#fff', display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 15 },
  partyBannerBtn: { background: 'rgba(255,255,255,0.2)', border: 'none', color: '#fff', padding: '10px 16px', borderRadius: 10, fontSize: 14, cursor: 'pointer', fontWeight: 600, minHeight: 44 },
  card: { background: '#fff', padding: 18, borderRadius: 14 },
  cardTitle: { fontSize: 16, fontWeight: 700, marginBottom: 14 },
  monthNavBtn: { padding: '14px 16px', background: '#0ea5e9', color: '#fff', border: 'none', fontSize: 16, cursor: 'pointer', minHeight: 48, fontWeight: 600 },
  subTitle: { fontSize: 15, fontWeight: 600, marginBottom: 10, color: '#334155' },
  row: { display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #f1f5f9', fontSize: 15 },
  unpaidBox: { marginTop: 10, padding: 12, background: '#fef2f2', borderRadius: 8, fontSize: 14, color: '#dc2626', lineHeight: 1.5 },
  quickBtns: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 },
  qBtn: { padding: '14px 8px', background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 12, fontSize: 13, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  lotteryBtn: { width: '100%', padding: 16, background: '#8b5cf6', color: '#fff', border: 'none', borderRadius: 12, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  addBtn: { width: 44, height: 44, background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: '50%', fontSize: 24, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' },
  cancelSmBtn: { padding: '6px 10px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: 6, fontSize: 12, cursor: 'pointer', fontWeight: 600, minHeight: 32 },
  exportBtn: { padding: '10px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: 8, fontSize: 15, cursor: 'pointer', minHeight: 44 },
  memberCard: { background: '#fff', borderRadius: 14, padding: 16 },
  memberTop: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 },
  memberNum: { width: 36, height: 36, background: '#0ea5e9', color: '#fff', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 14, fontWeight: 700 },
  memberInfo: { flex: 1 },
  memberName: { fontSize: 16, fontWeight: 600 },
  memberMemo: { fontSize: 13, color: '#f59e0b', marginTop: 4 },
  memberBtns: { display: 'flex', gap: 8 },
  editBtn: { width: 40, height: 40, background: '#e0f2fe', color: '#0284c7', border: 'none', borderRadius: '50%', cursor: 'pointer', fontSize: 16 },
  delBtn: { width: 40, height: 40, background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '50%', cursor: 'pointer', fontSize: 18 },
  memberStats: { display: 'flex', justifyContent: 'space-around', paddingTop: 12, borderTop: '1px solid #f1f5f9', fontSize: 14 },
  mLabel: { color: '#64748b', marginRight: 6 },
  notRecItem: { display: 'flex', justifyContent: 'space-between', padding: '12px 14px', background: '#f8fafc', borderRadius: 8, marginBottom: 8, fontSize: 14 },
  histRow: { display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #f1f5f9', fontSize: 14 },
  empty: { textAlign: 'center', padding: 30, color: '#94a3b8', fontSize: 15 },
  tableWrap: { overflowX: 'auto', background: '#fff', borderRadius: 12, WebkitOverflowScrolling: 'touch' },
  table: { width: '100%', borderCollapse: 'collapse', fontSize: 13 },
  th: { padding: '12px 6px', background: '#f1f5f9', borderBottom: '2px solid #e2e8f0', fontWeight: 600, textAlign: 'center', whiteSpace: 'nowrap' },
  td: { padding: '10px 6px', borderBottom: '1px solid #f1f5f9', textAlign: 'center', whiteSpace: 'nowrap' },
  bulkInfo: { display: 'flex', justifyContent: 'space-between', padding: 14, background: '#fff', borderRadius: 10, fontWeight: 600, fontSize: 15 },
  bulkBtns: { display: 'flex', gap: 10 },
  selectBtn: { flex: 1, padding: 12, background: '#e2e8f0', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, minHeight: 44 },
  bulkList: { display: 'flex', flexDirection: 'column', gap: 8 },
  bulkItem: { display: 'flex', alignItems: 'center', gap: 12, padding: '14px 16px', borderRadius: 10, cursor: 'pointer', minHeight: 52 },
  fixedBtn: { position: 'fixed', bottom: 24, left: 16, right: 16, maxWidth: 568, margin: '0 auto', padding: 16, background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 14, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  emptyParty: { textAlign: 'center', padding: 50 },
  createBtn: { padding: '14px 28px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: 12, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  pastRow: { display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderBottom: '1px solid #f1f5f9', fontSize: 14 },
  partyInfo: { background: '#fff', padding: 18, borderRadius: 14, borderLeft: '4px solid #f59e0b' },
  confirmedBox: { marginTop: 14, padding: 14, background: '#fefce8', borderRadius: 10 },
  link: { color: '#0ea5e9', fontSize: 14, textDecoration: 'none' },
  confirmedTag: { background: '#d1fae5', color: '#059669', padding: '6px 12px', borderRadius: 8, fontSize: 13, fontWeight: 600 },
  voteBar: { display: 'flex', height: 12, borderRadius: 6, overflow: 'hidden', background: '#e2e8f0', marginBottom: 10 },
  voteSection: { height: '100%' },
  voteCounts: { display: 'flex', justifyContent: 'center', gap: 20, fontSize: 15, marginBottom: 14 },
  myVote: { padding: 14, background: '#f8fafc', borderRadius: 10, marginBottom: 14 },
  voteBtns: { display: 'flex', gap: 10, marginTop: 10 },
  voteBtn: { flex: 1, padding: 14, border: 'none', borderRadius: 10, fontSize: 18, cursor: 'pointer', minHeight: 52 },
  attList: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 6 },
  attItem: { display: 'flex', justifyContent: 'space-between', padding: '10px 12px', background: '#f8fafc', borderRadius: 8, fontSize: 14 },
  venueCard: { padding: 16, border: '2px solid #e2e8f0', borderRadius: 12, marginBottom: 10 },
  venueTop: { display: 'flex', justifyContent: 'space-between', marginBottom: 10 },
  voteCount: { fontSize: 28, fontWeight: 700, color: '#0ea5e9' },
  venueActions: { display: 'flex', gap: 10 },
  venueVoteBtn: { flex: 1, padding: 12, border: 'none', borderRadius: 8, fontSize: 14, fontWeight: 600, cursor: 'pointer', minHeight: 44 },
  venueUrlBtn: { padding: '10px 14px', background: '#f1f5f9', border: 'none', borderRadius: 8, textDecoration: 'none', fontSize: 14, minHeight: 44, display: 'flex', alignItems: 'center' },
  venueDelBtn: { padding: '10px 14px', background: '#fee2e2', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, minHeight: 44 },
  addVenueBtns: { display: 'flex', gap: 10 },
  addVenueBtn: { flex: 1, padding: 14, background: '#f1f5f9', border: '2px dashed #cbd5e1', borderRadius: 10, color: '#64748b', cursor: 'pointer', fontSize: 14, minHeight: 48 },
  pastVenueBtn: { flex: 1, padding: 14, background: '#fef3c7', border: 'none', borderRadius: 10, color: '#92400e', cursor: 'pointer', fontSize: 14, minHeight: 48 },
  addVenueForm: { display: 'flex', flexDirection: 'column', gap: 10, marginTop: 14 },
  pastVenuesBox: { marginTop: 14, padding: 14, background: '#fffbeb', borderRadius: 10 },
  pastVenueItem: { display: 'flex', justifyContent: 'space-between', padding: '12px 14px', background: '#fff', borderRadius: 8, marginBottom: 8, cursor: 'pointer', minHeight: 48, alignItems: 'center' },
  confirmBtn: { width: '100%', padding: 14, background: '#10b981', color: '#fff', border: 'none', borderRadius: 10, fontSize: 15, fontWeight: 600, cursor: 'pointer', marginBottom: 10, minHeight: 48 },
  lineBtn: { width: '100%', padding: 14, background: '#06c755', color: '#fff', border: 'none', borderRadius: 10, fontSize: 16, fontWeight: 600, cursor: 'pointer', marginBottom: 10, minHeight: 52 },
  lineLink: { display: 'block', textAlign: 'center', padding: 14, background: '#f1f5f9', borderRadius: 10, color: '#06c755', fontWeight: 600, textDecoration: 'none', fontSize: 15, minHeight: 48 },
  photoGrid: { display: 'flex', flexWrap: 'wrap', gap: 10, marginBottom: 14 },
  photoLink: { width: 56, height: 56, background: '#f1f5f9', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', textDecoration: 'none', fontSize: 24 },
  addPhotoRow: { display: 'flex', gap: 10 },
  addPhotoBtn: { padding: '12px 18px', background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 10, cursor: 'pointer', fontSize: 14, minHeight: 44 },
  completeBtn: { width: '100%', padding: 14, background: '#64748b', color: '#fff', border: 'none', borderRadius: 10, fontSize: 15, fontWeight: 600, cursor: 'pointer', minHeight: 48 },
  overlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16, zIndex: 300 },
  modal: { background: '#fff', borderRadius: 20, padding: 24, width: '100%', maxWidth: 400, maxHeight: '85vh', overflow: 'auto', WebkitOverflowScrolling: 'touch' },
  form: { display: 'flex', flexDirection: 'column', gap: 14 },
  formTitle: { fontSize: 20, fontWeight: 700, marginBottom: 8 },
  label: { fontSize: 14, fontWeight: 600, color: '#475569', marginTop: 8 },
  input: { padding: 14, fontSize: 16, border: '2px solid #e2e8f0', borderRadius: 10, width: '100%', boxSizing: 'border-box', minHeight: 48 },
  hint: { fontSize: 13, color: '#64748b', marginTop: 4 },
  row2: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 },
  total: { padding: 16, background: '#f0f9ff', borderRadius: 10, textAlign: 'center', fontSize: 18, fontWeight: 700, color: '#0284c7' },
  calcResult: { padding: 16, background: '#f0f9ff', borderRadius: 10, textAlign: 'center', fontSize: 18, fontWeight: 700, color: '#0284c7' },
  btnRow: { display: 'flex', gap: 12, marginTop: 8 },
  cancelBtn: { flex: 1, padding: 14, background: '#f1f5f9', color: '#475569', border: 'none', borderRadius: 10, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  submitBtn: { flex: 1, padding: 14, background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 10, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  linkBtn: { padding: 12, background: 'transparent', color: '#0ea5e9', border: 'none', fontSize: 15, cursor: 'pointer', textDecoration: 'underline' },
  settingsFab: { position: 'fixed', bottom: 24, right: 20, width: 56, height: 56, background: '#fff', border: '2px solid #e2e8f0', borderRadius: '50%', fontSize: 24, cursor: 'pointer', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center' },
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<MoaiManager />);
  </script>
</body>
</html>
