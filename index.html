<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="æ¨¡åˆ">
  <meta name="theme-color" content="#1f2937">
  <meta name="description" content="æ²–ç¸„ã®æ¨¡åˆï¼ˆã‚‚ã‚ã„ï¼‰ã‚’ç°¡å˜ã«ç®¡ç†ã§ãã‚‹ã‚¢ãƒ—ãƒª">
  <title>ãƒ¢ æ¨¡åˆç®¡ç†</title>
  
  <!-- PWA Manifest (ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ã€Œãƒ¢ã€ã‚¢ã‚¤ã‚³ãƒ³) -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuaooeWQiOeuoeeQhiIsCiAgInNob3J0X25hbWUiOiAi5qih5ZCIIiwKICAiZGVzY3JpcHRpb24iOiAi5rKW57iE44Gu5qih5ZCI77yI44KC44GC44GE77yJ44KS57Ch5Y2Y44Gr566h55CG44Gn44GN44KL44Ki44OX44OqIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMTExODI3IiwKICAidGhlbWVfY29sb3IiOiAiIzFmMjkzNyIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ2RlZnMlM0UlM0NsaW5lYXJHcmFkaWVudCBpZD0nc2hpbnknIHgxPScwJTI1JyB5MT0nMCUyNScgeDI9JzAlMjUnIHkyPScxMDAlMjUnJTNFJTNDc3RvcCBvZmZzZXQ9JzAlMjUnIHN0eWxlPSdzdG9wLWNvbG9yOiUyMzZiNzI4MCclMkYlM0UlM0NzdG9wIG9mZnNldD0nMTAlMjUnIHN0eWxlPSdzdG9wLWNvbG9yOiUyMzM3NDE1MSclMkYlM0UlM0NzdG9wIG9mZnNldD0nOTAlMjUnIHN0eWxlPSdzdG9wLWNvbG9yOiUyMzExMTgyNyclMkYlM0UlM0NzdG9wIG9mZnNldD0nMTAwJTI1JyBzdHlsZT0nc3RvcC1jb2xvcjolMjMxZjI5MzcnJTJGJTNFJTNDJTJGbGluZWFyR3JhZGllbnQlM0UlM0NsaW5lYXJHcmFkaWVudCBpZD0nc2hpbnlUb3AnIHgxPScwJTI1JyB5MT0nMCUyNScgeDI9JzEwMCUyNScgeTI9JzAlMjUnJTNFJTNDc3RvcCBvZmZzZXQ9JzAlMjUnIHN0eWxlPSdzdG9wLWNvbG9yOndoaXRlO3N0b3Atb3BhY2l0eTowJyUyRiUzRSUzQ3N0b3Agb2Zmc2V0PSc1MCUyNScgc3R5bGU9J3N0b3AtY29sb3I6d2hpdGU7c3RvcC1vcGFjaXR5OjAuNSclMkYlM0UlM0NzdG9wIG9mZnNldD0nMTAwJTI1JyBzdHlsZT0nc3RvcC1jb2xvcjp3aGl0ZTtzdG9wLW9wYWNpdHk6MCclMkYlM0UlM0MlMkZsaW5lYXJHcmFkaWVudCUzRSUzQyUyRmRlZnMlM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyByeD0nMjInIGZpbGw9J3VybCglMjNzaGlueSknJTJGJTNFJTNDcmVjdCB4PScxMCcgeT0nOCcgd2lkdGg9JzgwJyBoZWlnaHQ9JzMnIHJ4PScxLjUnIGZpbGw9J3VybCglMjNzaGlueVRvcCknJTJGJTNFJTNDdGV4dCB4PSc1MCcgeT0nNzInIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZvbnQtc2l6ZT0nNjUnIGZvbnQtd2VpZ2h0PSc5MDAnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nc2Fucy1zZXJpZiclM0UlRTMlODMlQTIlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">
  
  <!-- ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ã€Œãƒ¢ã€ã‚¢ã‚¤ã‚³ãƒ³ -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='shiny' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236b7280'/%3E%3Cstop offset='10%25' style='stop-color:%23374151'/%3E%3Cstop offset='90%25' style='stop-color:%23111827'/%3E%3Cstop offset='100%25' style='stop-color:%231f2937'/%3E%3C/linearGradient%3E%3ClinearGradient id='shinyTop' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:white;stop-opacity:0'/%3E%3Cstop offset='50%25' style='stop-color:white;stop-opacity:0.5'/%3E%3Cstop offset='100%25' style='stop-color:white;stop-opacity:0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23shiny)'/%3E%3Crect x='10' y='8' width='80' height='3' rx='1.5' fill='url(%23shinyTop)'/%3E%3Ctext x='50' y='72' text-anchor='middle' font-size='65' font-weight='900' fill='white' font-family='sans-serif'%3E%E3%83%A2%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='shiny' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236b7280'/%3E%3Cstop offset='10%25' style='stop-color:%23374151'/%3E%3Cstop offset='90%25' style='stop-color:%23111827'/%3E%3Cstop offset='100%25' style='stop-color:%231f2937'/%3E%3C/linearGradient%3E%3ClinearGradient id='shinyTop' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:white;stop-opacity:0'/%3E%3Cstop offset='50%25' style='stop-color:white;stop-opacity:0.5'/%3E%3Cstop offset='100%25' style='stop-color:white;stop-opacity:0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23shiny)'/%3E%3Crect x='10' y='8' width='80' height='3' rx='1.5' fill='url(%23shinyTop)'/%3E%3Ctext x='50' y='72' text-anchor='middle' font-size='65' font-weight='900' fill='white' font-family='sans-serif'%3E%E3%83%A2%3C/text%3E%3C/svg%3E">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    /* iOS Safari ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®ãƒã‚¦ãƒ³ã‚¹ã‚’é˜²ã */
    html, body { overscroll-behavior: none; }
    /* ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³æ™‚ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œ */
    @supports (padding-top: env(safe-area-inset-top)) {
      body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    // ================================
    // Supabaseè¨­å®š
    // ================================
    const SUPABASE_URL = 'https://ivirmauzgzrxxljbadve.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2aXJtYXV6Z3pyeHhsamJhZHZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTE3OTksImV4cCI6MjA4NTE2Nzc5OX0.fRKkUnw4nTDjxDpJS_ZT-TZZbz9FM9_Bx0vR5R7GB3w';

    // Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    window.storage = {
      dbId: null,
      
      async get(key) {
        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/moai_groups?select=*&limit=1`, {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          });
          const data = await res.json();
          if (data && data.length > 0) {
            this.dbId = data[0].id;
            return { value: JSON.stringify({ groups: [data[0].data] }) };
          }
          return null;
        } catch (e) {
          console.error('Supabase GET error:', e);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        }
      },
      
      async set(key, value) {
        try {
          const parsed = JSON.parse(value);
          const groupData = parsed.groups[0];
          
          if (this.dbId) {
            // æ›´æ–°
            await fetch(`${SUPABASE_URL}/rest/v1/moai_groups?id=eq.${this.dbId}`, {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
              },
              body: JSON.stringify({ data: groupData })
            });
          } else {
            // æ–°è¦ä½œæˆ
            const res = await fetch(`${SUPABASE_URL}/rest/v1/moai_groups`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
              },
              body: JSON.stringify({ data: groupData })
            });
            const data = await res.json();
            if (data && data[0]) this.dbId = data[0].id;
          }
          // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          localStorage.setItem(key, value);
          return { key, value };
        } catch (e) {
          console.error('Supabase SET error:', e);
          localStorage.setItem(key, value);
          return { key, value };
        }
      },
      
      async delete(key) {
        localStorage.removeItem(key);
        return { key, deleted: true };
      }
    };
  </script>
  <script type="text/babel">


function MoaiManager() {
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸç”»é¢ã‚’å–å¾—
  const getInitialView = () => {
    const params = new URLSearchParams(window.location.search);
    const view = params.get('view');
    const validViews = ['dashboard', 'party', 'events', 'members', 'bulk', 'receive', 'table', 'history', 'help'];
    return validViews.includes(view) ? view : 'dashboard';
  };
  
  const [currentView, setCurrentView] = React.useState(getInitialView());
  const [isAdmin, setIsAdmin] = React.useState(false);
  const [showLoginModal, setShowLoginModal] = React.useState(false);
  const [groups, setGroups] = React.useState([]);
  const [selectedGroup, setSelectedGroup] = React.useState(null);
  const [showModal, setShowModal] = React.useState(null);
  const [editingMember, setEditingMember] = React.useState(null);
  const [editingEvent, setEditingEvent] = React.useState(null);
  const [notification, setNotification] = React.useState(null);
  const [selectedMonth, setSelectedMonth] = React.useState(new Date().toISOString().slice(0, 7));
  const [lastPaidInfo, setLastPaidInfo] = React.useState(null); // å…¥é‡‘ãŠç¤¼ç”¨
  const [lastConfirmedParty, setLastConfirmedParty] = React.useState(null); // é£²ã¿ä¼šç¢ºå®šé€šçŸ¥ç”¨
  const [lastConfirmedEvent, setLastConfirmedEvent] = React.useState(null); // ã‚¤ãƒ™ãƒ³ãƒˆç¢ºå®šé€šçŸ¥ç”¨
  const [lastReceiveInfo, setLastReceiveInfo] = React.useState(null); // å—å–é€šçŸ¥ç”¨

  // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
  const createPresetData = () => ({
    id: 'preset-moai-1',
    name: 'æ¨¡åˆã‚°ãƒ«ãƒ¼ãƒ—',
    adminPassword: '1234', // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    monthlyAmount: 10000,
    savingsAmount: 2000,
    startMonth: '2026-03',
    endMonth: '2027-05',
    bankInfo: 'ã‚†ã†ã¡ã‚‡éŠ€è¡Œ 0520405',
    lineGroupUrl: '',
    partySchedule: { type: 'none', dayOfWeek: 6, weekOfMonth: 4 }, // å®šæœŸé–‹å‚¬è¨­å®š
    createdAt: new Date().toISOString(),
    currentBalance: 1598749,
    members: [
      { id: 'p1', name: 'ãƒ‡ã‚¹ãƒˆãƒ­ã‚¤ãƒ¤ãƒ¼', phone: '', carryOver: 1270658, memo: '' },
      { id: 'p2', name: 'ä¸‹åœ° æ•¦', phone: '', carryOver: 0, memo: '' },
      { id: 'p3', name: 'å·ä¸Š é”ä¹Ÿ', phone: '', carryOver: 0, memo: '' },
      { id: 'p4', name: 'è¥¿ å‹æ²»', phone: '', carryOver: 0, memo: '' },
      { id: 'p5', name: 'æ–‡å¹³ å¤ªä¸€æœ—', phone: '', carryOver: 0, memo: '' },
      { id: 'p6', name: 'å®®å¹³ æ•¬æ¬¡', phone: '', carryOver: 0, memo: '' },
      { id: 'p7', name: 'ä¸­è¥¿ åœ­', phone: '', carryOver: 0, memo: '' },
      { id: 'p8', name: 'å¤šå˜‰å±± å‹²', phone: '', carryOver: 0, memo: '' },
      { id: 'p9', name: 'çœŸç‰æ©‹ è£•ä¹Ÿ', phone: '', carryOver: 0, memo: '' },
      { id: 'p10', name: 'å²¡éƒ¨ æ”¿å—£', phone: '', carryOver: 0, memo: '' },
      { id: 'p11', name: 'å®®åŸ åŠŸå¤ª', phone: '', carryOver: 0, memo: '' },
      { id: 'p12', name: 'ç¥åŸ å²èª ', phone: '', carryOver: 0, memo: '' },
      { id: 'p13', name: 'ä¸­æ ¹æ¬¡ å²', phone: '', carryOver: 0, memo: '' },
      { id: 'p14', name: 'é‡‘åŸ æ´²æ–—', phone: '', carryOver: 0, memo: '' },
      { id: 'p15', name: 'ãƒ¤ã‚¹ãƒ’ ãƒ’ãƒ©ã‚¿', phone: '', carryOver: 0, memo: '' },
    ],
    payments: [],
    receives: [],
    receiveRequests: [],
    balanceHistory: [],
    savingsUsage: [],
    events: [],
    pastVenues: [], // éå»ã®åº—èˆ—å±¥æ­´
    auditLog: []
  });

  React.useEffect(() => {
    const loadData = async () => {
      try {
        const saved = await window.storage.get('moai-groups-v7');
        if (saved?.value) {
          const data = JSON.parse(saved.value);
          // è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
          const today = new Date().toISOString().slice(0, 10);
          const updatedGroups = data.groups.map(group => {
            const updatedEvents = (group.events || []).map(event => {
              // é–‹å‚¬æ—¥ã‚’éããŸé£²ã¿ä¼šã‚’è‡ªå‹•ã§å®Œäº†ã«ã™ã‚‹
              if (event.status !== 'completed' && event.date && event.date < today) {
                return { ...event, status: 'completed', autoArchived: true };
              }
              return event;
            });
            return { ...group, events: updatedEvents };
          });
          setGroups(updatedGroups || []);
          if (updatedGroups?.length > 0) setSelectedGroup(updatedGroups[0]);
        } else {
          const preset = createPresetData();
          setGroups([preset]);
          setSelectedGroup(preset);
        }
      } catch (e) {
        const preset = createPresetData();
        setGroups([preset]);
        setSelectedGroup(preset);
      }
    };
    loadData();
  }, []);

  React.useEffect(() => {
    if (groups.length > 0) window.storage.set('moai-groups-v7', JSON.stringify({ groups }));
  }, [groups]);

  const notify = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const updateGroup = (updated) => {
    const newGroups = groups.map(g => g.id === updated.id ? updated : g);
    setGroups(newGroups);
    setSelectedGroup(updated);
  };

  const addLog = (action, details, group) => ({
    ...group,
    auditLog: [...(group.auditLog || []), { id: `log-${Date.now()}`, action, details, timestamp: new Date().toISOString() }]
  });

  // ===== ç®¡ç†è€…èªè¨¼ =====
  const handleLogin = (password) => {
    if (password === selectedGroup?.adminPassword) {
      setIsAdmin(true);
      setShowLoginModal(false);
      notify('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    } else {
      notify('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 'error');
    }
  };

  const handleLogout = () => {
    setIsAdmin(false);
    notify('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
  };

  const handleChangePassword = (newPassword) => {
    let updated = { ...selectedGroup, adminPassword: newPassword };
    updated = addLog('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´', 'ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´', updated);
    updateGroup(updated);
    notify('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // ===== è¨ˆç®—é–¢æ•° =====
  const getMonthList = () => {
    if (!selectedGroup?.startMonth || !selectedGroup?.endMonth) return [];
    const months = [];
    let current = new Date(selectedGroup.startMonth + '-01');
    const end = new Date(selectedGroup.endMonth + '-01');
    while (current <= end) {
      months.push(current.toISOString().slice(0, 7));
      current.setMonth(current.getMonth() + 1);
    }
    return months;
  };

  const getActivePayments = () => selectedGroup?.payments?.filter(p => p.status !== 'deleted') || [];
  const getActiveReceives = () => selectedGroup?.receives?.filter(r => r.status !== 'deleted') || [];

  const getMemberBalance = (memberId) => {
    if (!selectedGroup) return { balance: 0, unpaidMonths: [] };
    const member = selectedGroup.members.find(m => m.id === memberId);
    const carryOver = member?.carryOver || 0;
    const monthList = getMonthList();
    const currentMonth = new Date().toISOString().slice(0, 7);
    const dueMonths = monthList.filter(m => m <= currentMonth);
    const payments = getActivePayments().filter(p => p.memberId === memberId);
    const paidMonths = payments.map(p => p.month);
    const receiveMonths = getActiveReceives().filter(r => r.winnerId === memberId).map(r => r.month);
    const allPaidMonths = [...new Set([...paidMonths, ...receiveMonths])];
    const unpaidMonths = dueMonths.filter(m => !allPaidMonths.includes(m));
    const totalDue = dueMonths.length * (selectedGroup.monthlyAmount + selectedGroup.savingsAmount);
    const totalPaid = payments.reduce((sum, p) => sum + p.amount + p.savings, 0) + carryOver;
    return { balance: totalPaid - totalDue, unpaidMonths, paidCount: payments.length };
  };

  const getMonthlyStatus = (month) => {
    if (!selectedGroup) return { paid: [], unpaid: [], total: 0 };
    const payments = getActivePayments().filter(p => p.month === month);
    const paidIds = payments.map(p => p.memberId);
    const receiveWinners = getActiveReceives().filter(r => r.month === month).map(r => r.winnerId);
    const allPaidIds = [...new Set([...paidIds, ...receiveWinners])];
    return {
      paid: selectedGroup.members.filter(m => allPaidIds.includes(m.id)),
      unpaid: selectedGroup.members.filter(m => !allPaidIds.includes(m.id)),
      total: payments.reduce((sum, p) => sum + p.amount + p.savings, 0)
    };
  };

  const getTotalSavings = () => {
    const collected = getActivePayments().reduce((sum, p) => sum + (p.savings || 0), 0);
    const used = (selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').reduce((sum, u) => sum + u.amount, 0);
    return collected - used;
  };

  const getTotalUnpaid = () => {
    if (!selectedGroup) return 0;
    return selectedGroup.members.reduce((sum, m) => {
      const bal = getMemberBalance(m.id);
      return sum + (bal.balance < 0 ? Math.abs(bal.balance) : 0);
    }, 0);
  };

  const getMembersNotReceived = () => {
    const receivedIds = getActiveReceives().map(r => r.winnerId);
    return selectedGroup?.members?.filter(m => !receivedIds.includes(m.id)) || [];
  };

  const calculateReceiveAmount = (memberId) => {
    const baseAmount = selectedGroup.monthlyAmount * selectedGroup.members.length;
    const bal = getMemberBalance(memberId);
    const offsetAmount = bal.balance < 0 ? Math.abs(bal.balance) : 0;
    return { baseAmount, offsetAmount, finalAmount: baseAmount - offsetAmount };
  };

  // æ¨¡åˆã®é€²æ—æƒ…å ±
  const getProgressInfo = () => {
    const monthList = getMonthList();
    const currentMonth = new Date().toISOString().slice(0, 7);
    const passedMonths = monthList.filter(m => m <= currentMonth).length;
    const totalMonths = monthList.length;
    const receiveCount = getActiveReceives().length;
    const remainingReceives = selectedGroup?.members?.length - receiveCount;
    return {
      currentRound: passedMonths,
      totalRounds: totalMonths,
      progressPercent: totalMonths > 0 ? Math.round((passedMonths / totalMonths) * 100) : 0,
      receiveCount,
      remainingReceives: Math.max(0, remainingReceives)
    };
  };

  // æ»ç´è€…ãƒªã‚¹ãƒˆï¼ˆä½•ãƒ¶æœˆæ»ç´ã—ã¦ã„ã‚‹ã‹ï¼‰
  const getDelinquentMembers = () => {
    if (!selectedGroup) return [];
    return selectedGroup.members
      .map(m => {
        const bal = getMemberBalance(m.id);
        return {
          ...m,
          unpaidMonths: bal.unpaidMonths.length,
          unpaidAmount: bal.balance < 0 ? Math.abs(bal.balance) : 0,
          unpaidMonthsList: bal.unpaidMonths
        };
      })
      .filter(m => m.unpaidMonths > 0)
      .sort((a, b) => b.unpaidMonths - a.unpaidMonths);
  };

  // é †ç•ªåˆ¶ã®æ¬¡ã®å—å–è€…ï¼ˆãƒ¡ãƒ³ãƒãƒ¼é †ï¼‰
  const getNextReceiver = () => {
    const notReceived = getMembersNotReceived();
    if (notReceived.length === 0) return null;
    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®é †ç•ªã§æœ€åˆã®æœªå—å–è€…
    return selectedGroup.members.find(m => notReceived.some(nr => nr.id === m.id));
  };

  // å—å–é †ãƒªã‚¹ãƒˆ
  const getReceiveOrder = () => {
    const receives = getActiveReceives();
    const receivedIds = receives.map(r => r.winnerId);
    const received = receives.map((r, i) => {
      const member = selectedGroup?.members?.find(m => m.id === r.winnerId);
      return { order: i + 1, member, month: r.month, amount: r.amount, status: 'done' };
    });
    const notReceived = selectedGroup?.members?.filter(m => !receivedIds.includes(m.id)).map((m, i) => ({
      order: receives.length + i + 1,
      member: m,
      month: null,
      amount: null,
      status: 'pending'
    })) || [];
    return [...received, ...notReceived];
  };

  // ã‚¹ãƒˆãƒƒã‚¯é‡‘ï¼ˆãƒ—ãƒ¼ãƒ«é‡‘ï¼‰ã®è¨ˆç®—
  const getPoolInfo = () => {
    if (!selectedGroup) return { poolAmount: 0, availableCount: 0 };
    
    const monthList = getMonthList();
    const currentMonth = new Date().toISOString().slice(0, 7);
    const passedMonths = monthList.filter(m => m <= currentMonth);
    
    // çµŒéæœˆæ•°åˆ†ã®å—å–ãŒã‚ã‚‹ã¹ã
    const expectedReceives = passedMonths.length;
    // å®Ÿéš›ã®å—å–å›æ•°
    const actualReceives = getActiveReceives().length;
    // æœªæ¶ˆåŒ–ã®å—å–å›æ•°ï¼ˆã‚¹ãƒˆãƒƒã‚¯ï¼‰
    const pooledCount = expectedReceives - actualReceives;
    
    // 1å›ã‚ãŸã‚Šã®å—å–é¡ï¼ˆæœ¬ä½“é‡‘é¡ Ã— ãƒ¡ãƒ³ãƒãƒ¼æ•°ï¼‰
    const receivePerTime = selectedGroup.monthlyAmount * selectedGroup.members.length;
    // ã‚¹ãƒˆãƒƒã‚¯é‡‘é¡
    const poolAmount = pooledCount * receivePerTime;
    
    return {
      poolAmount: Math.max(0, poolAmount),
      availableCount: Math.max(0, pooledCount),
      receivePerTime
    };
  };

  const getMemberPaymentForMonth = (memberId, month) => {
    const payment = getActivePayments().find(p => p.memberId === memberId && p.month === month);
    if (payment) return { status: 'paid', date: payment.recordedAt?.slice(5, 10).replace('-', '/') };
    const receive = getActiveReceives().find(r => r.month === month && r.winnerId === memberId);
    if (receive) return { status: 'offset' };
    return { status: 'unpaid' };
  };

  // æ¬¡å›é–‹å‚¬æ—¥ã®è‡ªå‹•ææ¡ˆ
  const getNextPartyDate = () => {
    const schedule = selectedGroup?.partySchedule;
    if (!schedule || schedule.type === 'none') return null;
    
    const now = new Date();
    let year = now.getFullYear();
    let month = now.getMonth();
    
    // æ¬¡ã®æœˆã‹ã‚‰æ¢ã™
    for (let i = 0; i < 3; i++) {
      month++;
      if (month > 11) { month = 0; year++; }
      
      // ç¬¬Né€±ã®Xæ›œæ—¥ã‚’è¨ˆç®—
      const firstDay = new Date(year, month, 1);
      const dayOfWeek = schedule.dayOfWeek; // 0=æ—¥, 6=åœŸ
      const weekOfMonth = schedule.weekOfMonth; // 1-4, -1=æœ€çµ‚
      
      let targetDate;
      if (weekOfMonth === -1) {
        // æœ€çµ‚é€±
        const lastDay = new Date(year, month + 1, 0);
        let d = lastDay.getDate();
        while (new Date(year, month, d).getDay() !== dayOfWeek) d--;
        targetDate = new Date(year, month, d);
      } else {
        // ç¬¬Né€±
        let count = 0;
        for (let d = 1; d <= 31; d++) {
          const date = new Date(year, month, d);
          if (date.getMonth() !== month) break;
          if (date.getDay() === dayOfWeek) {
            count++;
            if (count === weekOfMonth) {
              targetDate = date;
              break;
            }
          }
        }
      }
      
      if (targetDate && targetDate > now) {
        return targetDate.toISOString().slice(0, 10);
      }
    }
    return null;
  };

  // é£²ã¿ä¼šå‚åŠ ç‡ã‚’è¨ˆç®—
  const getMemberParticipationStats = () => {
    const events = selectedGroup?.events || [];
    const completedEvents = events.filter(e => e.status === 'completed' || e.status === 'confirmed');
    
    if (completedEvents.length === 0) return [];
    
    return selectedGroup.members.map(member => {
      let attended = 0;
      completedEvents.forEach(event => {
        const attendance = event.attendance || {};
        if (attendance[member.id] === 'yes') attended++;
      });
      
      const rate = Math.round((attended / completedEvents.length) * 100);
      const isPerfect = attended === completedEvents.length && completedEvents.length > 0;
      
      return {
        id: member.id,
        name: member.name,
        attended,
        total: completedEvents.length,
        rate,
        isPerfect
      };
    }).sort((a, b) => b.rate - a.rate);
  };

  // æŠ½é¸æ©Ÿèƒ½ï¼ˆå—å–å¸Œæœ›è€…å„ªå…ˆã€å—å–æ¸ˆã¿é™¤å¤–ï¼‰
  const handleLottery = () => {
    const notReceived = getMembersNotReceived();
    if (notReceived.length === 0) {
      notify('å…¨å“¡å—å–æ¸ˆã¿ã§ã™', 'error');
      return null;
    }
    
    // å—å–å¸Œæœ›ã‚’å‡ºã—ã¦ã„ã‚‹æœªå—å–è€…ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const requests = selectedGroup.receiveRequests || [];
    const requestMemberIds = requests.map(r => r.memberId);
    const notReceivedWithRequest = notReceived.filter(m => requestMemberIds.includes(m.id));
    
    let winner;
    if (notReceivedWithRequest.length > 0) {
      // å—å–å¸Œæœ›è€…ãŒã„ã‚Œã°ã€ãã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸
      winner = notReceivedWithRequest[Math.floor(Math.random() * notReceivedWithRequest.length)];
      notify(`ğŸ² æŠ½é¸çµæœ: ${winner.name}ã•ã‚“ï¼ï¼ˆå—å–å¸Œæœ›è€…ã‹ã‚‰ï¼‰`);
    } else {
      // å—å–å¸Œæœ›è€…ãŒã„ãªã‘ã‚Œã°ã€æœªå—å–è€…å…¨å“¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸
      winner = notReceived[Math.floor(Math.random() * notReceived.length)];
      notify(`ğŸ² æŠ½é¸çµæœ: ${winner.name}ã•ã‚“ï¼`);
    }
    
    return winner;
  };

  // ===== ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ =====
  const handleBulkPayment = (memberIds, month) => {
    let updated = { ...selectedGroup };
    memberIds.forEach((memberId, idx) => {
      updated.payments = [...updated.payments, {
        id: `pay-${Date.now()}-${idx}`, memberId, month,
        amount: selectedGroup.monthlyAmount, savings: selectedGroup.savingsAmount,
        status: 'active', recordedAt: new Date().toISOString()
      }];
    });
    updated = addLog('ä¸€æ‹¬å…¥é‡‘', `${month}: ${memberIds.length}å`, updated);
    updateGroup(updated);
    notify(`${memberIds.length}åã®å…¥é‡‘ã‚’è¨˜éŒ²`);
    
    // ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã«æƒ…å ±ã‚’ä¿å­˜
    const paidMembers = selectedGroup.members.filter(m => memberIds.includes(m.id));
    setLastPaidInfo({ members: paidMembers, month });
    setShowModal('paymentThanks');
  };

  const handlePayment = (data) => {
    let updated = { ...selectedGroup, payments: [...selectedGroup.payments, { id: `pay-${Date.now()}`, ...data, status: 'active', recordedAt: new Date().toISOString() }] };
    updated = addLog('å…¥é‡‘', `${data.month}`, updated);
    updateGroup(updated);
    notify('å…¥é‡‘ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    
    // ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã«æƒ…å ±ã‚’ä¿å­˜
    const paidMember = selectedGroup.members.find(m => m.id === data.memberId);
    if (paidMember) {
      setLastPaidInfo({ members: [paidMember], month: data.month });
      setShowModal('paymentThanks');
    } else {
      setShowModal(null);
    }
  };

  const handleReceive = (data) => {
    // ç›¸æ®ºæƒ…å ±ã‚’è¨ˆç®—ï¼ˆå—å–å‰ã«è¨ˆç®—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
    const calc = calculateReceiveAmount(data.winnerId);
    
    let updated = { ...selectedGroup, receives: [...selectedGroup.receives, { id: `rec-${Date.now()}`, ...data, status: 'active', recordedAt: new Date().toISOString() }] };
    // å—å–å¸Œæœ›ãŒã‚ã‚Œã°å‰Šé™¤
    updated.receiveRequests = (updated.receiveRequests || []).filter(r => r.memberId !== data.winnerId);
    updated = addLog('å—å–', `Â¥${data.amount.toLocaleString()}`, updated);
    updateGroup(updated);
    notify('å—å–ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    
    // å—å–é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆç›¸æ®ºæƒ…å ±ã‚‚å«ã‚€ï¼‰
    const winner = selectedGroup.members.find(m => m.id === data.winnerId);
    if (winner) {
      setLastReceiveInfo({ 
        member: winner, 
        amount: data.amount, 
        month: data.month,
        baseAmount: calc.baseAmount,
        offsetAmount: calc.offsetAmount,
        finalAmount: calc.finalAmount
      });
      setShowModal('receiveNotify');
    } else {
      setShowModal(null);
    }
  };

  // å…¥é‡‘å–æ¶ˆï¼ˆè«–ç†å‰Šé™¤ï¼‰
  const handleCancelPayment = (paymentId) => {
    if (!confirm('ã“ã®å…¥é‡‘ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå±¥æ­´ã«ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
    const payment = selectedGroup.payments.find(p => p.id === paymentId);
    const member = selectedGroup.members.find(m => m.id === payment?.memberId);
    let updated = {
      ...selectedGroup,
      payments: selectedGroup.payments.map(p => p.id === paymentId ? { ...p, status: 'deleted', deletedAt: new Date().toISOString() } : p)
    };
    updated = addLog('å…¥é‡‘å–æ¶ˆ', `${payment?.month} ${member?.name}`, updated);
    updateGroup(updated);
    notify('å…¥é‡‘ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  };

  // å—å–å–æ¶ˆï¼ˆè«–ç†å‰Šé™¤ï¼‰
  const handleCancelReceive = (receiveId) => {
    if (!confirm('ã“ã®å—å–ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå±¥æ­´ã«ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
    const receive = selectedGroup.receives.find(r => r.id === receiveId);
    const member = selectedGroup.members.find(m => m.id === receive?.winnerId);
    let updated = {
      ...selectedGroup,
      receives: selectedGroup.receives.map(r => r.id === receiveId ? { ...r, status: 'deleted', deletedAt: new Date().toISOString() } : r)
    };
    updated = addLog('å—å–å–æ¶ˆ', `${receive?.month} ${member?.name}`, updated);
    updateGroup(updated);
    notify('å—å–ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  };

  const handleReceiveRequest = (data) => {
    // æ—¢ã«å¸Œæœ›ã‚’å‡ºã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    const existing = (selectedGroup.receiveRequests || []).find(r => r.memberId === data.memberId);
    if (existing) {
      notify('ã“ã®äººã¯æ—¢ã«å—å–å¸Œæœ›ã‚’ç™»éŒ²æ¸ˆã¿ã§ã™', 'error');
      return;
    }
    const member = selectedGroup.members.find(m => m.id === data.memberId);
    let updated = { ...selectedGroup, receiveRequests: [...(selectedGroup.receiveRequests || []), { id: `req-${Date.now()}`, ...data, createdAt: new Date().toISOString() }] };
    updated = addLog('å—å–å¸Œæœ›', member?.name, updated);
    updateGroup(updated);
    notify('å—å–å¸Œæœ›ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleAddMember = (data) => {
    let updated = { ...selectedGroup, members: [...selectedGroup.members, { id: `mem-${Date.now()}`, ...data, carryOver: (data.carryOver || 0) * 1000 }] };
    updated = addLog('ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ', data.name, updated);
    updateGroup(updated);
    notify('è¿½åŠ ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleEditMember = (data) => {
    let updated = { ...selectedGroup, members: selectedGroup.members.map(m => m.id === editingMember.id ? { ...m, ...data, carryOver: (data.carryOver || 0) * 1000 } : m) };
    updated = addLog('ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†', data.name, updated);
    updateGroup(updated);
    setEditingMember(null);
    notify('æ›´æ–°ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleDeleteMember = (id) => {
    if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const member = selectedGroup.members.find(m => m.id === id);
    let updated = { ...selectedGroup, members: selectedGroup.members.filter(m => m.id !== id) };
    updated = addLog('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤', member?.name, updated);
    updateGroup(updated);
    notify('å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  const handleUpdateGroup = (data) => {
    let updated = { ...selectedGroup, ...data };
    updated = addLog('è¨­å®šå¤‰æ›´', '', updated);
    updateGroup(updated);
    notify('æ›´æ–°ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleBalanceRecord = (data) => {
    let updated = { ...selectedGroup, balanceHistory: [...(selectedGroup.balanceHistory || []), { id: `bal-${Date.now()}`, ...data }], currentBalance: data.balance };
    updated = addLog('æ®‹é«˜è¨˜éŒ²', `Â¥${data.balance.toLocaleString()}`, updated);
    updateGroup(updated);
    notify('æ®‹é«˜ã‚’è¨˜éŒ²');
    setShowModal(null);
  };

  // ç©ç«‹é‡‘ä½¿ç”¨
  const handleUseSavings = (data) => {
    let updated = {
      ...selectedGroup,
      savingsUsage: [...(selectedGroup.savingsUsage || []), { id: `sav-${Date.now()}`, ...data, status: 'active', recordedAt: new Date().toISOString() }]
    };
    updated = addLog('ç©ç«‹é‡‘ä½¿ç”¨', `${data.purpose}: Â¥${data.amount.toLocaleString()}`, updated);
    updateGroup(updated);
    notify('ç©ç«‹é‡‘ä½¿ç”¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // ç©ç«‹é‡‘ä½¿ç”¨å–æ¶ˆ
  const handleCancelSavingsUsage = (usageId) => {
    if (!confirm('ã“ã®ç©ç«‹é‡‘ä½¿ç”¨ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    const usage = (selectedGroup.savingsUsage || []).find(u => u.id === usageId);
    let updated = {
      ...selectedGroup,
      savingsUsage: (selectedGroup.savingsUsage || []).map(u => u.id === usageId ? { ...u, status: 'deleted', deletedAt: new Date().toISOString() } : u)
    };
    updated = addLog('ç©ç«‹é‡‘ä½¿ç”¨å–æ¶ˆ', usage?.purpose, updated);
    updateGroup(updated);
    notify('å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
  };

  // ===== é£²ã¿ä¼šé–¢é€£ =====
  const handleCreateEvent = (data) => {
    const newEvent = {
      id: `evt-${Date.now()}`, ...data,
      venues: [], attendance: {}, venueVotes: {},
      status: 'voting', confirmedVenue: null,
      deadline: data.deadline || null,
      expense: null, photos: [],
      createdAt: new Date().toISOString()
    };
    let updated = { ...selectedGroup, events: [...(selectedGroup.events || []), newEvent] };
    updated = addLog('é£²ã¿ä¼šä½œæˆ', data.date, updated);
    updateGroup(updated);
    notify('é£²ã¿ä¼šã‚’ä½œæˆã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  const handleAddVenue = (eventId, venue) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venues: [...e.venues, { id: `ven-${Date.now()}`, ...venue }] } : e)
    };
    
    // éå»åº—èˆ—ã«ã‚‚è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
    if (venue.name) {
      const existsInPast = (updated.pastVenues || []).some(v => v.name === venue.name);
      if (!existsInPast) {
        updated.pastVenues = [...(updated.pastVenues || []), { 
          id: `pv-${Date.now()}`, 
          name: venue.name, 
          address: venue.address || '', 
          url: venue.url || '', 
          budget: venue.budget || '',
          usedCount: 0, 
          createdAt: new Date().toISOString() 
        }];
      }
    }
    
    updateGroup(updated);
    notify('åº—èˆ—ã‚’è¿½åŠ ');
  };

  const handleAddVenueFromPast = (eventId, pastVenue) => {
    // éå»åº—èˆ—ã‹ã‚‰è¿½åŠ ã™ã‚‹å ´åˆã¯ã€pastVenuesã¸ã®é‡è¤‡ç™»éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venues: [...e.venues, { id: `ven-${Date.now()}`, name: pastVenue.name, address: pastVenue.address, url: pastVenue.url, budget: pastVenue.budget }] } : e)
    };
    updateGroup(updated);
    notify('åº—èˆ—ã‚’è¿½åŠ ');
  };

  const handleDeletePastVenue = (venueId) => {
    if (!confirm('ã“ã®åº—èˆ—ã‚’å€™è£œãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    let updated = {
      ...selectedGroup,
      pastVenues: (selectedGroup.pastVenues || []).filter(v => v.id !== venueId)
    };
    updateGroup(updated);
    notify('åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  const handleDeleteVenue = (eventId, venueId) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venues: e.venues.filter(v => v.id !== venueId) } : e)
    };
    updateGroup(updated);
  };

  const handleAttendanceVote = (eventId, memberId, vote) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, attendance: { ...e.attendance, [memberId]: vote } } : e)
    };
    updateGroup(updated);
  };

  const handleVenueVote = (eventId, memberId, venueId) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, venueVotes: { ...e.venueVotes, [memberId]: venueId } } : e)
    };
    updateGroup(updated);
  };

  const handleConfirmEvent = (eventId, venueId) => {
    const event = selectedGroup.events.find(e => e.id === eventId);
    const venue = event?.venues.find(v => v.id === venueId);
    
    let updated = { ...selectedGroup };
    
    // éå»åº—èˆ—ã®ä½¿ç”¨å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹ã¯ãšï¼‰
    if (venue) {
      const existsInPast = (updated.pastVenues || []).some(v => v.name === venue.name);
      if (existsInPast) {
        updated.pastVenues = (updated.pastVenues || []).map(v => 
          v.name === venue.name ? { ...v, usedCount: (v.usedCount || 0) + 1, lastUsed: new Date().toISOString() } : v
        );
      } else {
        // ä¸‡ãŒä¸€ãªã‘ã‚Œã°è¿½åŠ ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        updated.pastVenues = [...(updated.pastVenues || []), { 
          id: `pv-${Date.now()}`, 
          name: venue.name, 
          address: venue.address, 
          url: venue.url, 
          budget: venue.budget, 
          usedCount: 1, 
          lastUsed: new Date().toISOString() 
        }];
      }
    }
    
    updated.events = updated.events.map(e => e.id === eventId ? { ...e, status: 'confirmed', confirmedVenue: venueId } : e);
    updated = addLog('äºˆç´„ç¢ºå®š', venue?.name, updated);
    updateGroup(updated);
    notify('äºˆç´„ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
    
    // ç¢ºå®šé€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    setLastConfirmedParty({ event, venue });
    setShowModal('partyConfirmed');
  };

  const handleCompleteEvent = (eventId) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, status: 'completed' } : e)
    };
    updateGroup(updated);
    notify('é£²ã¿ä¼šã‚’å®Œäº†ã«ã—ã¾ã—ãŸ');
  };

  // é£²ã¿ä¼šç·¨é›†
  const handleEditEvent = (eventId, data) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, ...data } : e)
    };
    updated = addLog('é£²ã¿ä¼šç·¨é›†', data.date, updated);
    updateGroup(updated);
    notify('é£²ã¿ä¼šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    setShowModal(null);
    setEditingEvent(null);
  };

  // é£²ã¿ä¼šå‰Šé™¤
  const handleDeleteEvent = (eventId) => {
    if (!confirm('ã“ã®é£²ã¿ä¼šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const event = selectedGroup.events.find(e => e.id === eventId);
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.filter(e => e.id !== eventId)
    };
    updated = addLog('é£²ã¿ä¼šå‰Šé™¤', event?.date, updated);
    updateGroup(updated);
    notify('é£²ã¿ä¼šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  // é£²ã¿ä¼šä¼šè¨ˆè¨˜éŒ²
  const handleRecordExpense = (eventId, expense) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, expense } : e)
    };
    updateGroup(updated);
    notify('ä¼šè¨ˆã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
    setShowModal(null);
  };

  // å†™çœŸURLè¿½åŠ 
  const handleAddPhoto = (eventId, photoUrl) => {
    let updated = {
      ...selectedGroup,
      events: selectedGroup.events.map(e => e.id === eventId ? { ...e, photos: [...(e.photos || []), { id: `ph-${Date.now()}`, url: photoUrl, addedAt: new Date().toISOString() }] } : e)
    };
    updateGroup(updated);
    notify('å†™çœŸã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  };

  const getCurrentEvent = () => (selectedGroup?.events || []).find(e => e.status === 'voting' || e.status === 'confirmed');
  const getPastEvents = () => (selectedGroup?.events || []).filter(e => e.status === 'completed').slice(-10);

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—…è¡Œãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãªã©ï¼‰æ©Ÿèƒ½ =====
  const handleCreateSpecialEvent = (data) => {
    const newEvent = {
      id: `spe-${Date.now()}`,
      ...data,
      attendance: {},
      status: 'active',
      createdAt: new Date().toISOString()
    };
    let updated = { ...selectedGroup, specialEvents: [...(selectedGroup.specialEvents || []), newEvent] };
    updated = addLog('ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ', data.title, updated);
    updateGroup(updated);
    notify('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
  };

  const handleEditSpecialEvent = (eventId, data) => {
    let updated = {
      ...selectedGroup,
      specialEvents: (selectedGroup.specialEvents || []).map(e => e.id === eventId ? { 
        ...e, 
        ...data,
        status: e.status, // statusã¯å¤‰æ›´ã—ãªã„
        attendance: e.attendance // æŠ•ç¥¨çµæœã‚‚ä¿æŒ
      } : e)
    };
    updateGroup(updated);
    notify('ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  };

  const handleDeleteSpecialEvent = (eventId) => {
    if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    let updated = {
      ...selectedGroup,
      specialEvents: (selectedGroup.specialEvents || []).filter(e => e.id !== eventId)
    };
    updateGroup(updated);
    notify('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  };

  const handleSpecialEventVote = (eventId, memberId, vote) => {
    let updated = {
      ...selectedGroup,
      specialEvents: (selectedGroup.specialEvents || []).map(e => 
        e.id === eventId ? { ...e, attendance: { ...e.attendance, [memberId]: vote } } : e
      )
    };
    updateGroup(updated);
  };

  const handleCloseSpecialEvent = (eventId) => {
    const event = (selectedGroup.specialEvents || []).find(e => e.id === eventId);
    let updated = {
      ...selectedGroup,
      specialEvents: (selectedGroup.specialEvents || []).map(e => 
        e.id === eventId ? { ...e, status: 'closed' } : e
      )
    };
    updateGroup(updated);
    notify('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç· ã‚åˆ‡ã‚Šã¾ã—ãŸ');
    
    // ç¢ºå®šé€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    if (event) {
      setLastConfirmedEvent(event);
      setShowModal('eventConfirmed');
    }
  };

  const handleReopenSpecialEvent = (eventId) => {
    let updated = {
      ...selectedGroup,
      specialEvents: (selectedGroup.specialEvents || []).map(e => 
        e.id === eventId ? { ...e, status: 'active' } : e
      )
    };
    updateGroup(updated);
    notify('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†é–‹ã—ã¾ã—ãŸ');
  };

  if (!selectedGroup) return <div style={S.loading}>èª­ã¿è¾¼ã¿ä¸­...</div>;

  return (
    <div style={S.container}>
      <header style={S.header}>
        <div style={S.headerInner}>
          <div style={S.logo}>
            <svg width="36" height="36" viewBox="0 0 100 100" style={{marginRight: 8}}>
              <defs>
                <linearGradient id="shinyBg" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style={{stopColor:'#6b7280'}} />
                  <stop offset="10%" style={{stopColor:'#374151'}} />
                  <stop offset="90%" style={{stopColor:'#111827'}} />
                  <stop offset="100%" style={{stopColor:'#1f2937'}} />
                </linearGradient>
                <linearGradient id="shinyTop" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style={{stopColor:'white', stopOpacity:0}} />
                  <stop offset="50%" style={{stopColor:'white', stopOpacity:0.5}} />
                  <stop offset="100%" style={{stopColor:'white', stopOpacity:0}} />
                </linearGradient>
              </defs>
              <rect width="100" height="100" rx="22" fill="url(#shinyBg)"/>
              <rect x="10" y="8" width="80" height="3" rx="1.5" fill="url(#shinyTop)"/>
              <text x="50" y="72" textAnchor="middle" fontSize="65" fontWeight="900" fill="white" fontFamily="sans-serif">ãƒ¢</text>
            </svg>
            <span style={S.logoText}>æ¨¡åˆ</span>
          </div>
          {isAdmin ? (
            <button style={S.adminBadge} onClick={handleLogout}>ğŸ‘‘ç®¡ç†è€… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          ) : (
            <button style={S.loginBadge} onClick={() => setShowLoginModal(true)}>ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
          )}
        </div>
      </header>

      {notification && <div style={{...S.toast, backgroundColor: notification.type === 'success' ? '#10b981' : '#ef4444'}}>{notification.msg}</div>}

      <main style={S.main}>
        <div style={S.infoBadge}>
          {selectedGroup.name} | ğŸ’° Â¥{(selectedGroup.currentBalance || 0).toLocaleString()}
        </div>

        <nav style={S.nav}>
          {[
            { id: 'dashboard', icon: 'ğŸ ', label: 'ãƒ›ãƒ¼ãƒ ' },
            { id: 'party', icon: 'ğŸ»', label: 'é£²ã¿ä¼š' },
            { id: 'events', icon: 'ğŸª', label: 'ã‚¤ãƒ™ãƒ³ãƒˆ' },
            { id: 'members', icon: 'ğŸ‘¥', label: 'ãƒ¡ãƒ³ãƒãƒ¼' },
            { id: 'bulk', icon: 'âœ…', label: 'å…¥é‡‘' },
            { id: 'receive', icon: 'ğŸ¯', label: 'å—å–' },
            { id: 'table', icon: 'ğŸ“Š', label: 'ä¸€è¦§' },
            { id: 'history', icon: 'ğŸ“œ', label: 'å±¥æ­´' },
            { id: 'help', icon: 'â“', label: 'ãƒ˜ãƒ«ãƒ—' },
          ].map(t => (
            <button key={t.id} style={{...S.navBtn, ...(currentView === t.id ? S.navActive : {})}} onClick={() => setCurrentView(t.id)}>
              <span>{t.icon}</span><span style={S.navLabel}>{t.label}</span>
            </button>
          ))}
        </nav>

        {/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */}
        {currentView === 'dashboard' && (
          <div style={S.view}>
            {/* é€²æ—ãƒãƒ¼ */}
            {(() => {
              const progress = getProgressInfo();
              return (
                <div style={S.card}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                    <span style={{fontSize: 14, fontWeight: 600}}>ğŸ“ˆ æ¨¡åˆã®é€²æ—</span>
                    <span style={{fontSize: 14, color: '#64748b'}}>{progress.currentRound} / {progress.totalRounds}å›ç›®</span>
                  </div>
                  <div style={{background: '#e2e8f0', borderRadius: 8, height: 12, overflow: 'hidden'}}>
                    <div style={{background: 'linear-gradient(90deg, #0ea5e9, #8b5cf6)', height: '100%', width: `${progress.progressPercent}%`, transition: 'width 0.3s'}}></div>
                  </div>
                  <div style={{display: 'flex', justifyContent: 'space-between', marginTop: 8, fontSize: 12, color: '#64748b'}}>
                    <span>å—å–æ¸ˆ: {progress.receiveCount}å</span>
                    <span>æ®‹ã‚Š: {progress.remainingReceives}å</span>
                  </div>
                </div>
              );
            })()}

            <div style={S.stats}>
              <div style={S.stat}><div style={S.statLabel}>ãƒ¡ãƒ³ãƒãƒ¼</div><div style={S.statVal}>{selectedGroup.members.length}</div></div>
              <div style={S.stat}><div style={S.statLabel}>æœˆé¡</div><div style={S.statVal}>Â¥{(selectedGroup.monthlyAmount + selectedGroup.savingsAmount)/1000}åƒ</div></div>
              <div style={S.stat}><div style={S.statLabel}>ç©ç«‹æ®‹</div><div style={S.statVal}>Â¥{(getTotalSavings()/1000).toFixed(0)}åƒ</div></div>
              <div style={{...S.stat, background: getTotalUnpaid() > 0 ? '#fef2f2' : '#ecfdf5'}}><div style={S.statLabel}>æœªæ‰•è¨ˆ</div><div style={{...S.statVal, color: getTotalUnpaid() > 0 ? '#dc2626' : '#10b981'}}>Â¥{(getTotalUnpaid()/1000).toFixed(0)}åƒ</div></div>
            </div>

            {/* æœªæ‰•ã„ã‚¢ãƒ©ãƒ¼ãƒˆ */}
            {(() => {
              const delinquents = getDelinquentMembers();
              if (delinquents.length > 0) {
                const serious = delinquents.filter(d => d.unpaidMonths >= 2);
                const totalAmount = delinquents.reduce((sum, d) => sum + d.unpaidAmount, 0);
                return (
                  <div style={{background: serious.length > 0 ? '#fef2f2' : '#fffbeb', border: `2px solid ${serious.length > 0 ? '#fecaca' : '#fde68a'}`, borderRadius: 14, padding: 16}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10}}>
                      <h4 style={{color: serious.length > 0 ? '#dc2626' : '#d97706', fontSize: 15, fontWeight: 700, margin: 0}}>
                        {serious.length > 0 ? 'âš ï¸ æ»ç´ã‚¢ãƒ©ãƒ¼ãƒˆ' : 'ğŸ“‹ æœªæ‰•ã„çŠ¶æ³'}
                      </h4>
                      <span style={{background: serious.length > 0 ? '#dc2626' : '#f59e0b', color: '#fff', padding: '4px 10px', borderRadius: 12, fontSize: 12, fontWeight: 600}}>
                        {delinquents.length}å / Â¥{(totalAmount/1000).toFixed(0)}åƒ
                      </span>
                    </div>
                    {delinquents.slice(0, 3).map(m => (
                      <div key={m.id} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid #fecaca'}}>
                        <span style={{fontWeight: 600}}>{m.name}</span>
                        <div style={{textAlign: 'right'}}>
                          <div style={{color: m.unpaidMonths >= 2 ? '#dc2626' : '#d97706', fontWeight: 700}}>{m.unpaidMonths}ãƒ¶æœˆ</div>
                          <div style={{fontSize: 12, color: '#64748b'}}>Â¥{m.unpaidAmount.toLocaleString()}</div>
                        </div>
                      </div>
                    ))}
                    {delinquents.length > 3 && (
                      <div style={{fontSize: 12, color: '#64748b', padding: '8px 0'}}>...ä»– {delinquents.length - 3}å</div>
                    )}
                    {isAdmin && (
                      <button 
                        style={{
                          width: '100%',
                          marginTop: 12,
                          padding: '12px',
                          background: '#06c755',
                          color: '#fff',
                          border: 'none',
                          borderRadius: 10,
                          fontSize: 14,
                          fontWeight: 600,
                          cursor: 'pointer'
                        }} 
                        onClick={() => setShowModal('reminderLine')}
                      >
                        ğŸ“± LINEå‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
                      </button>
                    )}
                  </div>
                );
              }
              return null;
            })()}

            {getCurrentEvent() && (
              <div style={{background: 'linear-gradient(135deg, #1e293b, #334155)', borderRadius: 16, padding: 18, color: '#fff', marginBottom: 6}}>
                <div style={{fontSize: 12, color: '#94a3b8', marginBottom: 8}}>ğŸ—“ï¸ æ¬¡å›æ¨¡åˆäºˆå®š</div>
                <div style={{fontSize: 20, fontWeight: 700, marginBottom: 12}}>
                  {getCurrentEvent().date} ({['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(getCurrentEvent().date).getDay()]}) {getCurrentEvent().time}ã€œ
                </div>
                
                {/* ç¢ºå®šã—ãŸåº—èˆ—æƒ…å ± */}
                {getCurrentEvent().confirmedVenue && (() => {
                  const venue = getCurrentEvent().venues?.find(v => v.id === getCurrentEvent().confirmedVenue);
                  return venue ? (
                    <div style={{background: 'rgba(255,255,255,0.1)', borderRadius: 12, padding: 14, marginBottom: 12}}>
                      <div style={{fontSize: 16, fontWeight: 600, marginBottom: 6}}>ğŸ“ {venue.name}</div>
                      {venue.address && <div style={{fontSize: 13, color: '#cbd5e1', marginBottom: 4}}>{venue.address}</div>}
                      {venue.budget && <div style={{fontSize: 13, color: '#fbbf24'}}>ğŸ’° {venue.budget}</div>}
                      {venue.url && <a href={venue.url} target="_blank" rel="noreferrer" style={{color: '#38bdf8', fontSize: 13, textDecoration: 'underline'}}>ğŸ”— ãŠåº—ã®è©³ç´°</a>}
                    </div>
                  ) : null;
                })()}
                
                {/* å‚åŠ çŠ¶æ³ */}
                {(() => {
                  const att = getCurrentEvent().attendance || {};
                  const yes = Object.entries(att).filter(([_, v]) => v === 'yes').length;
                  const maybe = Object.entries(att).filter(([_, v]) => v === 'maybe').length;
                  const no = Object.entries(att).filter(([_, v]) => v === 'no').length;
                  const total = selectedGroup.members.length;
                  
                  return (
                    <div>
                      <div style={{fontSize: 13, color: '#94a3b8', marginBottom: 8}}>å‚åŠ çŠ¶æ³</div>
                      <div style={{display: 'flex', gap: 8, marginBottom: 10}}>
                        <div style={{flex: 1, background: '#10b981', borderRadius: 8, padding: '8px 12px', textAlign: 'center'}}>
                          <div style={{fontSize: 20, fontWeight: 700}}>â­• {yes}</div>
                          <div style={{fontSize: 11}}>å‚åŠ </div>
                        </div>
                        <div style={{flex: 1, background: '#f59e0b', borderRadius: 8, padding: '8px 12px', textAlign: 'center'}}>
                          <div style={{fontSize: 20, fontWeight: 700}}>ğŸ”º {maybe}</div>
                          <div style={{fontSize: 11}}>æœªå®š</div>
                        </div>
                        <div style={{flex: 1, background: '#64748b', borderRadius: 8, padding: '8px 12px', textAlign: 'center'}}>
                          <div style={{fontSize: 20, fontWeight: 700}}>âŒ {no}</div>
                          <div style={{fontSize: 11}}>ä¸å‚åŠ </div>
                        </div>
                        <div style={{flex: 1, background: '#475569', borderRadius: 8, padding: '8px 12px', textAlign: 'center'}}>
                          <div style={{fontSize: 20, fontWeight: 700}}>â“ {total - yes - maybe - no}</div>
                          <div style={{fontSize: 11}}>æœªå›ç­”</div>
                        </div>
                      </div>
                      {/* å‚åŠ è€…å */}
                      {yes > 0 && (
                        <div style={{fontSize: 12, color: '#94a3b8'}}>
                          å‚åŠ : {Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => selectedGroup.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€')}
                        </div>
                      )}
                    </div>
                  );
                })()}
                
                <button style={{width: '100%', marginTop: 12, padding: '12px', background: '#0ea5e9', border: 'none', borderRadius: 10, color: '#fff', fontWeight: 700, fontSize: 15, cursor: 'pointer'}} onClick={() => setCurrentView('party')}>
                  å‡ºæ¬ ã‚’å›ç­”ã™ã‚‹ â†’
                </button>
              </div>
            )}
            
            {!getCurrentEvent() && getNextPartyDate() && (
              <div style={{background: '#f8fafc', border: '2px dashed #cbd5e1', borderRadius: 14, padding: 16, textAlign: 'center'}}>
                <div style={{fontSize: 14, color: '#64748b', marginBottom: 6}}>ğŸ“… æ¬¡å›é–‹å‚¬äºˆå®š</div>
                <div style={{fontSize: 18, fontWeight: 700, color: '#334155'}}>{getNextPartyDate()}</div>
                <button style={{...S.linkBtn, marginTop: 8}} onClick={() => setShowModal('createEvent')}>é£²ã¿ä¼šã‚’ä½œæˆ â†’</button>
              </div>
            )}

            <div style={S.card}>
              <h3 style={S.cardTitle}>ğŸ“… {selectedMonth.replace('-', 'å¹´')}æœˆ</h3>
              <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
                <button 
                  style={{...S.monthNavBtn, borderRadius: '10px 0 0 10px'}} 
                  onClick={() => {
                    const d = new Date(selectedMonth + '-01');
                    d.setMonth(d.getMonth() - 1);
                    setSelectedMonth(d.toISOString().slice(0, 7));
                  }}
                >â—€</button>
                <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} style={{...S.input, flex: 1, borderRadius: 0, textAlign: 'center'}} />
                <button 
                  style={{...S.monthNavBtn, borderRadius: '0 10px 10px 0'}} 
                  onClick={() => {
                    const d = new Date(selectedMonth + '-01');
                    d.setMonth(d.getMonth() + 1);
                    setSelectedMonth(d.toISOString().slice(0, 7));
                  }}
                >â–¶</button>
              </div>
              {(() => {
                const st = getMonthlyStatus(selectedMonth);
                return <>
                  <div style={S.row}><span>âœ… æ”¯æ‰•æ¸ˆ</span><b>{st.paid.length}/{selectedGroup.members.length}</b></div>
                  <div style={S.row}><span>â³ æœªæ‰•ã„</span><b style={{color: st.unpaid.length ? '#dc2626' : '#10b981'}}>{st.unpaid.length}å</b></div>
                  {st.unpaid.length > 0 && <div style={S.unpaidBox}>{st.unpaid.map(m => m.name).join('ã€')}</div>}
                </>;
              })()}
              {isAdmin && (
                <button style={{...S.linkBtn, marginTop: 8}} onClick={() => setShowModal('paymentReminder')}>
                  ğŸ“± å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ä½œæˆ
                </button>
              )}
            </div>

            {/* ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³: ãŠé‡‘é–¢é€£ã¯ç®¡ç†è€…ã®ã¿ã€é£²ã¿ä¼šã¯å…¨å“¡ */}
            <div style={S.quickBtns}>
              {isAdmin && <button style={S.qBtn} onClick={() => setShowModal('payment')}>ğŸ’°å…¥é‡‘</button>}
              {isAdmin && <button style={{...S.qBtn, background: '#8b5cf6'}} onClick={() => setShowModal('receive')}>ğŸ¯å—å–</button>}
              <button style={{...S.qBtn, background: '#f59e0b'}} onClick={() => setShowModal('createEvent')}>ğŸ»é£²ã¿ä¼š</button>
              {isAdmin && <button style={{...S.qBtn, background: '#10b981'}} onClick={() => setShowModal('savingsUsage')}>ğŸ’ç©ç«‹</button>}
            </div>

            {/* æ¬¡ã®å—å–è€…ï¼ˆé †ç•ªåˆ¶ï¼‰ */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ”„ å—å–é †</h4>
              <div style={{fontSize: 13, color: '#64748b', marginBottom: 10}}>
                ãƒ¡ãƒ³ãƒãƒ¼é †ã§æ¬¡ã®å—å–è€…ã‚’è¡¨ç¤º
              </div>
              {(() => {
                const nextReceiver = getNextReceiver();
                if (!nextReceiver) {
                  return <div style={{textAlign: 'center', color: '#10b981', fontWeight: 600}}>ğŸ‰ å…¨å“¡å—å–å®Œäº†ï¼</div>;
                }
                const calc = calculateReceiveAmount(nextReceiver.id);
                return (
                  <div style={{background: '#f0f9ff', padding: 14, borderRadius: 10, border: '2px solid #0ea5e9'}}>
                    <div style={{fontSize: 12, color: '#0369a1'}}>æ¬¡ã®å—å–è€…ï¼ˆé †ç•ªåˆ¶ã®å ´åˆï¼‰</div>
                    <div style={{fontSize: 18, fontWeight: 700, color: '#0284c7', marginTop: 4}}>{nextReceiver.name}</div>
                    <div style={{fontSize: 14, color: '#0369a1', marginTop: 4}}>å—å–äºˆå®šé¡: Â¥{(calc.finalAmount/1000).toFixed(0)}åƒ</div>
                  </div>
                );
              })()}
              <button style={{...S.linkBtn, marginTop: 10}} onClick={() => setShowModal('receiveOrder')}>
                ğŸ“‹ å—å–é †ä¸€è¦§ã‚’è¦‹ã‚‹
              </button>
            </div>

            {isAdmin && (
              <div style={S.card}>
                <h4 style={S.subTitle}>ğŸ² å—å–è€…æŠ½é¸</h4>
                <div style={{fontSize: 14, color: '#64748b', marginBottom: 10}}>
                  <div>æœªå—å–: {getMembersNotReceived().length}å</div>
                  {(selectedGroup.receiveRequests || []).length > 0 ? (
                    <div style={{color: '#f59e0b', marginTop: 6}}>
                      ğŸ“ å—å–å¸Œæœ›: {(selectedGroup.receiveRequests || []).filter(r => getMembersNotReceived().some(m => m.id === r.memberId)).length}å
                      <span style={{fontSize: 12, marginLeft: 6}}>(å„ªå…ˆæŠ½é¸)</span>
                    </div>
                  ) : (
                    // å—å–å¸Œæœ›è€…ãŒã„ãªã„å ´åˆã¯ã‚¹ãƒˆãƒƒã‚¯é‡‘ã‚’è¡¨ç¤º
                    (() => {
                      const pool = getPoolInfo();
                      if (pool.availableCount > 0) {
                        return (
                          <div style={{marginTop: 10, padding: 14, background: '#fef3c7', borderRadius: 10}}>
                            <div style={{color: '#92400e', fontWeight: 600, fontSize: 15}}>
                              ğŸ’° ã‚¹ãƒˆãƒƒã‚¯: Â¥{(pool.poolAmount / 1000).toFixed(0)}åƒ
                            </div>
                            <div style={{color: '#b45309', fontSize: 14, marginTop: 6}}>
                              â†’ ç¾åœ¨ <b>{pool.availableCount}å</b> ãŒå—å–å¯èƒ½
                            </div>
                            <div style={{color: '#78350f', fontSize: 13, marginTop: 4}}>
                              (1åã‚ãŸã‚Š Â¥{(pool.receivePerTime / 1000).toFixed(0)}åƒ)
                            </div>
                          </div>
                        );
                      }
                      return null;
                    })()
                  )}
                </div>
                {isAdmin && (
                  <button style={S.lotteryBtn} onClick={handleLottery} disabled={getMembersNotReceived().length === 0}>
                    ğŸ² æŠ½é¸ã™ã‚‹
                  </button>
                )}
                <button style={{...S.linkBtn, marginTop: 10, display: 'block'}} onClick={() => setShowModal('receiveRequest')}>
                  + å—å–å¸Œæœ›ã‚’ç™»éŒ²
                </button>
              </div>
            )}

            {/* ç©ç«‹é‡‘è©³ç´° */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ’ ç©ç«‹é‡‘</h4>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '8px 0', fontSize: 14}}>
                <span>å¾´åæ¸ˆã¿</span>
                <span>Â¥{(getActivePayments().reduce((sum, p) => sum + (p.savings || 0), 0) / 1000).toFixed(0)}åƒ</span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '8px 0', fontSize: 14, color: '#dc2626'}}>
                <span>ä½¿ç”¨æ¸ˆã¿</span>
                <span>âˆ’Â¥{((selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').reduce((sum, u) => sum + u.amount, 0) / 1000).toFixed(0)}åƒ</span>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderTop: '2px solid #e2e8f0', fontSize: 16, fontWeight: 700}}>
                <span>æ®‹é«˜</span>
                <span style={{color: '#10b981'}}>Â¥{(getTotalSavings() / 1000).toFixed(0)}åƒ</span>
              </div>
              {(selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').length > 0 && (
                <div style={{marginTop: 10}}>
                  <div style={{fontSize: 12, color: '#64748b', marginBottom: 6}}>ä½¿ç”¨å±¥æ­´</div>
                  {(selectedGroup?.savingsUsage || []).filter(u => u.status !== 'deleted').slice(-3).reverse().map(u => (
                    <div key={u.id} style={{display: 'flex', justifyContent: 'space-between', padding: '6px 0', fontSize: 13, borderBottom: '1px solid #f1f5f9'}}>
                      <span>{u.purpose}</span>
                      <span>Â¥{(u.amount/1000).toFixed(0)}åƒ</span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* ğŸ† é£²ã¿ä¼šå‚åŠ ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° */}
            {(() => {
              const stats = getMemberParticipationStats();
              const completedEvents = (selectedGroup?.events || []).filter(e => e.status === 'completed' || e.status === 'confirmed');
              
              if (completedEvents.length === 0) return null;
              
              const perfectMembers = stats.filter(s => s.isPerfect);
              
              return (
                <div style={S.card}>
                  <h4 style={S.subTitle}>ğŸ† é£²ã¿ä¼šå‚åŠ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
                  <div style={{fontSize: 12, color: '#64748b', marginBottom: 12}}>
                    éå»{completedEvents.length}å›ã®é£²ã¿ä¼šã§ã®å‚åŠ ç‡
                  </div>
                  
                  {/* çš†å‹¤è³ */}
                  {perfectMembers.length > 0 && (
                    <div style={{background: 'linear-gradient(135deg, #fef3c7, #fde68a)', borderRadius: 12, padding: 14, marginBottom: 14, border: '2px solid #f59e0b'}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8}}>
                        <span style={{fontSize: 24}}>ğŸ‘‘</span>
                        <span style={{fontWeight: 700, color: '#92400e'}}>çš†å‹¤è³ï¼</span>
                      </div>
                      <div style={{display: 'flex', flexWrap: 'wrap', gap: 8}}>
                        {perfectMembers.map(m => (
                          <span key={m.id} style={{background: '#fff', padding: '6px 12px', borderRadius: 20, fontSize: 14, fontWeight: 600, color: '#92400e', boxShadow: '0 2px 4px rgba(0,0,0,0.1)'}}>
                            â­ {m.name}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒãƒ¼ä»˜ãï¼‰ */}
                  <div style={{display: 'flex', flexDirection: 'column', gap: 10}}>
                    {stats.slice(0, 5).map((member, index) => {
                      const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                      const barColor = member.rate >= 80 ? '#10b981' : member.rate >= 50 ? '#f59e0b' : '#ef4444';
                      
                      return (
                        <div key={member.id}>
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                              <span style={{fontSize: 16, width: 24}}>{medal || `${index + 1}.`}</span>
                              <span style={{fontWeight: member.isPerfect ? 700 : 500, color: member.isPerfect ? '#92400e' : '#334155'}}>
                                {member.name}
                              </span>
                            </div>
                            <div style={{textAlign: 'right'}}>
                              <span style={{fontWeight: 700, color: barColor}}>{member.rate}%</span>
                              <span style={{fontSize: 12, color: '#94a3b8', marginLeft: 6}}>({member.attended}/{member.total})</span>
                            </div>
                          </div>
                          <div style={{background: '#e2e8f0', borderRadius: 6, height: 8, overflow: 'hidden'}}>
                            <div style={{
                              background: barColor,
                              height: '100%',
                              width: `${member.rate}%`,
                              borderRadius: 6,
                              transition: 'width 0.5s ease'
                            }}></div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {stats.length > 5 && (
                    <div style={{marginTop: 12, textAlign: 'center', fontSize: 13, color: '#64748b'}}>
                      ä»– {stats.length - 5}å
                    </div>
                  )}
                </div>
              );
            })()}
          </div>
        )}

        {/* é£²ã¿ä¼š */}
        {currentView === 'party' && (
          <PartyView
            group={selectedGroup}
            isAdmin={isAdmin}
            currentEvent={getCurrentEvent()}
            pastEvents={getPastEvents()}
            getNextPartyDate={getNextPartyDate}
            onCreateEvent={() => setShowModal('createEvent')}
            onEditEvent={(event) => { setEditingEvent(event); setShowModal('editEvent'); }}
            onDeleteEvent={handleDeleteEvent}
            onAddVenue={handleAddVenue}
            onAddVenueFromPast={handleAddVenueFromPast}
            onDeleteVenue={handleDeleteVenue}
            onDeletePastVenue={handleDeletePastVenue}
            onAttendanceVote={handleAttendanceVote}
            onVenueVote={handleVenueVote}
            onConfirmEvent={handleConfirmEvent}
            onCompleteEvent={handleCompleteEvent}
            onRecordExpense={(eventId) => { setEditingEvent(selectedGroup.events.find(e => e.id === eventId)); setShowModal('expense'); }}
            onAddPhoto={handleAddPhoto}
            notify={notify}
          />
        )}

        {/* ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—…è¡Œãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãªã©ï¼‰ */}
        {currentView === 'events' && (
          <SpecialEventsView
            group={selectedGroup}
            events={selectedGroup.specialEvents || []}
            onCreateEvent={handleCreateSpecialEvent}
            onEditEvent={handleEditSpecialEvent}
            onDeleteEvent={handleDeleteSpecialEvent}
            onVote={handleSpecialEventVote}
            onClose={handleCloseSpecialEvent}
            onReopen={handleReopenSpecialEvent}
            notify={notify}
          />
        )}

        {/* ãƒ¡ãƒ³ãƒãƒ¼ */}
        {currentView === 'members' && (
          <div style={S.view}>
            <div style={S.viewHeader}>
              <h3 style={S.viewTitle}>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼</h3>
              <button style={S.addBtn} onClick={() => setShowModal('addMember')}>+</button>
            </div>
            {selectedGroup.members.map((m, i) => {
              const bal = getMemberBalance(m.id);
              const receives = getActiveReceives().filter(r => r.winnerId === m.id);
              const hasBank = m.bankName && m.accountNumber;
              return (
                <div key={m.id} style={S.memberCard}>
                  <div style={S.memberTop}>
                    <div style={S.memberNum}>{i + 1}</div>
                    <div style={S.memberInfo}>
                      <div style={S.memberName}>{m.name}</div>
                    </div>
                    <div style={S.memberBtns}>
                      <button style={S.editBtn} onClick={() => { setEditingMember(m); setShowModal('editMember'); }}>âœ</button>
                      {isAdmin && <button style={S.delBtn} onClick={() => handleDeleteMember(m.id)}>Ã—</button>}
                    </div>
                  </div>
                  <div style={S.memberStats}>
                    <div><span style={S.mLabel}>æ®‹é«˜</span><span style={{color: bal.balance >= 0 ? '#10b981' : '#dc2626', fontWeight: 700}}>Â¥{(bal.balance/1000).toFixed(0)}åƒ</span></div>
                    <div><span style={S.mLabel}>å—å–</span><span>{receives.length}å›</span></div>
                    <div><span style={S.mLabel}>æœªæ‰•</span><span style={{color: bal.unpaidMonths.length ? '#dc2626' : '#10b981'}}>{bal.unpaidMonths.length}ãƒ¶æœˆ</span></div>
                  </div>
                  {/* å£åº§æƒ…å ±ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
                  {isAdmin && (
                    <div style={{marginTop: 10, paddingTop: 10, borderTop: '1px solid #e2e8f0'}}>
                      {hasBank ? (
                        <div style={{background: '#f0f9ff', padding: '10px 12px', borderRadius: 8, fontSize: 12, color: '#0369a1'}}>
                          <div style={{fontWeight: 600, marginBottom: 4}}>ğŸ¦ æŒ¯è¾¼å…ˆ</div>
                          <div>{m.bankName} {m.branchName}</div>
                          <div>{m.accountType} {m.accountNumber}</div>
                          <div>{m.accountHolder}</div>
                        </div>
                      ) : (
                        <div style={{background: '#fef3c7', padding: '8px 12px', borderRadius: 8, fontSize: 12, color: '#92400e'}}>
                          âš ï¸ å£åº§æœªç™»éŒ² - ç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* ä¸€æ‹¬å…¥é‡‘ */}
        {currentView === 'bulk' && (
          <BulkPaymentView group={selectedGroup} month={selectedMonth} setMonth={setSelectedMonth} getMonthlyStatus={getMonthlyStatus} onSubmit={handleBulkPayment} isAdmin={isAdmin} onOpenReminder={() => setShowModal('reminderLine')} delinquents={getDelinquentMembers()} />
        )}

        {/* å—å– */}
        {currentView === 'receive' && (
          <div style={S.view}>
            <div style={S.viewHeader}>
              <h3 style={S.viewTitle}>ğŸ¯ å—å–ç®¡ç†</h3>
              {isAdmin && <button style={S.addBtn} onClick={() => setShowModal('receive')}>+</button>}
            </div>
            <div style={S.card}>
              <h4 style={S.subTitle}>æœªå—å– ({getMembersNotReceived().length}å)</h4>
              {getMembersNotReceived().map(m => {
                const calc = calculateReceiveAmount(m.id);
                const hasBank = m.bankName && m.accountNumber;
                return (
                  <div key={m.id} style={{...S.notRecItem, flexDirection: 'column', alignItems: 'stretch', gap: 8}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <span style={{fontWeight: 600}}>{m.name}</span>
                      <span style={{color: '#8b5cf6', fontWeight: 700}}>Â¥{(calc.finalAmount/1000).toFixed(0)}åƒ</span>
                    </div>
                    {isAdmin && hasBank && (
                      <div style={{background: '#f0f9ff', padding: '10px 12px', borderRadius: 8, fontSize: 12, color: '#0369a1'}}>
                        <div style={{fontWeight: 600, marginBottom: 4}}>ğŸ¦ æŒ¯è¾¼å…ˆ</div>
                        <div>{m.bankName} {m.branchName}</div>
                        <div>{m.accountType} {m.accountNumber}</div>
                        <div>{m.accountHolder}</div>
                      </div>
                    )}
                    {isAdmin && !hasBank && (
                      <div style={{background: '#fef3c7', padding: '8px 12px', borderRadius: 8, fontSize: 12, color: '#92400e'}}>
                        âš ï¸ å£åº§æœªç™»éŒ²
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            <div style={S.card}>
              <h4 style={S.subTitle}>å—å–å±¥æ­´</h4>
              {getActiveReceives().length === 0 ? <div style={S.empty}>å±¥æ­´ãªã—</div> : getActiveReceives().slice().reverse().map(r => {
                const m = selectedGroup.members.find(x => x.id === r.winnerId);
                return (
                  <div key={r.id} style={{...S.histRow, alignItems: 'center'}}>
                    <span>{r.month}</span>
                    <span style={{flex: 1}}>{m?.name}</span>
                    <span style={{color: '#8b5cf6', marginRight: 8}}>Â¥{(r.amount/1000).toFixed(0)}åƒ</span>
                    {isAdmin && <button style={S.cancelSmBtn} onClick={() => handleCancelReceive(r.id)}>å–æ¶ˆ</button>}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ä¸€è¦§è¡¨ */}
        {currentView === 'table' && (
          <div style={S.view}>
            <div style={S.viewHeader}>
              <h3 style={S.viewTitle}>ğŸ“Š ä¸€è¦§è¡¨</h3>
              <div style={{display: 'flex', gap: 8}}>
                <button style={{...S.exportBtn, background: '#06c755'}} onClick={() => {
                  // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ä¸€è¦§è¡¨ã‚’ç”Ÿæˆ
                  const monthList = getMonthList();
                  const currentMonth = new Date().toISOString().slice(0, 7);
                  const targetMonths = monthList.filter(m => m <= currentMonth); // é–‹å§‹æœˆã‹ã‚‰å½“æœˆã¾ã§
                  const appUrl = window.location.href.split('?')[0] + '?view=table';
                  
                  let text = `ğŸ“Š ${selectedGroup.name} å…¥é‡‘çŠ¶æ³\n`;
                  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                  text += `ğŸ“… ${new Date().toLocaleDateString('ja-JP')} ç¾åœ¨\n`;
                  text += `ğŸ“† ${selectedGroup.startMonth?.replace('-', 'å¹´') + 'æœˆ'}ã€œ${currentMonth.replace('-', 'å¹´') + 'æœˆ'}ï¼ˆ${targetMonths.length}ãƒ¶æœˆï¼‰\n\n`;
                  
                  // å‡¡ä¾‹
                  text += `ã€å‡¡ä¾‹ã€‘âœ…æ¸ˆ ï¼ â¬œæœª ï¼ ğŸ”„ç›¸æ®º\n\n`;
                  
                  // å„ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆç¸¦å‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
                  selectedGroup.members.forEach((m, idx) => {
                    const bal = getMemberBalance(m.id);
                    const paidCount = targetMonths.filter(month => {
                      const info = getMemberPaymentForMonth(m.id, month);
                      return info.status === 'paid' || info.status === 'offset';
                    }).length;
                    const unpaidCount = targetMonths.length - paidCount;
                    
                    text += `${idx + 1}. ${m.name}\n`;
                    
                    // æœˆã”ã¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡Œã§è¡¨ç¤º
                    let statusLine = '';
                    targetMonths.forEach(month => {
                      const info = getMemberPaymentForMonth(m.id, month);
                      const mark = info.status === 'paid' ? 'âœ…' : info.status === 'offset' ? 'ğŸ”„' : 'â¬œ';
                      statusLine += mark;
                    });
                    text += `ã€€${statusLine}\n`;
                    text += `ã€€â†’ ${paidCount}/${targetMonths.length}æ¸ˆ`;
                    if (bal.balance < 0) {
                      text += ` âš ï¸æœªæ‰•Â¥${Math.abs(bal.balance).toLocaleString()}`;
                    }
                    text += `\n\n`;
                  });
                  
                  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                  
                  // ã‚µãƒãƒªãƒ¼
                  const delinquents = selectedGroup.members.filter(m => getMemberBalance(m.id).balance < 0);
                  const totalUnpaid = delinquents.reduce((sum, m) => sum + Math.abs(getMemberBalance(m.id).balance), 0);
                  
                  if (delinquents.length > 0) {
                    text += `âš ï¸ æœªæ‰•ã„: ${delinquents.length}å / Â¥${totalUnpaid.toLocaleString()}\n`;
                  } else {
                    text += `âœ… å…¨å“¡å…¥é‡‘æ¸ˆã¿ï¼\n`;
                  }
                  
                  text += `\nğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰\n${appUrl}`;
                  
                  if (selectedGroup.lineGroupUrl) {
                    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
                  } else {
                    navigator.clipboard?.writeText(text);
                    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                  }
                }}>ğŸ“±</button>
                <button style={S.exportBtn} onClick={() => setShowModal('export')}>ğŸ“¥</button>
              </div>
            </div>
            
            {/* LINEå…±æœ‰ã®èª¬æ˜ */}
            <div style={{fontSize: 11, color: '#64748b', marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8}}>
              <span>ğŸ“± = LINEå…±æœ‰ï¼ˆå…¨æœŸé–“ï¼‰</span>
              <span>ğŸ“¥ = CSVå‡ºåŠ›</span>
            </div>
            
            <div style={S.tableWrap}>
              <table style={S.table}>
                <thead><tr>
                  <th style={S.th}>No</th>
                  <th style={{...S.th, minWidth: 70}}>åå‰</th>
                  {getMonthList().map((m, i, arr) => {
                    // å¹´ãŒå¤‰ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‹æœ€åˆã®æœˆãªã‚‰å¹´ã‚‚è¡¨ç¤º
                    const showYear = i === 0 || m.slice(0, 4) !== arr[i - 1]?.slice(0, 4);
                    const year = m.slice(2, 4); // ä¸‹2æ¡
                    const month = m.slice(5);
                    return <th key={m} style={S.th}>{showYear ? `${year}/` : ''}{month}</th>;
                  })}
                  <th style={{...S.th, background: '#fef3c7'}}>æ®‹é«˜</th>
                </tr></thead>
                <tbody>
                  {selectedGroup.members.map((m, i) => {
                    const bal = getMemberBalance(m.id);
                    return (
                      <tr key={m.id}>
                        <td style={S.td}>{i + 1}</td>
                        <td style={{...S.td, textAlign: 'left', fontSize: 12}}>{m.name}</td>
                        {getMonthList().map(month => {
                          const info = getMemberPaymentForMonth(m.id, month);
                          return <td key={month} style={{...S.td, background: info.status === 'paid' ? '#d1fae5' : info.status === 'offset' ? '#fef3c7' : '#fee2e2', fontSize: 11}}>{info.status === 'paid' ? 'âœ“' : info.status === 'offset' ? 'ç›¸' : ''}</td>;
                        })}
                        <td style={{...S.td, fontWeight: 700, color: bal.balance >= 0 ? '#059669' : '#dc2626'}}>{(bal.balance/1000).toFixed(0)}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* å±¥æ­´ */}
        {currentView === 'history' && (
          <div style={S.view}>
            <h3 style={S.viewTitle}>ğŸ“œ æ“ä½œå±¥æ­´</h3>
            
            {/* å…¥é‡‘å±¥æ­´ */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ’° å…¥é‡‘å±¥æ­´</h4>
              {selectedGroup.payments.length === 0 ? (
                <div style={S.empty}>å±¥æ­´ãªã—</div>
              ) : (
                selectedGroup.payments.slice().reverse().map(p => {
                  const m = selectedGroup.members.find(x => x.id === p.memberId);
                  const isDeleted = p.status === 'deleted';
                  return (
                    <div key={p.id} style={{...S.histRow, alignItems: 'center', opacity: isDeleted ? 0.5 : 1, background: isDeleted ? '#fef2f2' : 'transparent'}}>
                      <span style={{fontSize: 12, color: '#64748b'}}>{p.recordedAt?.slice(0, 10)}</span>
                      <span>{p.month}</span>
                      <span style={{flex: 1}}>{m?.name || 'ä¸æ˜'}</span>
                      <span style={{color: '#0ea5e9', marginRight: 8}}>Â¥{((p.amount + p.savings)/1000).toFixed(0)}åƒ</span>
                      {isDeleted ? (
                        <span style={{fontSize: 11, color: '#dc2626', padding: '2px 6px', background: '#fee2e2', borderRadius: 4}}>å–æ¶ˆæ¸ˆ</span>
                      ) : (
                        isAdmin && <button style={S.cancelSmBtn} onClick={() => handleCancelPayment(p.id)}>å–æ¶ˆ</button>
                      )}
                    </div>
                  );
                })
              )}
            </div>

            {/* å—å–å±¥æ­´ */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ¯ å—å–å±¥æ­´</h4>
              {selectedGroup.receives.length === 0 ? (
                <div style={S.empty}>å±¥æ­´ãªã—</div>
              ) : (
                selectedGroup.receives.slice().reverse().map(r => {
                  const m = selectedGroup.members.find(x => x.id === r.winnerId);
                  const isDeleted = r.status === 'deleted';
                  return (
                    <div key={r.id} style={{...S.histRow, alignItems: 'center', opacity: isDeleted ? 0.5 : 1, background: isDeleted ? '#fef2f2' : 'transparent'}}>
                      <span style={{fontSize: 12, color: '#64748b'}}>{r.recordedAt?.slice(0, 10)}</span>
                      <span>{r.month}</span>
                      <span style={{flex: 1}}>{m?.name || 'ä¸æ˜'}</span>
                      <span style={{color: '#8b5cf6', marginRight: 8}}>Â¥{(r.amount/1000).toFixed(0)}åƒ</span>
                      {isDeleted ? (
                        <span style={{fontSize: 11, color: '#dc2626', padding: '2px 6px', background: '#fee2e2', borderRadius: 4}}>å–æ¶ˆæ¸ˆ</span>
                      ) : (
                        isAdmin && <button style={S.cancelSmBtn} onClick={() => handleCancelReceive(r.id)}>å–æ¶ˆ</button>
                      )}
                    </div>
                  );
                })
              )}
            </div>

            {/* ç›£æŸ»ãƒ­ã‚° */}
            <div style={S.card}>
              <h4 style={S.subTitle}>ğŸ“‹ ç›£æŸ»ãƒ­ã‚°</h4>
              <div style={{fontSize: 12, color: '#64748b', marginBottom: 10}}>
                â€» ã“ã®å±¥æ­´ã¯å‰Šé™¤ã§ãã¾ã›ã‚“
              </div>
              {(selectedGroup.auditLog || []).length === 0 ? (
                <div style={S.empty}>å±¥æ­´ãªã—</div>
              ) : (
                (selectedGroup.auditLog || []).slice().reverse().slice(0, 50).map(log => (
                  <div key={log.id} style={{...S.histRow, fontSize: 13}}>
                    <span style={{fontSize: 11, color: '#64748b', minWidth: 80}}>{log.timestamp?.slice(5, 16).replace('T', ' ')}</span>
                    <span style={{fontWeight: 600, color: '#334155'}}>{log.action}</span>
                    <span style={{flex: 1, color: '#64748b'}}>{log.details}</span>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {/* ãƒ˜ãƒ«ãƒ— */}
        {currentView === 'help' && (
          <HelpView isAdmin={isAdmin} group={selectedGroup} />
        )}
      </main>

      {/* ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showLoginModal && (
        <Modal onClose={() => setShowLoginModal(false)}>
          <LoginForm onLogin={handleLogin} onCancel={() => setShowLoginModal(false)} />
        </Modal>
      )}

      {/* ãã®ä»–ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showModal && (
        <Modal onClose={() => setShowModal(null)}>
          {showModal === 'payment' && <PaymentForm group={selectedGroup} month={selectedMonth} payments={getActivePayments()} onSubmit={handlePayment} onCancel={() => setShowModal(null)} />}
          {showModal === 'receive' && <ReceiveForm group={selectedGroup} month={selectedMonth} notReceived={getMembersNotReceived()} calculateAmount={calculateReceiveAmount} onSubmit={handleReceive} onCancel={() => setShowModal(null)} />}
          {showModal === 'receiveRequest' && <ReceiveRequestForm group={selectedGroup} notReceived={getMembersNotReceived()} onSubmit={handleReceiveRequest} onCancel={() => setShowModal(null)} />}
          {showModal === 'addMember' && <MemberForm onSubmit={handleAddMember} onCancel={() => setShowModal(null)} />}
          {showModal === 'editMember' && <MemberForm member={editingMember} onSubmit={handleEditMember} onCancel={() => { setShowModal(null); setEditingMember(null); }} />}
          {showModal === 'balance' && <BalanceForm onSubmit={handleBalanceRecord} onCancel={() => setShowModal(null)} />}
          {showModal === 'createEvent' && <EventForm nextDate={getNextPartyDate()} onSubmit={handleCreateEvent} onCancel={() => setShowModal(null)} />}
          {showModal === 'editEvent' && editingEvent && <EventForm event={editingEvent} onSubmit={(data) => handleEditEvent(editingEvent.id, data)} onCancel={() => { setShowModal(null); setEditingEvent(null); }} />}
          {showModal === 'expense' && editingEvent && <ExpenseForm event={editingEvent} members={selectedGroup.members} onSubmit={(data) => handleRecordExpense(editingEvent.id, data)} onCancel={() => { setShowModal(null); setEditingEvent(null); }} />}
          {showModal === 'settings' && <SettingsForm group={selectedGroup} onSubmit={handleUpdateGroup} onChangePassword={handleChangePassword} onCancel={() => setShowModal(null)} />}
          {showModal === 'export' && <ExportForm group={selectedGroup} getMonthList={getMonthList} getMemberPaymentForMonth={getMemberPaymentForMonth} getMemberBalance={getMemberBalance} onCancel={() => setShowModal(null)} />}
          {showModal === 'savingsUsage' && <SavingsUsageForm group={selectedGroup} totalSavings={getTotalSavings()} onSubmit={handleUseSavings} onCancel={() => setShowModal(null)} onCancelUsage={handleCancelSavingsUsage} />}
          {showModal === 'paymentReminder' && <PaymentReminderModal group={selectedGroup} month={selectedMonth} status={getMonthlyStatus(selectedMonth)} onClose={() => setShowModal(null)} notify={notify} getMonthlyStatus={getMonthlyStatus} getMonthList={getMonthList} />}
          {showModal === 'paymentThanks' && lastPaidInfo && <PaymentThanksModal group={selectedGroup} paidMembers={lastPaidInfo.members} month={lastPaidInfo.month} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'partyConfirmed' && lastConfirmedParty && <PartyConfirmedModal group={selectedGroup} event={lastConfirmedParty.event} venue={lastConfirmedParty.venue} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'eventConfirmed' && lastConfirmedEvent && <EventConfirmedModal group={selectedGroup} event={lastConfirmedEvent} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'receiveNotify' && lastReceiveInfo && <ReceiveNotifyModal group={selectedGroup} member={lastReceiveInfo.member} amount={lastReceiveInfo.amount} month={lastReceiveInfo.month} baseAmount={lastReceiveInfo.baseAmount} offsetAmount={lastReceiveInfo.offsetAmount} finalAmount={lastReceiveInfo.finalAmount} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'reminderLine' && <DelinquentReminderModal group={selectedGroup} delinquents={getDelinquentMembers()} onClose={() => setShowModal(null)} notify={notify} />}
          {showModal === 'receiveOrder' && <ReceiveOrderModal group={selectedGroup} receiveOrder={getReceiveOrder()} onClose={() => setShowModal(null)} />}
        </Modal>
      )}

      {/* è¨­å®šãƒœã‚¿ãƒ³ */}
      {isAdmin && (
        <button style={S.settingsFab} onClick={() => setShowModal('settings')}>âš™ï¸</button>
      )}
    </div>
  );
}

// ===== ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ =====

function Modal({ children, onClose }) {
  return (
    <div style={S.overlay} onClick={onClose}>
      <div style={S.modal} onClick={e => e.stopPropagation()}>{children}</div>
    </div>
  );
}

function LoginForm({ onLogin, onCancel }) {
  const [pw, setPw] = React.useState('');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
      <input type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value={pw} onChange={e => setPw(e.target.value)} style={S.input} autoFocus />
      <div style={S.hint}>åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: 1234</div>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onLogin(pw)}>ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  );
}

function PaymentForm({ group, month, payments, onSubmit, onCancel }) {
  const [memberId, setMemberId] = React.useState('');
  const [payMonth, setPayMonth] = React.useState(month);
  const [amount, setAmount] = React.useState(group.monthlyAmount / 1000);
  const [savings, setSavings] = React.useState(group.savingsAmount / 1000);
  const unpaid = group.members.filter(m => !payments.some(p => p.memberId === m.id && p.month === payMonth));
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’° å…¥é‡‘</h3>
      <input type="month" value={payMonth} onChange={e => setPayMonth(e.target.value)} style={S.input} />
      <select value={memberId} onChange={e => setMemberId(e.target.value)} style={S.input}>
        <option value="">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</option>
        {unpaid.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
      </select>
      <div style={S.row2}>
        <input type="number" value={amount} onChange={e => setAmount(+e.target.value)} style={S.input} placeholder="æœ¬ä½“(åƒå††)" />
        <input type="number" value={savings} onChange={e => setSavings(+e.target.value)} style={S.input} placeholder="ç©ç«‹(åƒå††)" />
      </div>
      <div style={S.total}>åˆè¨ˆ: Â¥{((amount + savings) * 1000).toLocaleString()}</div>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ memberId, month: payMonth, amount: amount * 1000, savings: savings * 1000 })} disabled={!memberId}>è¨˜éŒ²</button>
      </div>
    </div>
  );
}

function ReceiveForm({ group, month, notReceived, calculateAmount, onSubmit, onCancel }) {
  const [winnerId, setWinnerId] = React.useState('');
  const [recMonth, setRecMonth] = React.useState(month);
  const [useCustomAmount, setUseCustomAmount] = React.useState(false);
  const [customAmount, setCustomAmount] = React.useState('');
  
  const calc = winnerId ? calculateAmount(winnerId) : { baseAmount: 0, offsetAmount: 0, finalAmount: 0 };
  const finalAmount = useCustomAmount ? (customAmount * 1000) : calc.finalAmount;
  
  // å—å–æ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
  const receivedIds = (group.receives || []).filter(r => r.status !== 'deleted').map(r => r.winnerId);
  const isReceived = (memberId) => receivedIds.includes(memberId);
  
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ¯ å—å–ï¼ˆæ‰•ã„å‡ºã—ï¼‰</h3>
      
      <label style={S.label}>ğŸ“… å—å–æœˆ</label>
      <input type="month" value={recMonth} onChange={e => setRecMonth(e.target.value)} style={S.input} />
      
      <label style={S.label}>ğŸ‘¤ å—å–è€…</label>
      <select value={winnerId} onChange={e => { setWinnerId(e.target.value); setUseCustomAmount(false); }} style={S.input}>
        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        <optgroup label="ğŸ”´ æœªå—å–">
          {notReceived.map(m => (
            <option key={m.id} value={m.id}>{m.name}</option>
          ))}
        </optgroup>
        <optgroup label="âœ… å—å–æ¸ˆï¼ˆ2å›ç›®ä»¥é™ï¼‰">
          {group.members.filter(m => isReceived(m.id)).map(m => (
            <option key={m.id} value={m.id}>{m.name}ï¼ˆå—å–æ¸ˆï¼‰</option>
          ))}
        </optgroup>
      </select>
      
      {winnerId && (
        <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, marginTop: 8}}>
          <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 14}}>
            <span>åŸºæœ¬é¡ï¼ˆ{group.members.length}å Ã— Â¥{(group.monthlyAmount/1000).toFixed(0)}åƒï¼‰</span>
            <span style={{fontWeight: 600}}>Â¥{(calc.baseAmount/1000).toFixed(0)}åƒ</span>
          </div>
          {calc.offsetAmount > 0 && (
            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 14, color: '#dc2626'}}>
              <span>âš ï¸ æœªæ‰•ã„åˆ†ã‚’ç›¸æ®º</span>
              <span>âˆ’Â¥{(calc.offsetAmount/1000).toFixed(0)}åƒ</span>
            </div>
          )}
          <div style={{display: 'flex', justifyContent: 'space-between', paddingTop: 8, borderTop: '2px solid #e2e8f0', fontSize: 16, fontWeight: 700}}>
            <span>è¨ˆç®—ä¸Šã®å—å–é¡</span>
            <span style={{color: '#8b5cf6'}}>Â¥{(calc.finalAmount/1000).toFixed(0)}åƒ</span>
          </div>
        </div>
      )}
      
      <div style={{marginTop: 12}}>
        <label style={{display: 'flex', alignItems: 'center', gap: 8, fontSize: 14, cursor: 'pointer'}}>
          <input 
            type="checkbox" 
            checked={useCustomAmount} 
            onChange={e => setUseCustomAmount(e.target.checked)}
            style={{width: 20, height: 20}}
          />
          é‡‘é¡ã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹
        </label>
      </div>
      
      {useCustomAmount && (
        <div style={{marginTop: 8}}>
          <label style={S.label}>ğŸ’° å®Ÿéš›ã®å—å–é¡ï¼ˆåƒå††ï¼‰</label>
          <input 
            type="number" 
            value={customAmount} 
            onChange={e => setCustomAmount(e.target.value)} 
            style={S.input} 
            placeholder={`ä¾‹: ${(calc.finalAmount/1000).toFixed(0)}`}
          />
        </div>
      )}
      
      <div style={{...S.total, marginTop: 12, fontSize: 20}}>
        å—å–é¡: Â¥{(finalAmount/1000).toFixed(0)}åƒ
        <div style={{fontSize: 12, color: '#64748b', marginTop: 4}}>
          ï¼ˆÂ¥{finalAmount.toLocaleString()}ï¼‰
        </div>
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button 
          style={S.submitBtn} 
          onClick={() => onSubmit({ 
            winnerId, 
            month: recMonth, 
            amount: finalAmount, 
            baseAmount: calc.baseAmount,
            offsetAmount: useCustomAmount ? 0 : calc.offsetAmount 
          })} 
          disabled={!winnerId || (useCustomAmount && !customAmount)}
        >
          è¨˜éŒ²ã™ã‚‹
        </button>
      </div>
    </div>
  );
}

function ReceiveRequestForm({ group, notReceived, onSubmit, onCancel }) {
  const [memberId, setMemberId] = React.useState('');
  const existingRequests = (group.receiveRequests || []).map(r => r.memberId);
  // æœªå—å–ã‹ã¤å¸Œæœ›æœªç™»éŒ²ã®äººã®ã¿è¡¨ç¤º
  const availableMembers = notReceived.filter(m => !existingRequests.includes(m.id));
  
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“ å—å–å¸Œæœ›ç™»éŒ²</h3>
      <p style={{fontSize: 14, color: '#64748b', margin: '0 0 14px'}}>
        æŠ½é¸æ™‚ã«å„ªå…ˆã•ã‚Œã¾ã™
      </p>
      {availableMembers.length === 0 ? (
        <div style={S.empty}>ç™»éŒ²å¯èƒ½ãªãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>
      ) : (
        <>
          <select value={memberId} onChange={e => setMemberId(e.target.value)} style={S.input}>
            <option value="">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</option>
            {availableMembers.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
          </select>
          <div style={S.btnRow}>
            <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style={S.submitBtn} onClick={() => onSubmit({ memberId })} disabled={!memberId}>ç™»éŒ²</button>
          </div>
        </>
      )}
      {existingRequests.length > 0 && (
        <div style={{marginTop: 18, padding: 14, background: '#fef3c7', borderRadius: 10}}>
          <div style={{fontSize: 14, fontWeight: 600, marginBottom: 10}}>ğŸ“ ç¾åœ¨ã®å—å–å¸Œæœ›è€…</div>
          {(group.receiveRequests || []).map(r => {
            const m = group.members.find(x => x.id === r.memberId);
            return <div key={r.id} style={{fontSize: 14, padding: '6px 0'}}>{m?.name}</div>;
          })}
        </div>
      )}
    </div>
  );
}

function MemberForm({ member, onSubmit, onCancel }) {
  const [name, setName] = React.useState(member?.name || '');
  const [bankName, setBankName] = React.useState(member?.bankName || '');
  const [branchName, setBranchName] = React.useState(member?.branchName || '');
  const [accountType, setAccountType] = React.useState(member?.accountType || 'æ™®é€š');
  const [accountNumber, setAccountNumber] = React.useState(member?.accountNumber || '');
  const [accountHolder, setAccountHolder] = React.useState(member?.accountHolder || '');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>{member ? 'âœ ç·¨é›†' : '+ è¿½åŠ '}</h3>
      <input type="text" value={name} onChange={e => setName(e.target.value)} style={S.input} placeholder="åå‰ *" />
      
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, marginTop: 8}}>
        <div style={{fontSize: 13, fontWeight: 600, color: '#334155', marginBottom: 10}}>ğŸ¦ æŒ¯è¾¼å£åº§</div>
        <input type="text" value={bankName} onChange={e => setBankName(e.target.value)} style={{...S.input, marginBottom: 8}} placeholder="éŠ€è¡Œåï¼ˆä¾‹: ç‰çƒéŠ€è¡Œï¼‰" />
        <input type="text" value={branchName} onChange={e => setBranchName(e.target.value)} style={{...S.input, marginBottom: 8}} placeholder="æ”¯åº—åï¼ˆä¾‹: é‚£è¦‡æ”¯åº—ï¼‰" />
        <div style={{display: 'flex', gap: 8, marginBottom: 8}}>
          <select value={accountType} onChange={e => setAccountType(e.target.value)} style={{...S.input, flex: 1}}>
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="å½“åº§">å½“åº§</option>
          </select>
          <input type="text" value={accountNumber} onChange={e => setAccountNumber(e.target.value)} style={{...S.input, flex: 2}} placeholder="å£åº§ç•ªå·" />
        </div>
        <input type="text" value={accountHolder} onChange={e => setAccountHolder(e.target.value)} style={S.input} placeholder="å£åº§åç¾©ï¼ˆã‚«ãƒŠï¼‰" />
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ name, bankName, branchName, accountType, accountNumber, accountHolder })} disabled={!name}>{member ? 'æ›´æ–°' : 'è¿½åŠ '}</button>
      </div>
    </div>
  );
}

function BalanceForm({ onSubmit, onCancel }) {
  const [date, setDate] = React.useState(new Date().toISOString().slice(0, 10));
  const [balance, setBalance] = React.useState('');
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’³ æ®‹é«˜è¨˜éŒ²</h3>
      <input type="date" value={date} onChange={e => setDate(e.target.value)} style={S.input} />
      <input type="number" value={balance} onChange={e => setBalance(e.target.value)} style={S.input} placeholder="æ®‹é«˜(å††)" />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ date, balance: +balance })} disabled={!balance}>è¨˜éŒ²</button>
      </div>
    </div>
  );
}

function EventForm({ event, nextDate, onSubmit, onCancel }) {
  const [date, setDate] = React.useState(event?.date || nextDate || '');
  const [time, setTime] = React.useState(event?.time || '19:00');
  const [deadline, setDeadline] = React.useState(event?.deadline || '');
  const isEdit = !!event;
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>{isEdit ? 'âœ é£²ã¿ä¼šç·¨é›†' : 'ğŸ» é£²ã¿ä¼šä½œæˆ'}</h3>
      {!isEdit && nextDate && <div style={S.hint}>ğŸ’¡ ææ¡ˆæ—¥: {nextDate}</div>}
      <label style={S.label}>é–‹å‚¬æ—¥</label>
      <input type="date" value={date} onChange={e => setDate(e.target.value)} style={S.input} />
      <label style={S.label}>é–‹å§‹æ™‚é–“</label>
      <input type="time" value={time} onChange={e => setTime(e.target.value)} style={S.input} />
      <label style={S.label}>æŠ•ç¥¨ç· åˆ‡æ—¥ï¼ˆä»»æ„ï¼‰</label>
      <input type="date" value={deadline} onChange={e => setDeadline(e.target.value)} style={S.input} />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ date, time, deadline, month: date?.slice(5, 7) })} disabled={!date}>{isEdit ? 'æ›´æ–°' : 'ä½œæˆ'}</button>
      </div>
    </div>
  );
}

function ExpenseForm({ event, members, onSubmit, onCancel }) {
  const [total, setTotal] = React.useState('');
  const [perPerson, setPerPerson] = React.useState('');
  const [paidBy, setPaidBy] = React.useState('');
  const [note, setNote] = React.useState('');
  
  const yesCount = Object.values(event.attendance || {}).filter(v => v === 'yes').length;
  
  React.useEffect(() => {
    if (total && yesCount > 0) {
      setPerPerson(Math.ceil(+total / yesCount));
    }
  }, [total, yesCount]);

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’¸ ä¼šè¨ˆè¨˜éŒ²</h3>
      <div style={S.hint}>å‚åŠ è€…: {yesCount}å</div>
      <input type="number" value={total} onChange={e => setTotal(e.target.value)} style={S.input} placeholder="åˆè¨ˆé‡‘é¡(å††)" />
      <div style={S.calcResult}>ä¸€äººã‚ãŸã‚Š: Â¥{perPerson ? (+perPerson).toLocaleString() : '-'}</div>
      <select value={paidBy} onChange={e => setPaidBy(e.target.value)} style={S.input}>
        <option value="">èª°ãŒæ‰•ã£ãŸï¼Ÿ</option>
        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
      </select>
      <input type="text" value={note} onChange={e => setNote(e.target.value)} style={S.input} placeholder="ãƒ¡ãƒ¢" />
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ total: +total, perPerson: +perPerson, paidBy, note })} disabled={!total}>è¨˜éŒ²</button>
      </div>
    </div>
  );
}

function SettingsForm({ group, onSubmit, onChangePassword, onCancel }) {
  const [name, setName] = React.useState(group.name);
  const [monthlyAmount, setMonthlyAmount] = React.useState((group.monthlyAmount || 0) / 1000);
  const [savingsAmount, setSavingsAmount] = React.useState((group.savingsAmount || 0) / 1000);
  const [startMonth, setStartMonth] = React.useState(group.startMonth || '');
  const [endMonth, setEndMonth] = React.useState(group.endMonth || '');
  const [bankInfo, setBankInfo] = React.useState(group.bankInfo || '');
  const [lineUrl, setLineUrl] = React.useState(group.lineGroupUrl || '');
  const [scheduleType, setScheduleType] = React.useState(group.partySchedule?.type || 'none');
  const [dayOfWeek, setDayOfWeek] = React.useState(group.partySchedule?.dayOfWeek || 6);
  const [weekOfMonth, setWeekOfMonth] = React.useState(group.partySchedule?.weekOfMonth || 4);
  const [newPw, setNewPw] = React.useState('');
  const [showPwChange, setShowPwChange] = React.useState(false);

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>âš™ï¸ è¨­å®š</h3>
      <input type="text" value={name} onChange={e => setName(e.target.value)} style={S.input} placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" />
      
      <label style={S.label}>ğŸ’° é‡‘é¡è¨­å®š</label>
      <div style={S.row2}>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>æœ¬ä½“ï¼ˆåƒå††ï¼‰</div>
          <input type="number" value={monthlyAmount} onChange={e => setMonthlyAmount(+e.target.value)} style={S.input} placeholder="10" />
        </div>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>ç©ç«‹ï¼ˆåƒå††ï¼‰</div>
          <input type="number" value={savingsAmount} onChange={e => setSavingsAmount(+e.target.value)} style={S.input} placeholder="2" />
        </div>
      </div>
      
      <label style={S.label}>ğŸ“… æœŸé–“è¨­å®š</label>
      <div style={S.row2}>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>é–‹å§‹æœˆ</div>
          <input type="month" value={startMonth} onChange={e => setStartMonth(e.target.value)} style={S.input} />
        </div>
        <div>
          <div style={{fontSize: 12, color: '#64748b', marginBottom: 4}}>çµ‚äº†æœˆ</div>
          <input type="month" value={endMonth} onChange={e => setEndMonth(e.target.value)} style={S.input} />
        </div>
      </div>
      
      <label style={S.label}>ğŸ¦ å£åº§æƒ…å ±</label>
      <input type="text" value={bankInfo} onChange={e => setBankInfo(e.target.value)} style={S.input} placeholder="ã‚†ã†ã¡ã‚‡éŠ€è¡Œ 0520405" />
      
      <label style={S.label}>ğŸ’¬ LINEã‚°ãƒ«ãƒ¼ãƒ—URL</label>
      <input type="text" value={lineUrl} onChange={e => setLineUrl(e.target.value)} style={S.input} placeholder="https://line.me/..." />
      
      <label style={S.label}>ğŸ» å®šæœŸé–‹å‚¬è¨­å®š</label>
      <select value={scheduleType} onChange={e => setScheduleType(e.target.value)} style={S.input}>
        <option value="none">è¨­å®šãªã—</option>
        <option value="monthly">æ¯æœˆ</option>
      </select>
      {scheduleType === 'monthly' && (
        <div style={S.row2}>
          <select value={weekOfMonth} onChange={e => setWeekOfMonth(+e.target.value)} style={S.input}>
            <option value={1}>ç¬¬1</option>
            <option value={2}>ç¬¬2</option>
            <option value={3}>ç¬¬3</option>
            <option value={4}>ç¬¬4</option>
            <option value={-1}>æœ€çµ‚</option>
          </select>
          <select value={dayOfWeek} onChange={e => setDayOfWeek(+e.target.value)} style={S.input}>
            <option value={0}>æ—¥æ›œ</option>
            <option value={1}>æœˆæ›œ</option>
            <option value={2}>ç«æ›œ</option>
            <option value={3}>æ°´æ›œ</option>
            <option value={4}>æœ¨æ›œ</option>
            <option value={5}>é‡‘æ›œ</option>
            <option value={6}>åœŸæ›œ</option>
          </select>
        </div>
      )}

      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ 
          name, 
          monthlyAmount: monthlyAmount * 1000, 
          savingsAmount: savingsAmount * 1000, 
          startMonth, 
          endMonth, 
          bankInfo, 
          lineGroupUrl: lineUrl, 
          partySchedule: { type: scheduleType, dayOfWeek, weekOfMonth } 
        })}>ä¿å­˜</button>
      </div>

      <hr style={{margin: '20px 0', border: 'none', borderTop: '1px solid #e2e8f0'}} />

      {showPwChange ? (
        <>
          <input type="password" value={newPw} onChange={e => setNewPw(e.target.value)} style={S.input} placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
          <div style={S.btnRow}>
            <button style={S.cancelBtn} onClick={() => setShowPwChange(false)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style={S.submitBtn} onClick={() => { onChangePassword(newPw); setShowPwChange(false); }} disabled={!newPw}>å¤‰æ›´</button>
          </div>
        </>
      ) : (
        <button style={S.linkBtn} onClick={() => setShowPwChange(true)}>ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
      )}
    </div>
  );
}

function ExportForm({ group, getMonthList, getMemberPaymentForMonth, getMemberBalance, onCancel }) {
  const handleExport = () => {
    const months = getMonthList();
    let csv = '\uFEFF' + group.name + '\n';
    csv += `No,åå‰,${months.map(m => m.slice(5) + 'æœˆ').join(',')},æ®‹é«˜\n`;
    group.members.forEach((m, i) => {
      const bal = getMemberBalance(m.id);
      csv += `${i + 1},${m.name},${months.map(mo => { const info = getMemberPaymentForMonth(m.id, mo); return info.status === 'paid' ? 'âœ“' : info.status === 'offset' ? 'ç›¸æ®º' : ''; }).join(',')},${bal.balance / 1000}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `æ¨¡åˆ_${new Date().toISOString().slice(0, 10)}.csv`; a.click();
  };
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“Š ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>é–‰ã˜ã‚‹</button>
        <button style={S.submitBtn} onClick={handleExport}>ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>
  );
}

// ç©ç«‹é‡‘ä½¿ç”¨ãƒ•ã‚©ãƒ¼ãƒ 
function SavingsUsageForm({ group, totalSavings, onSubmit, onCancel, onCancelUsage }) {
  const [purpose, setPurpose] = React.useState('');
  const [amount, setAmount] = React.useState('');
  const usageHistory = (group.savingsUsage || []).filter(u => u.status !== 'deleted');
  
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ’ ç©ç«‹é‡‘ç®¡ç†</h3>
      
      <div style={{background: '#f0fdf4', padding: 14, borderRadius: 10, marginBottom: 16}}>
        <div style={{fontSize: 12, color: '#166534'}}>ç¾åœ¨ã®ç©ç«‹æ®‹é«˜</div>
        <div style={{fontSize: 24, fontWeight: 700, color: '#15803d'}}>Â¥{(totalSavings/1000).toFixed(0)}åƒ</div>
      </div>
      
      <label style={S.label}>ä½¿ç”¨ç›®çš„</label>
      <input type="text" value={purpose} onChange={e => setPurpose(e.target.value)} style={S.input} placeholder="ä¾‹: é£²ã¿ä¼šè£œåŠ©ã€æ™¯å“ä»£" />
      
      <label style={S.label}>é‡‘é¡ï¼ˆå††ï¼‰</label>
      <input type="number" value={amount} onChange={e => setAmount(e.target.value)} style={S.input} placeholder="ä¾‹: 10000" />
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onCancel}>é–‰ã˜ã‚‹</button>
        <button style={S.submitBtn} onClick={() => onSubmit({ purpose, amount: +amount })} disabled={!purpose || !amount || +amount > totalSavings}>ä½¿ç”¨è¨˜éŒ²</button>
      </div>
      
      {usageHistory.length > 0 && (
        <div style={{marginTop: 20}}>
          <h4 style={{fontSize: 14, fontWeight: 600, marginBottom: 10}}>ğŸ“‹ ä½¿ç”¨å±¥æ­´</h4>
          {usageHistory.map(u => (
            <div key={u.id} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: '1px solid #f1f5f9'}}>
              <div>
                <div style={{fontWeight: 600}}>{u.purpose}</div>
                <div style={{fontSize: 12, color: '#64748b'}}>{u.recordedAt?.slice(0, 10)}</div>
              </div>
              <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                <span style={{color: '#dc2626'}}>Â¥{(u.amount/1000).toFixed(0)}åƒ</span>
                <button style={S.cancelSmBtn} onClick={() => onCancelUsage(u.id)}>å–æ¶ˆ</button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function PaymentReminderModal({ group, month, status, onClose, notify, getMonthlyStatus, getMonthList }) {
  const [selectedMonth, setSelectedMonth] = React.useState(month);
  const [messageType, setMessageType] = React.useState('monthly'); // 'monthly' or 'summary'
  const appUrl = window.location.href.split('?')[0] + '?view=table';
  
  const monthList = getMonthList ? getMonthList() : [];
  const currentMonthStatus = getMonthlyStatus ? getMonthlyStatus(selectedMonth) : status;
  const monthDisplay = selectedMonth.replace('-', 'å¹´') + 'æœˆ';
  const amount = (group.monthlyAmount + group.savingsAmount).toLocaleString();
  
  // æœˆåˆ¥ã®æœªæ‰•ã„ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’å–å¾—
  const getUnpaidSummary = () => {
    if (!getMonthlyStatus || !getMonthList) return [];
    const currentMonth = new Date().toISOString().slice(0, 7);
    const pastMonths = monthList.filter(m => m <= currentMonth);
    
    const summary = [];
    pastMonths.forEach(m => {
      const st = getMonthlyStatus(m);
      if (st.unpaid.length > 0) {
        summary.push({
          month: m,
          monthDisplay: m.replace('-', 'å¹´') + 'æœˆ',
          unpaid: st.unpaid,
          count: st.unpaid.length
        });
      }
    });
    return summary.reverse(); // æ–°ã—ã„æœˆãŒä¸Š
  };
  
  const unpaidSummary = getUnpaidSummary();
  const totalUnpaidCount = unpaidSummary.reduce((sum, s) => sum + s.count, 0);
  
  // æœˆåˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const monthlyMessage = `ğŸŒº ${group.name} å…¥é‡‘ã®ãŠé¡˜ã„ ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… ${monthDisplay}åˆ†
ğŸ’° é‡‘é¡: Â¥${amount}
ğŸ¦ æŒ¯è¾¼å…ˆ: ${group.bankInfo || 'ï¼ˆè¦ç¢ºèªï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${currentMonthStatus.unpaid.length > 0 ? `â³ æœªå…¥é‡‘ã®æ–¹ï¼ˆ${currentMonthStatus.unpaid.length}åï¼‰:
${currentMonthStatus.unpaid.map(m => m.name).join('ã€')}

ãŠå¿™ã—ã„ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€
ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ğŸ™` : 'âœ… å…¨å“¡å…¥é‡‘æ¸ˆã¿ã§ã™ï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ‰'}

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  // ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå…¨æœˆåˆ†ï¼‰
  const summaryMessage = `ğŸŒº ${group.name} å…¥é‡‘çŠ¶æ³ã®ãŠçŸ¥ã‚‰ã› ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’° æœˆé¡: Â¥${amount}
ğŸ¦ æŒ¯è¾¼å…ˆ: ${group.bankInfo || 'ï¼ˆè¦ç¢ºèªï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${unpaidSummary.length > 0 ? unpaidSummary.map(s => 
`ğŸ“… ${s.monthDisplay} æœªå…¥é‡‘ï¼ˆ${s.count}åï¼‰:
${s.unpaid.map(m => `ã€€ãƒ»${m.name}`).join('\n')}`
).join('\n\n') : 'âœ… å…¨å“¡å…¨æœˆå…¥é‡‘æ¸ˆã¿ã§ã™ï¼'}

${unpaidSummary.length > 0 ? `\nãŠå¿ƒå½“ãŸã‚Šã®ã‚ã‚‹æ–¹ã¯ã€
ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ğŸ™` : ''}

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  const message = messageType === 'monthly' ? monthlyMessage : summaryMessage;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  const handleLineShare = () => {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“± å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰</h3>
      
      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ */}
      <div style={{display: 'flex', gap: 8, marginBottom: 12}}>
        <button
          onClick={() => setMessageType('monthly')}
          style={{
            flex: 1,
            padding: '10px',
            background: messageType === 'monthly' ? '#0ea5e9' : '#f1f5f9',
            color: messageType === 'monthly' ? '#fff' : '#64748b',
            border: 'none',
            borderRadius: 8,
            fontSize: 13,
            fontWeight: 600,
            cursor: 'pointer'
          }}
        >
          ğŸ“… æœˆåˆ¥é€šçŸ¥
        </button>
        <button
          onClick={() => setMessageType('summary')}
          style={{
            flex: 1,
            padding: '10px',
            background: messageType === 'summary' ? '#0ea5e9' : '#f1f5f9',
            color: messageType === 'summary' ? '#fff' : '#64748b',
            border: 'none',
            borderRadius: 8,
            fontSize: 13,
            fontWeight: 600,
            cursor: 'pointer'
          }}
        >
          ğŸ“‹ å…¨ä½“ã‚µãƒãƒªãƒ¼
        </button>
      </div>
      
      {/* æœˆåˆ¥ã®å ´åˆã¯æœˆé¸æŠ */}
      {messageType === 'monthly' && (
        <div style={{marginBottom: 12}}>
          <label style={S.label}>å¯¾è±¡æœˆ</label>
          <select 
            value={selectedMonth} 
            onChange={e => setSelectedMonth(e.target.value)} 
            style={S.input}
          >
            {monthList.filter(m => m <= new Date().toISOString().slice(0, 7)).reverse().map(m => {
              const st = getMonthlyStatus ? getMonthlyStatus(m) : { unpaid: [] };
              return (
                <option key={m} value={m}>
                  {m.replace('-', 'å¹´') + 'æœˆ'} {st.unpaid.length > 0 ? `ï¼ˆæœªæ‰•${st.unpaid.length}åï¼‰` : 'ï¼ˆå®Œäº†ï¼‰'}
                </option>
              );
            })}
          </select>
        </div>
      )}
      
      {/* æœªæ‰•ã„ã‚µãƒãƒªãƒ¼è¡¨ç¤º */}
      {messageType === 'summary' && unpaidSummary.length > 0 && (
        <div style={{background: '#fef2f2', padding: 12, borderRadius: 8, marginBottom: 12, fontSize: 13}}>
          <div style={{fontWeight: 600, color: '#dc2626', marginBottom: 8}}>
            âš ï¸ æœªæ‰•ã„çŠ¶æ³ï¼ˆ{totalUnpaidCount}ä»¶ï¼‰
          </div>
          {unpaidSummary.slice(0, 3).map(s => (
            <div key={s.month} style={{marginBottom: 4}}>
              <span style={{color: '#64748b'}}>{s.monthDisplay}:</span> {s.unpaid.map(m => m.name).join('ã€')}
            </div>
          ))}
          {unpaidSummary.length > 3 && (
            <div style={{color: '#94a3b8', fontSize: 12}}>...ä»– {unpaidSummary.length - 3}ãƒ¶æœˆ</div>
          )}
        </div>
      )}
      
      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 250, overflow: 'auto'}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        {group.lineGroupUrl ? (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleLineShare}>ğŸ’¬ LINEã§é€ã‚‹</button>
        ) : (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        )}
      </div>
      {!group.lineGroupUrl && (
        <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center', marginTop: 8}}>
          ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
        </div>
      )}
    </div>
  );
}

// å…¥é‡‘ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function PaymentThanksModal({ group, paidMembers, month, onClose, notify }) {
  const monthDisplay = month.replace('-', 'å¹´') + 'æœˆ';
  const memberNames = paidMembers.map(m => m.name).join('ã•ã‚“ã€') + 'ã•ã‚“';
  const amount = (group.monthlyAmount + group.savingsAmount).toLocaleString();
  const appUrl = window.location.href.split('?')[0] + '?view=table';
  
  const message = `ğŸŒº ${group.name} å…¥é‡‘ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… ${monthDisplay}åˆ†
ğŸ’° Â¥${amount}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${memberNames}

ã”å…¥é‡‘ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ğŸ™âœ¨

å¼•ãç¶šãã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸŒ¸

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  const handleLineShare = () => {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ‰ å…¥é‡‘ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      
      <div style={{background: '#ecfdf5', padding: 12, borderRadius: 8, marginBottom: 12, border: '2px solid #a7f3d0'}}>
        <div style={{fontWeight: 600, color: '#059669', marginBottom: 6}}>âœ… å…¥é‡‘ç¢ºèª</div>
        <div style={{fontSize: 14}}>{monthDisplay}åˆ†: {paidMembers.length}å</div>
        <div style={{fontSize: 13, color: '#64748b', marginTop: 4}}>{paidMembers.map(m => m.name).join('ã€')}</div>
      </div>
      
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 250, overflow: 'auto'}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        {group.lineGroupUrl ? (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleLineShare}>ğŸ’¬ LINEã§é€ã‚‹</button>
        ) : (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        )}
      </div>
      {!group.lineGroupUrl && (
        <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center', marginTop: 8}}>
          ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
        </div>
      )}
    </div>
  );
}

// é£²ã¿ä¼šç¢ºå®šé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function PartyConfirmedModal({ group, event, venue, onClose, notify }) {
  const att = event.attendance || {};
  const yes = Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
  const maybe = Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
  const dayOfWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(event.date).getDay()];
  const appUrl = window.location.href.split('?')[0] + '?view=party';
  
  const message = `ğŸ‰ ${group.name} é£²ã¿ä¼šæ±ºå®šï¼ ğŸ‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æ—¥æ™‚: ${event.date} (${dayOfWeek}) ${event.time || ''}ã€œ
ğŸ“ åº—èˆ—: ${venue?.name || 'æœªå®š'}
${venue?.address ? `ğŸ“® ä½æ‰€: ${venue.address}` : ''}
${venue?.url ? `ğŸ”— è©³ç´°: ${venue.url}` : ''}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… å‚åŠ ç¢ºå®š (${yes.length}å):
${yes.join('ã€') || 'ãªã—'}

${maybe.length > 0 ? `ğŸ”º æœªå®š (${maybe.length}å):\n${maybe.join('ã€')}\n\næœªå®šã®æ–¹ã¯æ—©ã‚ã«å›ç­”ãŠé¡˜ã„ã—ã¾ã™ï¼\n` : ''}
çš†ã•ã‚“ã®å‚åŠ ã‚’ãŠå¾…ã¡ã—ã¦ã¾ã™ğŸ»âœ¨

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  const handleLineShare = () => {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ‰ é£²ã¿ä¼šç¢ºå®šé€šçŸ¥</h3>
      
      <div style={{background: '#ecfdf5', padding: 12, borderRadius: 8, marginBottom: 12, border: '2px solid #a7f3d0'}}>
        <div style={{fontWeight: 600, color: '#059669', marginBottom: 6}}>âœ… äºˆç´„ç¢ºå®š</div>
        <div style={{fontSize: 14}}>{event.date} ({dayOfWeek}) {event.time || ''}</div>
        <div style={{fontSize: 14, fontWeight: 600, marginTop: 4}}>{venue?.name}</div>
        <div style={{fontSize: 13, color: '#64748b', marginTop: 4}}>å‚åŠ : {yes.length}å{maybe.length > 0 ? ` / æœªå®š: ${maybe.length}å` : ''}</div>
      </div>
      
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 250, overflow: 'auto'}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        {group.lineGroupUrl ? (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleLineShare}>ğŸ’¬ LINEã§é€ã‚‹</button>
        ) : (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        )}
      </div>
      {!group.lineGroupUrl && (
        <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center', marginTop: 8}}>
          ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
        </div>
      )}
    </div>
  );
}

// ã‚¤ãƒ™ãƒ³ãƒˆç¢ºå®šé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function EventConfirmedModal({ group, event, onClose, notify }) {
  const att = event.attendance || {};
  const yes = Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
  const maybe = Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
  const no = Object.entries(att).filter(([_, v]) => v === 'no').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
  const appUrl = window.location.href.split('?')[0] + '?view=events';
  
  const eventTypes = {
    travel: 'ğŸš— æ—…è¡Œ',
    camp: 'ğŸ•ï¸ ã‚­ãƒ£ãƒ³ãƒ—',
    bbq: 'ğŸ– BBQ',
    sports: 'âš½ ã‚¹ãƒãƒ¼ãƒ„',
    other: 'ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆ'
  };
  const typeLabel = eventTypes[event.type] || 'ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆ';
  
  const message = `ğŸŠ ${group.name} ${typeLabel}æ±ºå®šï¼ ğŸŠ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ${event.title}
${event.date ? `ğŸ“… æ—¥ç¨‹: ${event.date}` : 'ğŸ“… æ—¥ç¨‹: èª¿æ•´ä¸­'}
${event.description ? `\nğŸ“ ${event.description}` : ''}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… å‚åŠ  (${yes.length}å):
${yes.join('ã€') || 'ãªã—'}

${maybe.length > 0 ? `ğŸ”º æœªå®š (${maybe.length}å):\n${maybe.join('ã€')}\n` : ''}
${no.length > 0 ? `âŒ ä¸å‚åŠ  (${no.length}å):\n${no.join('ã€')}\n` : ''}
æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼ğŸ™Œâœ¨

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  const handleLineShare = () => {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸŠ ã‚¤ãƒ™ãƒ³ãƒˆç¢ºå®šé€šçŸ¥</h3>
      
      <div style={{background: '#f0f9ff', padding: 12, borderRadius: 8, marginBottom: 12, border: '2px solid #bae6fd'}}>
        <div style={{fontWeight: 600, color: '#0369a1', marginBottom: 6}}>{typeLabel}</div>
        <div style={{fontSize: 15, fontWeight: 600}}>{event.title}</div>
        {event.date && <div style={{fontSize: 13, color: '#64748b', marginTop: 4}}>ğŸ“… {event.date}</div>}
        <div style={{fontSize: 13, color: '#64748b', marginTop: 4}}>
          å‚åŠ : {yes.length}å / æœªå®š: {maybe.length}å / ä¸å‚åŠ : {no.length}å
        </div>
      </div>
      
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 250, overflow: 'auto'}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        {group.lineGroupUrl ? (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleLineShare}>ğŸ’¬ LINEã§é€ã‚‹</button>
        ) : (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        )}
      </div>
      {!group.lineGroupUrl && (
        <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center', marginTop: 8}}>
          ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
        </div>
      )}
    </div>
  );
}

// å—å–é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function ReceiveNotifyModal({ group, member, amount, month, baseAmount, offsetAmount, finalAmount, onClose, notify }) {
  const monthDisplay = month.replace('-', 'å¹´') + 'æœˆ';
  const appUrl = window.location.href.split('?')[0] + '?view=receive';
  
  // å—å–å±¥æ­´ã‹ã‚‰ä»Šå›ãŒä½•å›ç›®ã‹ã‚’è¨ˆç®—
  const activeReceives = (group.receives || []).filter(r => r.status !== 'deleted');
  const memberReceiveCount = activeReceives.filter(r => r.winnerId === member.id).length;
  
  // å…¨ä½“ã®å—å–çŠ¶æ³
  const totalMembers = group.members.length;
  const membersReceived = [...new Set(activeReceives.map(r => r.winnerId))].length;
  
  // ç›¸æ®ºãŒã‚ã‚‹å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const hasOffset = offsetAmount && offsetAmount > 0;
  const offsetMessage = hasOffset ? `
âš ï¸ æœªæ‰•ã„åˆ†ç›¸æ®º
ã€€ã€€åŸºæœ¬é¡: Â¥${baseAmount?.toLocaleString() || amount.toLocaleString()}
ã€€ã€€ç›¸æ®ºé¡: âˆ’Â¥${offsetAmount.toLocaleString()}
ã€€ã€€å®Ÿå—å–: Â¥${finalAmount?.toLocaleString() || amount.toLocaleString()}` : '';
  
  const message = `ğŸŠ ${group.name} å—å–ã®ãŠçŸ¥ã‚‰ã› ğŸŠ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… ${monthDisplay}
ğŸ¯ å—å–è€…: ${member.name}ã•ã‚“
ğŸ’° ${hasOffset ? 'å®Ÿå—å–é¡' : 'é‡‘é¡'}: Â¥${(finalAmount || amount).toLocaleString()}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${offsetMessage}
${member.name}ã•ã‚“ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰

ğŸ“Š å—å–çŠ¶æ³: ${membersReceived}/${totalMembers}åå®Œäº†
${memberReceiveCount > 1 ? `ï¼ˆ${member.name}ã•ã‚“ã¯${memberReceiveCount}å›ç›®ï¼‰` : ''}

æ¬¡å›ã®å—å–è€…ã‚‚ãŠæ¥½ã—ã¿ã«ï¼ğŸŒ¸

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  const handleLineShare = () => {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸŠ å—å–é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      
      <div style={{background: '#f0fdf4', padding: 12, borderRadius: 8, marginBottom: 12, border: '2px solid #bbf7d0'}}>
        <div style={{fontWeight: 600, color: '#16a34a', marginBottom: 6}}>ğŸ¯ å—å–ç¢ºå®š</div>
        <div style={{fontSize: 15, fontWeight: 600}}>{member.name}ã•ã‚“</div>
        <div style={{fontSize: 14, color: '#64748b', marginTop: 4}}>{monthDisplay}</div>
        
        {hasOffset ? (
          <div style={{marginTop: 8, padding: 8, background: '#fef3c7', borderRadius: 6}}>
            <div style={{fontSize: 12, color: '#92400e', marginBottom: 4}}>âš ï¸ æœªæ‰•ã„åˆ†ã‚’ç›¸æ®º</div>
            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: 13}}>
              <span>åŸºæœ¬é¡</span><span>Â¥{baseAmount?.toLocaleString()}</span>
            </div>
            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: 13, color: '#dc2626'}}>
              <span>ç›¸æ®º</span><span>âˆ’Â¥{offsetAmount.toLocaleString()}</span>
            </div>
            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: 14, fontWeight: 700, borderTop: '1px solid #fde68a', marginTop: 4, paddingTop: 4}}>
              <span>å®Ÿå—å–</span><span style={{color: '#16a34a'}}>Â¥{finalAmount?.toLocaleString()}</span>
            </div>
          </div>
        ) : (
          <div style={{fontSize: 14, fontWeight: 600, color: '#16a34a', marginTop: 4}}>Â¥{amount.toLocaleString()}</div>
        )}
        
        <div style={{fontSize: 13, color: '#64748b', marginTop: 8}}>
          å—å–çŠ¶æ³: {membersReceived}/{totalMembers}åå®Œäº†
        </div>
      </div>
      
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 250, overflow: 'auto'}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        {group.lineGroupUrl ? (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleLineShare}>ğŸ’¬ LINEã§é€ã‚‹</button>
        ) : (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleCopy}>ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        )}
      </div>
      {!group.lineGroupUrl && (
        <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center', marginTop: 8}}>
          ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
        </div>
      )}
    </div>
  );
}

// æ»ç´è€…å‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function DelinquentReminderModal({ group, delinquents, onClose, notify }) {
  const [messageType, setMessageType] = React.useState('all'); // 'all' or 'individual'
  const [selectedMember, setSelectedMember] = React.useState(delinquents[0]?.id || '');
  const member = delinquents.find(d => d.id === selectedMember);
  
  // å…¨ä½“ã®æœªæ‰•ã„ç·é¡
  const totalUnpaidAmount = delinquents.reduce((sum, d) => sum + d.unpaidAmount, 0);
  const totalUnpaidMonths = delinquents.reduce((sum, d) => sum + d.unpaidMonths, 0);
  const appUrl = window.location.href.split('?')[0] + '?view=table';
  
  // å…¨ä½“å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—LINEç”¨ï¼‰
  const allMessage = `ğŸŒº ${group.name} å…¥é‡‘ç¢ºèªã®ãŠé¡˜ã„ ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ æœªå…¥é‡‘çŠ¶æ³ã®ãŠçŸ¥ã‚‰ã›
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¾åœ¨ã€ä»¥ä¸‹ã®æ–¹ã«æœªå…¥é‡‘ãŒã‚ã‚Šã¾ã™ã€‚
ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ğŸ™

${delinquents.map(d => 
`ğŸ“Œ ${d.name}ã•ã‚“
ã€€ã€€${d.unpaidMonths}ãƒ¶æœˆåˆ† / Â¥${d.unpaidAmount.toLocaleString()}`
).join('\n\n')}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’° æœªå…¥é‡‘åˆè¨ˆ: Â¥${totalUnpaidAmount.toLocaleString()}
ğŸ¦ æŒ¯è¾¼å…ˆ: ${group.bankInfo || 'ï¼ˆè¦ç¢ºèªï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä½•ã‹ã”äº‹æƒ…ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€
ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}`;

  // å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const individualMessage = member ? `${member.name}ã•ã‚“

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
${group.name}ã®æ¨¡åˆã«ã¤ã„ã¦ç¢ºèªã•ã›ã¦ãã ã•ã„ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â³ æœªå…¥é‡‘: ${member.unpaidMonths}ãƒ¶æœˆåˆ†
ğŸ’° é‡‘é¡: Â¥${member.unpaidAmount.toLocaleString()}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${member.unpaidMonthsList && member.unpaidMonthsList.length > 0 ? 
`ğŸ“… å¯¾è±¡æœˆ:
${member.unpaidMonthsList.map(m => `ã€€ãƒ»${m.replace('-', 'å¹´') + 'æœˆ'}`).join('\n')}
` : ''}
ãŠå¿™ã—ã„ã¨ã“ã‚æç¸®ã§ã™ãŒã€
ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

ä½•ã‹ã”äº‹æƒ…ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€
ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ğŸ™

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¦ æŒ¯è¾¼å…ˆ: ${group.bankInfo || 'ï¼ˆè¦ç¢ºèªï¼‰'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‡ è©³ç´°ã¯ã“ã¡ã‚‰
${appUrl}` : '';

  const message = messageType === 'all' ? allMessage : individualMessage;

  const handleCopy = () => {
    navigator.clipboard?.writeText(message);
    notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  };

  const handleLineShare = () => {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(message)}`, '_blank');
  };

  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“± æ»ç´å‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
      
      {/* æœªæ‰•ã„ã‚µãƒãƒªãƒ¼è¡¨ç¤º */}
      <div style={{background: '#fef2f2', padding: 14, borderRadius: 10, marginBottom: 12, border: '2px solid #fecaca'}}>
        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10}}>
          <span style={{fontWeight: 700, color: '#dc2626', fontSize: 15}}>âš ï¸ æ»ç´çŠ¶æ³</span>
          <span style={{background: '#dc2626', color: '#fff', padding: '4px 10px', borderRadius: 12, fontSize: 13, fontWeight: 600}}>
            {delinquents.length}å / Â¥{(totalUnpaidAmount/1000).toFixed(0)}åƒ
          </span>
        </div>
        <div style={{display: 'flex', flexDirection: 'column', gap: 8}}>
          {delinquents.map(d => (
            <div key={d.id} style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 10px', background: '#fff', borderRadius: 6, border: '1px solid #fecaca'}}>
              <div>
                <span style={{fontWeight: 600}}>{d.name}</span>
                <span style={{fontSize: 12, color: '#64748b', marginLeft: 8}}>{d.unpaidMonths}ãƒ¶æœˆ</span>
              </div>
              <span style={{color: '#dc2626', fontWeight: 700}}>Â¥{d.unpaidAmount.toLocaleString()}</span>
            </div>
          ))}
        </div>
      </div>
      
      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ */}
      <div style={{display: 'flex', gap: 8, marginBottom: 12}}>
        <button
          onClick={() => setMessageType('all')}
          style={{
            flex: 1,
            padding: '10px',
            background: messageType === 'all' ? '#dc2626' : '#f1f5f9',
            color: messageType === 'all' ? '#fff' : '#64748b',
            border: 'none',
            borderRadius: 8,
            fontSize: 13,
            fontWeight: 600,
            cursor: 'pointer'
          }}
        >
          ğŸ‘¥ å…¨å“¡å‘ã‘ä¸€æ‹¬
        </button>
        <button
          onClick={() => setMessageType('individual')}
          style={{
            flex: 1,
            padding: '10px',
            background: messageType === 'individual' ? '#dc2626' : '#f1f5f9',
            color: messageType === 'individual' ? '#fff' : '#64748b',
            border: 'none',
            borderRadius: 8,
            fontSize: 13,
            fontWeight: 600,
            cursor: 'pointer'
          }}
        >
          ğŸ‘¤ å€‹åˆ¥é€ä¿¡
        </button>
      </div>
      
      {/* å€‹åˆ¥ã®å ´åˆã¯ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ */}
      {messageType === 'individual' && (
        <div style={{marginBottom: 12}}>
          <label style={S.label}>é€ä¿¡å…ˆ</label>
          <select value={selectedMember} onChange={e => setSelectedMember(e.target.value)} style={S.input}>
            {delinquents.map(d => (
              <option key={d.id} value={d.id}>
                {d.name}ï¼ˆ{d.unpaidMonths}ãƒ¶æœˆ / Â¥{d.unpaidAmount.toLocaleString()}ï¼‰
              </option>
            ))}
          </select>
        </div>
      )}
      
      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
      <div style={{background: '#f8fafc', padding: 14, borderRadius: 10, whiteSpace: 'pre-wrap', fontSize: 13, lineHeight: 1.6, maxHeight: 200, overflow: 'auto'}}>
        {message}
      </div>
      
      <div style={S.btnRow}>
        <button style={S.cancelBtn} onClick={onClose}>é–‰ã˜ã‚‹</button>
        {group.lineGroupUrl && messageType === 'all' ? (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={handleLineShare}>ğŸ’¬ LINEã§é€ã‚‹</button>
        ) : (
          <button style={{...S.submitBtn, background: '#06c755'}} onClick={messageType === 'all' ? handleCopy : handleLineShare}>
            {messageType === 'all' ? 'ğŸ“‹ ã‚³ãƒ”ãƒ¼' : 'ğŸ’¬ LINEã§é€ã‚‹'}
          </button>
        )}
      </div>
      <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center', marginTop: 8}}>
        {messageType === 'all' 
          ? (group.lineGroupUrl ? 'ğŸ’¡ ã‚°ãƒ«ãƒ¼ãƒ—LINEã«ä¸€æ‹¬é€ä¿¡ã•ã‚Œã¾ã™' : 'ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™')
          : 'ğŸ’¡ å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ - LINEé€ä¿¡ç”»é¢ã§é€ã‚Šå…ˆã‚’é¸æŠã—ã¦ãã ã•ã„'}
      </div>
    </div>
  );
}

// å—å–é †ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
function ReceiveOrderModal({ group, receiveOrder, onClose }) {
  return (
    <div style={S.form}>
      <h3 style={S.formTitle}>ğŸ“‹ å—å–é †ä¸€è¦§</h3>
      <div style={{fontSize: 13, color: '#64748b', marginBottom: 12}}>
        ãƒ¡ãƒ³ãƒãƒ¼é †ã§å—å–ã—ãŸå ´åˆã®é †ç•ªã§ã™
      </div>
      
      <div style={{maxHeight: 400, overflow: 'auto'}}>
        {receiveOrder.map((item, i) => (
          <div key={i} style={{
            display: 'flex', 
            alignItems: 'center', 
            padding: '12px', 
            marginBottom: 8, 
            borderRadius: 10,
            background: item.status === 'done' ? '#d1fae5' : '#f8fafc',
            border: item.status === 'done' ? '2px solid #10b981' : '2px solid #e2e8f0'
          }}>
            <div style={{
              width: 32, 
              height: 32, 
              borderRadius: '50%', 
              background: item.status === 'done' ? '#10b981' : '#0ea5e9', 
              color: '#fff', 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center', 
              fontWeight: 700,
              marginRight: 12
            }}>
              {item.order}
            </div>
            <div style={{flex: 1}}>
              <div style={{fontWeight: 600}}>{item.member?.name}</div>
              {item.status === 'done' && (
                <div style={{fontSize: 12, color: '#059669'}}>{item.month} Â¥{(item.amount/1000).toFixed(0)}åƒ</div>
              )}
            </div>
            <div style={{
              padding: '4px 10px', 
              borderRadius: 6, 
              fontSize: 12, 
              fontWeight: 600,
              background: item.status === 'done' ? '#059669' : '#e2e8f0',
              color: item.status === 'done' ? '#fff' : '#64748b'
            }}>
              {item.status === 'done' ? 'âœ“ å—å–æ¸ˆ' : 'å¾…ã¡'}
            </div>
          </div>
        ))}
      </div>
      
      <button style={{...S.cancelBtn, width: '100%', marginTop: 12}} onClick={onClose}>é–‰ã˜ã‚‹</button>
    </div>
  );
}

// ãƒ˜ãƒ«ãƒ—ãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”»é¢
function HelpView({ isAdmin, group }) {
  const APP_VERSION = '4.0';
  const LAST_UPDATE = '2025å¹´1æœˆ';
  const [showMemberGuide, setShowMemberGuide] = React.useState(false);
  const [showAdminManual, setShowAdminManual] = React.useState(false);
  const [expandedSection, setExpandedSection] = React.useState(null);
  
  // PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
  const downloadPDF = async (type) => {
    if (!window.jspdf) {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      document.head.appendChild(script);
      await new Promise(resolve => script.onload = resolve);
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(24);
    doc.setTextColor(30, 41, 59);
    doc.text('MOAI App', 105, 30, { align: 'center' });
    doc.setFontSize(18);
    doc.text(type === 'member' ? 'Member Guide' : 'Admin Manual', 105, 45, { align: 'center' });
    doc.setFontSize(12);
    doc.setTextColor(100, 116, 139);
    doc.text(`Version ${APP_VERSION} | ${LAST_UPDATE}`, 105, 60, { align: 'center' });
    
    doc.save(type === 'member' ? 'moai_member_guide.pdf' : 'moai_admin_manual.pdf');
  };

  // ãƒ¡ãƒ³ãƒãƒ¼ç”¨ã‚¬ã‚¤ãƒ‰ã®å†…å®¹
  const MemberGuideContent = () => (
    <div style={{background: '#fff', borderRadius: 12, overflow: 'hidden'}}>
      {/* åŸºæœ¬ã®ä½¿ã„æ–¹ */}
      <Section title="ğŸ“± åŸºæœ¬ã®ä½¿ã„æ–¹" defaultOpen={true}>
        <div style={styles.table}>
          <div style={styles.tableRow}><span style={styles.tableIcon}>ğŸ </span><span style={styles.tableLabel}>ãƒ›ãƒ¼ãƒ </span><span style={styles.tableDesc}>å…¨ä½“ã®çŠ¶æ³ã€æ¬¡å›é£²ã¿ä¼šäºˆå®š</span></div>
          <div style={styles.tableRow}><span style={styles.tableIcon}>ğŸ»</span><span style={styles.tableLabel}>é£²ã¿ä¼š</span><span style={styles.tableDesc}>å‡ºæ¬ å›ç­”ã€åº—èˆ—æŠ•ç¥¨</span></div>
          <div style={styles.tableRow}><span style={styles.tableIcon}>ğŸª</span><span style={styles.tableLabel}>ã‚¤ãƒ™ãƒ³ãƒˆ</span><span style={styles.tableDesc}>æ—…è¡Œãƒ»ã‚­ãƒ£ãƒ³ãƒ—ç­‰ã®å‡ºæ¬ </span></div>
          <div style={styles.tableRow}><span style={styles.tableIcon}>ğŸ‘¥</span><span style={styles.tableLabel}>ãƒ¡ãƒ³ãƒãƒ¼</span><span style={styles.tableDesc}>ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã€å…¥é‡‘çŠ¶æ³</span></div>
          <div style={styles.tableRow}><span style={styles.tableIcon}>ğŸ“Š</span><span style={styles.tableLabel}>ä¸€è¦§</span><span style={styles.tableDesc}>å…¨å“¡ã®å…¥é‡‘ãƒ»å—å–çŠ¶æ³</span></div>
        </div>
      </Section>
      
      {/* é£²ã¿ä¼šã®å‡ºæ¬ å›ç­” */}
      <Section title="ğŸ» é£²ã¿ä¼šã®å‡ºæ¬ å›ç­”">
        <ol style={styles.ol}>
          <li>ã€ŒğŸ» é£²ã¿ä¼šã€ã‚¿ãƒ–ã‚’é–‹ã</li>
          <li>è‡ªåˆ†ã®åå‰ã‚’é¸æŠ</li>
          <li>â­•ï¼ˆå‚åŠ ï¼‰/ ğŸ”ºï¼ˆæœªå®šï¼‰/ âŒï¼ˆä¸å‚åŠ ï¼‰ã‚’ã‚¿ãƒƒãƒ—</li>
          <li>è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼</li>
        </ol>
        <div style={styles.tip}>ğŸ’¡ ç· åˆ‡æ—¥ã¾ã§ã«å›ç­”ã—ã¦ãã ã•ã„</div>
      </Section>
      
      {/* åº—èˆ—ã®è¿½åŠ  */}
      <Section title="ğŸ® åº—èˆ—ã®è¿½åŠ ãƒ»å€™è£œãƒªã‚¹ãƒˆ">
        <p style={styles.p}>èª°ã§ã‚‚åº—èˆ—ã®è¿½åŠ ãƒ»å‰Šé™¤ãŒã§ãã¾ã™ã€‚</p>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ </div>
          <ol style={styles.ol}>
            <li>ã€ŒğŸ» é£²ã¿ä¼šã€â†’ã€Œï¼‹ åº—èˆ—ã‚’è¿½åŠ ã€</li>
            <li>åº—èˆ—åãƒ»URLãªã©ã‚’å…¥åŠ›</li>
            <li>ç™»éŒ²ã™ã‚‹ã¨å€™è£œãƒªã‚¹ãƒˆã«ã‚‚è‡ªå‹•ä¿å­˜</li>
          </ol>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>å€™è£œãƒªã‚¹ãƒˆã‹ã‚‰è¿½åŠ </div>
          <ol style={styles.ol}>
            <li>ã€ŒğŸ“‹ å€™è£œåº—èˆ—ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶ã€ã‚’ã‚¿ãƒƒãƒ—</li>
            <li>éå»ã«ç™»éŒ²ã—ãŸåº—èˆ—ã‚’é¸æŠ</li>
            <li>ä¸è¦ãªåº—èˆ—ã¯ã€Œå‰Šé™¤ã€ã§æ¶ˆã›ã¾ã™</li>
          </ol>
        </div>
      </Section>
      
      {/* ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¬  */}
      <Section title="ğŸª ã‚¤ãƒ™ãƒ³ãƒˆã®å‡ºæ¬ å›ç­”">
        <p style={styles.p}>æ—…è¡Œãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãƒ»BBQãªã©ã®å‡ºæ¬ ç¢ºèª</p>
        <ol style={styles.ol}>
          <li>ã€ŒğŸª ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚¿ãƒ–ã‚’é–‹ã</li>
          <li>è‡ªåˆ†ã®åå‰ã‚’é¸æŠ</li>
          <li>â­•ï¼ˆå‚åŠ ï¼‰/ ğŸ”ºï¼ˆæœªå®šï¼‰/ âŒï¼ˆä¸å‚åŠ ï¼‰ã‚’ã‚¿ãƒƒãƒ—</li>
        </ol>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>éå»ã‚¤ãƒ™ãƒ³ãƒˆã®ç¢ºèª</div>
          <p style={styles.p}>ã€ŒğŸ“ éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€è©³ç´°ã‚„å‚åŠ è€…ãŒç¢ºèªã§ãã¾ã™ã€‚</p>
        </div>
      </Section>
      
      {/* å…¥é‡‘çŠ¶æ³ã®ç¢ºèª */}
      <Section title="ğŸ’° å…¥é‡‘çŠ¶æ³ã®ç¢ºèª">
        <div style={styles.table}>
          <div style={styles.tableRow}><span style={{...styles.tableIcon, background: '#d1fae5'}}>âœ…</span><span style={styles.tableLabel}>ç·‘</span><span style={styles.tableDesc}>æ”¯æ‰•æ¸ˆã¿</span></div>
          <div style={styles.tableRow}><span style={{...styles.tableIcon, background: '#fee2e2'}}>ã€€</span><span style={styles.tableLabel}>èµ¤</span><span style={styles.tableDesc}>æœªæ‰•ã„</span></div>
          <div style={styles.tableRow}><span style={{...styles.tableIcon, background: '#fef3c7'}}>ç›¸</span><span style={styles.tableLabel}>é»„</span><span style={styles.tableDesc}>å—å–é‡‘ã‹ã‚‰ç›¸æ®º</span></div>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ä¸€è¦§è¡¨ã®LINEå…±æœ‰</div>
          <p style={styles.p}>ã€ŒğŸ“Š ä¸€è¦§ã€ã‚¿ãƒ–ã®ğŸ“±ãƒœã‚¿ãƒ³ã§ã€é–‹å§‹æœˆã‹ã‚‰å½“æœˆã¾ã§ã®å…¥é‡‘çŠ¶æ³ã‚’LINEã§å…±æœ‰ã§ãã¾ã™ã€‚</p>
        </div>
      </Section>
      
      {/* å‚åŠ ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° */}
      <Section title="ğŸ† å‚åŠ ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°">
        <p style={styles.p}>ãƒ›ãƒ¼ãƒ ç”»é¢ã®ä¸‹éƒ¨ã«é£²ã¿ä¼šå‚åŠ ç‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        <ul style={styles.ul}>
          <li>ğŸ‘‘ çš†å‹¤è³: å…¨ã¦ã®é£²ã¿ä¼šã«å‚åŠ ã—ãŸäºº</li>
          <li>ğŸ¥‡ğŸ¥ˆğŸ¥‰ ä¸Šä½3åã«ãƒ¡ãƒ€ãƒ«è¡¨ç¤º</li>
          <li>å‚åŠ ç‡ãŒé«˜ã„ã¨å°è±¡ã‚¢ãƒƒãƒ—ï¼</li>
        </ul>
      </Section>
      
      {/* ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  */}
      <Section title="ğŸ“² ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ">
        <div style={styles.subSection}>
          <div style={styles.subTitle}>iPhoneã®å ´åˆ</div>
          <ol style={styles.ol}>
            <li>Safariã§ã‚¢ãƒ—ãƒªã‚’é–‹ã</li>
            <li>ç”»é¢ä¸‹ã®å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ¬†ï¼‰ã‚’ã‚¿ãƒƒãƒ—</li>
            <li>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ</li>
            <li>ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—</li>
          </ol>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>Androidã®å ´åˆ</div>
          <ol style={styles.ol}>
            <li>Chromeã§ã‚¢ãƒ—ãƒªã‚’é–‹ã</li>
            <li>ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ãƒãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã‚¿ãƒƒãƒ—</li>
          </ol>
        </div>
      </Section>
    </div>
  );

  // ç®¡ç†è€…ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®å†…å®¹
  const AdminManualContent = () => (
    <div style={{background: '#fff', borderRadius: 12, overflow: 'hidden'}}>
      {/* ãƒ­ã‚°ã‚¤ãƒ³ */}
      <Section title="ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•" defaultOpen={true}>
        <ol style={styles.ol}>
          <li>å³ä¸Šã®ã€ŒğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
          <li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆåˆæœŸ: 1234ï¼‰</li>
          <li>ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’ã‚¿ãƒƒãƒ—</li>
          <li>ã€ŒğŸ‘‘ç®¡ç†è€…ã€ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸï¼</li>
        </ol>
        <div style={styles.tip}>ğŸ’¡ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¨­å®šç”»é¢ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™</div>
      </Section>
      
      {/* å…¥é‡‘ç®¡ç† */}
      <Section title="ğŸ’° å…¥é‡‘ç®¡ç†">
        <div style={styles.subSection}>
          <div style={styles.subTitle}>é€šå¸¸ã®å…¥é‡‘è¨˜éŒ²</div>
          <ol style={styles.ol}>
            <li>ã€Œâœ… å…¥é‡‘ã€ã‚¿ãƒ–ã‚’é–‹ã</li>
            <li>å¯¾è±¡æœˆã‚’é¸æŠ</li>
            <li>ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</li>
            <li>ã€Œå…¥é‡‘ã‚’è¨˜éŒ²ã€ã‚’ã‚¿ãƒƒãƒ—</li>
            <li>ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’LINEã§é€ä¿¡</li>
          </ol>
        </div>
        <div style={styles.subSection}>
          <div style={{...styles.subTitle, color: '#0ea5e9'}}>ğŸ†• è¤‡æ•°æœˆã¾ã¨ã‚ã¦å…¥é‡‘ï¼ˆå°å…¥æ™‚ã«ä¾¿åˆ©ï¼ï¼‰</div>
          <ol style={styles.ol}>
            <li>ã€ŒğŸ“… è¤‡æ•°æœˆã¾ã¨ã‚ã¦å…¥é‡‘ã€ã‚’ON</li>
            <li>é–‹å§‹æœˆã€œçµ‚äº†æœˆã‚’é¸æŠ</li>
            <li>ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</li>
            <li>ä¸€æ‹¬ã§è¨˜éŒ²ï¼</li>
          </ol>
          <div style={styles.tip}>ğŸ’¡ éå»1å¹´åˆ†ã‚’ä¸€åº¦ã«å…¥åŠ›ã§ãã¾ã™</div>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ğŸ‰ å…¥é‡‘ãŠç¤¼é€šçŸ¥</div>
          <p style={styles.p}>å…¥é‡‘è¨˜éŒ²å¾Œã«è‡ªå‹•ã§ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã€LINEã§é€ä¿¡ã§ãã¾ã™ã€‚</p>
        </div>
      </Section>
      
      {/* å—å–ç®¡ç† */}
      <Section title="ğŸ¯ å—å–ç®¡ç†">
        <div style={styles.table}>
          <div style={styles.tableRow}><span style={styles.tableLabel}>é †ç•ªåˆ¶</span><span style={styles.tableDesc}>ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆé †ã«è‡ªå‹•ã§æ¬¡ã®å—å–è€…ã‚’è¡¨ç¤º</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>æŠ½é¸åˆ¶</span><span style={styles.tableDesc}>æœªå—å–è€…ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸å‡º</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>å¸Œæœ›å„ªå…ˆ</span><span style={styles.tableDesc}>å—å–å¸Œæœ›ã‚’å‡ºã—ãŸäººã‚’å„ªå…ˆã—ã¦æŠ½é¸</span></div>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ğŸŠ å—å–é€šçŸ¥</div>
          <p style={styles.p}>å—å–è¨˜éŒ²å¾Œã«è‡ªå‹•ã§ãŠç¥ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã€LINEã§é€ä¿¡ã§ãã¾ã™ã€‚å—å–çŠ¶æ³ï¼ˆä½•åå®Œäº†ã‹ï¼‰ã‚‚å«ã¾ã‚Œã¾ã™ã€‚</p>
        </div>
      </Section>
      
      {/* é£²ã¿ä¼šç®¡ç† */}
      <Section title="ğŸ» é£²ã¿ä¼šç®¡ç†">
        <ol style={styles.ol}>
          <li>é£²ã¿ä¼šã‚’ä½œæˆï¼ˆæ—¥æ™‚ãƒ»ç· åˆ‡ã‚’è¨­å®šï¼‰</li>
          <li>ãƒ¡ãƒ³ãƒãƒ¼ãŒå‡ºæ¬ ã‚’æŠ•ç¥¨</li>
          <li>å€™è£œåº—èˆ—ã‚’è¿½åŠ ï¼ˆèª°ã§ã‚‚å¯ï¼‰</li>
          <li>ãƒ¡ãƒ³ãƒãƒ¼ãŒåº—èˆ—ã«æŠ•ç¥¨</li>
          <li>å¹¹äº‹ãŒåº—èˆ—ã‚’ç¢ºå®š â†’ ç¢ºå®šé€šçŸ¥ã‚’LINEé€ä¿¡</li>
          <li>é–‹å‚¬å¾Œã€çµŒè²»ã‚’è¨˜éŒ²</li>
          <li>é£²ã¿ä¼šã‚’å®Œäº†ã«ã™ã‚‹</li>
        </ol>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ğŸ® å€™è£œåº—èˆ—ãƒªã‚¹ãƒˆ</div>
          <p style={styles.p}>åº—èˆ—ã‚’è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•çš„ã«å€™è£œãƒªã‚¹ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚æ¬¡å›ä»¥é™ã¯ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã‚“ã§è¿½åŠ ã§ãã¾ã™ã€‚</p>
        </div>
      </Section>
      
      {/* ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç† */}
      <Section title="ğŸª ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ï¼ˆæ—…è¡Œãƒ»ã‚­ãƒ£ãƒ³ãƒ—ç­‰ï¼‰">
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</div>
          <ol style={styles.ol}>
            <li>ã€ŒğŸª ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚¿ãƒ–ã‚’é–‹ã</li>
            <li>ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã§ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</li>
            <li>ç¨®é¡ï¼ˆæ—…è¡Œ/ã‚­ãƒ£ãƒ³ãƒ—/BBQç­‰ï¼‰ã‚’é¸æŠ</li>
            <li>ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ—¥ç¨‹ãƒ»ç· åˆ‡ã‚’å…¥åŠ›</li>
          </ol>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ç· ã‚åˆ‡ã‚Šãƒ»ç¢ºå®šé€šçŸ¥</div>
          <ul style={styles.ul}>
            <li>ã€ŒğŸ”’ ç· ã‚åˆ‡ã‚‹ã€ã§æŠ•ç¥¨çµ‚äº† â†’ ç¢ºå®šé€šçŸ¥ã‚’LINEé€ä¿¡</li>
            <li>å‚åŠ è€…ãƒ»æœªå®šãƒ»ä¸å‚åŠ ã®ä¸€è¦§ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¾ã™</li>
            <li>é–“é•ãˆãŸå ´åˆã¯ã€ŒğŸ“ éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã€ã‹ã‚‰å†é–‹å¯èƒ½</li>
          </ul>
        </div>
      </Section>
      
      {/* ç©ç«‹é‡‘ç®¡ç† */}
      <Section title="ğŸ’ ç©ç«‹é‡‘ç®¡ç†">
        <ol style={styles.ol}>
          <li>ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã€ŒğŸ’ç©ç«‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
          <li>ä½¿ç”¨ç›®çš„ã‚’å…¥åŠ›ï¼ˆä¾‹: å¿˜å¹´ä¼šè£œåŠ©ï¼‰</li>
          <li>é‡‘é¡ã‚’å…¥åŠ›</li>
          <li>ã€Œä½¿ç”¨ã™ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—</li>
        </ol>
        <div style={styles.warning}>âš ï¸ ä½¿ç”¨å±¥æ­´ã¯å…¨ãƒ¡ãƒ³ãƒãƒ¼ã«å…¬é–‹ã•ã‚Œã¾ã™</div>
      </Section>
      
      {/* è¨­å®šå¤‰æ›´ */}
      <Section title="âš™ï¸ è¨­å®šå¤‰æ›´">
        <p style={styles.p}>ç”»é¢å³ä¸‹ã®ã€Œâš™ï¸ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šç”»é¢ã‚’é–‹ã‘ã¾ã™ã€‚</p>
        <div style={styles.table}>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ã‚°ãƒ«ãƒ¼ãƒ—å</span><span style={styles.tableDesc}>æ¨¡åˆã®åå‰ã‚’å¤‰æ›´</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>æœˆé¡</span><span style={styles.tableDesc}>æ¯æœˆã®æ”¯æ‰•é¡</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ç©ç«‹é¡</span><span style={styles.tableDesc}>æ¯æœˆã®ç©ç«‹é‡‘é¡</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>é–‹å‚¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span><span style={styles.tableDesc}>ç¬¬Né€±ã®Xæ›œæ—¥ã‚’è‡ªå‹•ææ¡ˆ</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span><span style={styles.tableDesc}>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</span></div>
        </div>
      </Section>
      
      {/* LINEé€šçŸ¥ */}
      <Section title="ğŸ“± LINEé€šçŸ¥æ©Ÿèƒ½">
        <p style={styles.p}>LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’è¨­å®šã™ã‚‹ã¨ã€ãƒœã‚¿ãƒ³1ã¤ã§ç›´æ¥é€ä¿¡ã§ãã¾ã™ã€‚</p>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>å…¥é‡‘ãƒªãƒã‚¤ãƒ³ãƒ‰</div>
          <ul style={styles.ul}>
            <li>ã€ŒğŸ“… æœˆåˆ¥é€šçŸ¥ã€: ç‰¹å®šæœˆã®æœªæ‰•ã„è€…ã«é€šçŸ¥</li>
            <li>ã€ŒğŸ“‹ å…¨ä½“ã‚µãƒãƒªãƒ¼ã€: å…¨æœˆã®æœªæ‰•ã„çŠ¶æ³ã‚’ä¸€è¦§é€ä¿¡</li>
          </ul>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>æ»ç´å‚¬ä¿ƒ</div>
          <ul style={styles.ul}>
            <li>ãƒ›ãƒ¼ãƒ ç”»é¢ or å…¥é‡‘ç”»é¢ã‹ã‚‰ã€ŒğŸ“± LINEå‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€</li>
            <li>ã€ŒğŸ‘¥ å…¨å“¡å‘ã‘ä¸€æ‹¬ã€: æ»ç´è€…å…¨å“¡ã®åå‰ãƒ»é‡‘é¡ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«é€ä¿¡</li>
            <li>ã€ŒğŸ‘¤ å€‹åˆ¥é€ä¿¡ã€: ç‰¹å®šã®äººã«å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</li>
            <li>å„ãƒ¡ãƒ³ãƒãƒ¼ã®æ»ç´æœˆæ•°ãƒ»ç´¯è¨ˆé‡‘é¡ã‚’è¡¨ç¤º</li>
          </ul>
        </div>
        <div style={styles.subSection}>
          <div style={styles.subTitle}>ãã®ä»–ã®é€šçŸ¥</div>
          <ul style={styles.ul}>
            <li>é£²ã¿ä¼šãŠçŸ¥ã‚‰ã›: æ—¥æ™‚ãƒ»å ´æ‰€ãƒ»å‚åŠ è€…</li>
            <li>ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¬ : æ—…è¡Œç­‰ã®å‡ºæ¬ ç¢ºèª</li>
          </ul>
        </div>
        <div style={styles.tip}>ğŸ’¡ è¨­å®šç”»é¢ã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
      </Section>
      
      {/* ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° */}
      <Section title="ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°">
        <div style={styles.table}>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„</span><span style={styles.tableDesc}>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèª</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸ</span><span style={styles.tableDesc}>å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>å…¥é‡‘ã‚’é–“é•ãˆãŸ</span><span style={styles.tableDesc}>å±¥æ­´ç”»é¢ã‹ã‚‰ã€Œå–æ¶ˆã€</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ã‚¤ãƒ™ãƒ³ãƒˆèª¤ç· åˆ‡</span><span style={styles.tableDesc}>éå»ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã€Œå†é–‹ã€</span></div>
          <div style={styles.tableRow}><span style={styles.tableLabel}>ç”»é¢ãŒçœŸã£ç™½</span><span style={styles.tableDesc}>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°</span></div>
        </div>
      </Section>
    </div>
  );

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  function Section({ title, children, defaultOpen = false }) {
    const [isOpen, setIsOpen] = React.useState(defaultOpen);
    return (
      <div style={{borderBottom: '1px solid #e2e8f0'}}>
        <button 
          onClick={() => setIsOpen(!isOpen)}
          style={{
            width: '100%',
            padding: '14px 16px',
            background: isOpen ? '#f8fafc' : '#fff',
            border: 'none',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            cursor: 'pointer',
            fontSize: 14,
            fontWeight: 600,
            color: '#334155'
          }}
        >
          <span>{title}</span>
          <span style={{color: '#94a3b8', transition: 'transform 0.2s', transform: isOpen ? 'rotate(180deg)' : 'rotate(0)'}}></span>
        </button>
        {isOpen && (
          <div style={{padding: '0 16px 16px 16px'}}>
            {children}
          </div>
        )}
      </div>
    );
  }

  // ã‚¹ã‚¿ã‚¤ãƒ«
  const styles = {
    ol: { margin: 0, paddingLeft: 20, color: '#64748b', fontSize: 13, lineHeight: 2 },
    ul: { margin: 0, paddingLeft: 20, color: '#64748b', fontSize: 13, lineHeight: 2, listStyle: 'disc' },
    p: { margin: '0 0 10px 0', color: '#64748b', fontSize: 13, lineHeight: 1.6 },
    tip: { background: '#ecfdf5', color: '#065f46', padding: '10px 12px', borderRadius: 8, fontSize: 12, marginTop: 10 },
    warning: { background: '#fef3c7', color: '#92400e', padding: '10px 12px', borderRadius: 8, fontSize: 12, marginTop: 10 },
    table: { display: 'flex', flexDirection: 'column', gap: 8 },
    tableRow: { display: 'flex', alignItems: 'center', gap: 10, fontSize: 13 },
    tableIcon: { width: 28, height: 28, borderRadius: 6, display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#f1f5f9', fontSize: 14 },
    tableLabel: { fontWeight: 600, color: '#334155', minWidth: 80 },
    tableDesc: { color: '#64748b', flex: 1 },
    subSection: { marginBottom: 16 },
    subTitle: { fontWeight: 600, color: '#334155', marginBottom: 8, fontSize: 13 },
  };

  return (
    <div style={S.view}>
      <h3 style={S.viewTitle}>â“ ãƒ˜ãƒ«ãƒ—ãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>
      
      {/* ã‚¢ãƒ—ãƒªæƒ…å ± */}
      <div style={{...S.card, background: 'linear-gradient(135deg, #1e293b, #334155)', color: '#fff'}}>
        <div style={{display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12}}>
          <svg width="48" height="48" viewBox="0 0 100 100">
            <defs>
              <linearGradient id="helpIconBg" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style={{stopColor:'#6b7280'}} />
                <stop offset="10%" style={{stopColor:'#374151'}} />
                <stop offset="90%" style={{stopColor:'#111827'}} />
                <stop offset="100%" style={{stopColor:'#1f2937'}} />
              </linearGradient>
            </defs>
            <rect width="100" height="100" rx="22" fill="url(#helpIconBg)"/>
            <rect x="10" y="8" width="80" height="3" rx="1.5" fill="rgba(255,255,255,0.5)"/>
            <text x="50" y="72" textAnchor="middle" fontSize="65" fontWeight="900" fill="white" fontFamily="sans-serif">ãƒ¢</text>
          </svg>
          <div>
            <div style={{fontSize: 18, fontWeight: 700}}>æ¨¡åˆã‚¢ãƒ—ãƒª</div>
            <div style={{fontSize: 13, color: '#94a3b8'}}>Version {APP_VERSION}</div>
          </div>
        </div>
        <div style={{fontSize: 12, color: '#94a3b8'}}>
          æœ€çµ‚æ›´æ–°: {LAST_UPDATE}
        </div>
      </div>
      
      {/* ãƒ¡ãƒ³ãƒãƒ¼ç”¨ã‚¬ã‚¤ãƒ‰ */}
      <div style={S.card}>
        <button 
          onClick={() => setShowMemberGuide(!showMemberGuide)}
          style={{
            width: '100%',
            padding: 16,
            background: showMemberGuide ? '#0ea5e9' : '#f0f9ff',
            border: '2px solid #0ea5e9',
            borderRadius: 12,
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: 12
          }}
        >
          <span style={{fontSize: 28}}>ğŸ“˜</span>
          <div style={{textAlign: 'left', flex: 1}}>
            <div style={{fontWeight: 700, color: showMemberGuide ? '#fff' : '#0369a1', fontSize: 15}}>ãƒ¡ãƒ³ãƒãƒ¼ç”¨ã‚¬ã‚¤ãƒ‰</div>
            <div style={{fontSize: 12, color: showMemberGuide ? '#bae6fd' : '#64748b'}}>åŸºæœ¬çš„ãªä½¿ã„æ–¹ãƒ»å‡ºæ¬ å›ç­”ã®æ–¹æ³•</div>
          </div>
          <span style={{color: showMemberGuide ? '#fff' : '#0ea5e9', fontSize: 20}}>{showMemberGuide ? 'â–²' : 'â–¼'}</span>
        </button>
        
        {showMemberGuide && (
          <div style={{marginTop: 12}}>
            <MemberGuideContent />
            <button 
              onClick={() => downloadPDF('member')}
              style={{
                width: '100%',
                marginTop: 12,
                padding: '12px',
                background: '#f1f5f9',
                border: '1px solid #cbd5e1',
                borderRadius: 8,
                cursor: 'pointer',
                fontSize: 13,
                color: '#64748b'
              }}
            >
              ğŸ“¥ PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
          </div>
        )}
      </div>
      
      {/* ç®¡ç†è€…ãƒãƒ‹ãƒ¥ã‚¢ãƒ« */}
      <div style={S.card}>
        {isAdmin ? (
          <>
            <button 
              onClick={() => setShowAdminManual(!showAdminManual)}
              style={{
                width: '100%',
                padding: 16,
                background: showAdminManual ? '#f59e0b' : 'linear-gradient(135deg, #fef3c7, #fde68a)',
                border: '2px solid #f59e0b',
                borderRadius: 12,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: 12
              }}
            >
              <span style={{fontSize: 28}}>ğŸ“™</span>
              <div style={{textAlign: 'left', flex: 1}}>
                <div style={{fontWeight: 700, color: showAdminManual ? '#fff' : '#92400e', fontSize: 15}}>ğŸ‘‘ ç®¡ç†è€…ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
                <div style={{fontSize: 12, color: showAdminManual ? '#fef3c7' : '#a16207'}}>å…¥é‡‘ç®¡ç†ãƒ»é£²ã¿ä¼šä½œæˆãƒ»è¨­å®šå¤‰æ›´</div>
              </div>
              <span style={{color: showAdminManual ? '#fff' : '#92400e', fontSize: 20}}>{showAdminManual ? 'â–²' : 'â–¼'}</span>
            </button>
            
            {showAdminManual && (
              <div style={{marginTop: 12}}>
                <AdminManualContent />
                <button 
                  onClick={() => downloadPDF('admin')}
                  style={{
                    width: '100%',
                    marginTop: 12,
                    padding: '12px',
                    background: '#fef3c7',
                    border: '1px solid #f59e0b',
                    borderRadius: 8,
                    cursor: 'pointer',
                    fontSize: 13,
                    color: '#92400e'
                  }}
                >
                  ğŸ“¥ PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
              </div>
            )}
          </>
        ) : (
          <div style={{
            width: '100%',
            padding: 16,
            background: '#f1f5f9',
            border: '2px dashed #cbd5e1',
            borderRadius: 12,
            display: 'flex',
            alignItems: 'center',
            gap: 12,
            opacity: 0.7
          }}>
            <span style={{fontSize: 28}}>ğŸ”’</span>
            <div style={{textAlign: 'left', flex: 1}}>
              <div style={{fontWeight: 700, color: '#64748b', fontSize: 15}}>ç®¡ç†è€…ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
              <div style={{fontSize: 12, color: '#94a3b8'}}>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«é–²è¦§ã§ãã¾ã™</div>
            </div>
          </div>
        )}
      </div>
      
      {/* ã‚ˆãã‚ã‚‹è³ªå• */}
      <div style={S.card}>
        <h4 style={S.subTitle}>â” ã‚ˆãã‚ã‚‹è³ªå•</h4>
        
        {[
          { q: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ', a: 'å¹¹äº‹ã«é€£çµ¡ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„' },
          { q: 'å…¥é‡‘ã—ãŸã®ã«æœªæ‰•ã„ã«ãªã£ã¦ã„ã‚‹', a: 'å¹¹äº‹ã«é€£çµ¡ã—ã¦å…¥é‡‘è¨˜éŒ²ã‚’ç¢ºèªã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„' },
          { q: 'ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸ', a: 'ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„' },
        ].map((item, i) => (
          <div key={i} style={{marginBottom: i < 2 ? 14 : 0, paddingBottom: i < 2 ? 14 : 0, borderBottom: i < 2 ? '1px solid #e2e8f0' : 'none'}}>
            <div style={{fontWeight: 600, color: '#334155', marginBottom: 4}}>Q. {item.q}</div>
            <div style={{color: '#64748b', fontSize: 13}}>A. {item.a}</div>
          </div>
        ))}
      </div>
      
      {/* ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ± */}
      <div style={{...S.card, background: '#f8fafc'}}>
        <h4 style={S.subTitle}>ğŸ“‹ ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±</h4>
        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, fontSize: 13}}>
          <div><span style={{color: '#64748b'}}>ã‚°ãƒ«ãƒ¼ãƒ—å:</span> <strong>{group.name}</strong></div>
          <div><span style={{color: '#64748b'}}>ãƒ¡ãƒ³ãƒãƒ¼:</span> <strong>{group.members.length}å</strong></div>
          <div><span style={{color: '#64748b'}}>æœˆé¡:</span> <strong>Â¥{(group.monthlyAmount + group.savingsAmount).toLocaleString()}</strong></div>
          <div><span style={{color: '#64748b'}}>é–‹å§‹:</span> <strong>{group.startMonth || '-'}</strong></div>
        </div>
      </div>
    </div>
  );
}

function BulkPaymentView({ group, month, setMonth, getMonthlyStatus, onSubmit, isAdmin, onOpenReminder, delinquents }) {
  const [selected, setSelected] = React.useState([]);
  const [multiMonth, setMultiMonth] = React.useState(false);
  const [monthRange, setMonthRange] = React.useState({ from: month, to: month });
  const status = getMonthlyStatus(month);
  const toggle = (id) => setSelected(p => p.includes(id) ? p.filter(x => x !== id) : [...p, id]);

  const changeMonth = (delta) => {
    const d = new Date(month + '-01');
    d.setMonth(d.getMonth() + delta);
    setMonth(d.toISOString().slice(0, 7));
    setSelected([]);
  };

  // è¤‡æ•°æœˆã®å ´åˆã®è¨ˆç®—
  const getMonthsBetween = () => {
    if (!multiMonth) return [month];
    const months = [];
    const from = new Date(monthRange.from + '-01');
    const to = new Date(monthRange.to + '-01');
    while (from <= to) {
      months.push(from.toISOString().slice(0, 7));
      from.setMonth(from.getMonth() + 1);
    }
    return months;
  };

  const totalMonths = getMonthsBetween().length;
  const totalAmount = (group.monthlyAmount + group.savingsAmount) * selected.length * totalMonths;
  const totalUnpaid = delinquents ? delinquents.reduce((sum, d) => sum + d.unpaidAmount, 0) : 0;

  return (
    <div style={S.view}>
      <h3 style={S.viewTitle}>âœ… ä¸€æ‹¬å…¥é‡‘</h3>
      
      {/* æ»ç´å‚¬ä¿ƒãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
      {isAdmin && delinquents && delinquents.length > 0 && (
        <div style={{background: '#fef2f2', border: '2px solid #fecaca', borderRadius: 12, padding: 14, marginBottom: 16}}>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10}}>
            <span style={{fontWeight: 600, color: '#dc2626'}}>âš ï¸ æœªæ‰•ã„: {delinquents.length}å</span>
            <span style={{fontSize: 14, color: '#dc2626', fontWeight: 700}}>Â¥{totalUnpaid.toLocaleString()}</span>
          </div>
          <button 
            onClick={onOpenReminder}
            style={{
              width: '100%',
              padding: '12px',
              background: '#06c755',
              color: '#fff',
              border: 'none',
              borderRadius: 10,
              fontSize: 14,
              fontWeight: 600,
              cursor: 'pointer'
            }}
          >
            ğŸ“± LINEå‚¬ä¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          </button>
        </div>
      )}
      
      {/* è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ */}
      <div style={{marginBottom: 12}}>
        <button 
          style={{
            ...S.selectBtn, 
            background: multiMonth ? '#0ea5e9' : '#f1f5f9',
            color: multiMonth ? '#fff' : '#64748b',
            marginRight: 8
          }} 
          onClick={() => setMultiMonth(!multiMonth)}
        >
          {multiMonth ? 'âœ“ è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰' : 'ğŸ“… è¤‡æ•°æœˆã¾ã¨ã‚ã¦å…¥é‡‘'}
        </button>
        {multiMonth && <span style={{fontSize: 12, color: '#0ea5e9'}}>å°å…¥æ™‚ã«ä¾¿åˆ©ï¼</span>}
      </div>

      {multiMonth ? (
        /* è¤‡æ•°æœˆé¸æŠUI */
        <div style={{background: '#f0f9ff', borderRadius: 12, padding: 14, marginBottom: 12, border: '2px solid #0ea5e9'}}>
          <div style={{fontSize: 13, color: '#0369a1', marginBottom: 10, fontWeight: 600}}>ğŸ“† æœŸé–“ã‚’é¸æŠ</div>
          <div style={{display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap'}}>
            <input 
              type="month" 
              value={monthRange.from} 
              onChange={e => setMonthRange(p => ({...p, from: e.target.value}))} 
              style={{...S.input, width: 130}} 
            />
            <span style={{color: '#64748b'}}>ã€œ</span>
            <input 
              type="month" 
              value={monthRange.to} 
              onChange={e => setMonthRange(p => ({...p, to: e.target.value}))} 
              style={{...S.input, width: 130}} 
            />
          </div>
          <div style={{marginTop: 10, fontSize: 14, color: '#0369a1'}}>
            <strong>{totalMonths}ãƒ¶æœˆåˆ†</strong>ã‚’ä¸€æ‹¬è¨˜éŒ²ã—ã¾ã™
          </div>
        </div>
      ) : (
        /* é€šå¸¸ã®æœˆé¸æŠUI */
        <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
          <button style={{...S.monthNavBtn, borderRadius: '10px 0 0 10px'}} onClick={() => changeMonth(-1)}>â—€</button>
          <input type="month" value={month} onChange={e => { setMonth(e.target.value); setSelected([]); }} style={{...S.input, flex: 1, borderRadius: 0, textAlign: 'center'}} />
          <button style={{...S.monthNavBtn, borderRadius: '0 10px 10px 0'}} onClick={() => changeMonth(1)}>â–¶</button>
        </div>
      )}

      <div style={S.bulkInfo}>
        <span>é¸æŠ: {selected.length}å Ã— {totalMonths}ãƒ¶æœˆ</span>
        <span style={{fontSize: 18, fontWeight: 700, color: '#0ea5e9'}}>Â¥{totalAmount.toLocaleString()}</span>
      </div>
      <div style={S.bulkBtns}>
        <button style={S.selectBtn} onClick={() => setSelected(group.members.map(m => m.id))}>å…¨é¸æŠ</button>
        <button style={S.selectBtn} onClick={() => setSelected([])}>è§£é™¤</button>
      </div>
      <div style={S.bulkList}>
        {group.members.map(m => {
          const isPaid = !multiMonth && status.paid.some(p => p.id === m.id);
          const isSel = selected.includes(m.id);
          return (
            <div key={m.id} style={{...S.bulkItem, background: isPaid ? '#d1fae5' : isSel ? '#dbeafe' : '#fff', opacity: isPaid ? 0.6 : 1}} onClick={() => !isPaid && toggle(m.id)}>
              <span>{isPaid ? 'âœ…' : isSel ? 'â˜‘ï¸' : 'â¬œ'}</span>
              <span>{m.name}</span>
              {multiMonth && isSel && <span style={{marginLeft: 'auto', fontSize: 12, color: '#0ea5e9'}}>Â¥{((group.monthlyAmount + group.savingsAmount) * totalMonths).toLocaleString()}</span>}
            </div>
          );
        })}
      </div>
      {isAdmin && selected.length > 0 && (
        <button 
          style={S.fixedBtn} 
          onClick={() => {
            if (multiMonth) {
              // è¤‡æ•°æœˆã®å ´åˆã€å„æœˆã”ã¨ã«å…¥é‡‘ã‚’è¨˜éŒ²
              const months = getMonthsBetween();
              months.forEach(m => onSubmit(selected, m));
            } else {
              onSubmit(selected, month);
            }
          }}
        >
          {selected.length}å Ã— {totalMonths}ãƒ¶æœˆã®å…¥é‡‘ã‚’è¨˜éŒ²
        </button>
      )}
    </div>
  );
}

// ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—…è¡Œãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãªã©ï¼‰ç”»é¢
function SpecialEventsView({ group, events, onCreateEvent, onEditEvent, onDeleteEvent, onVote, onClose, onReopen, notify }) {
  const [showCreate, setShowCreate] = React.useState(false);
  const [editingEvent, setEditingEvent] = React.useState(null);
  const [newEvent, setNewEvent] = React.useState({ title: '', description: '', date: '', deadline: '', type: 'travel' });
  const [selectedMemberId, setSelectedMemberId] = React.useState(group.members[0]?.id || '');
  const [expandedPastEvent, setExpandedPastEvent] = React.useState(null);

  const eventTypes = [
    { value: 'travel', label: 'ğŸš— æ—…è¡Œ', color: '#0ea5e9' },
    { value: 'camp', label: 'ğŸ•ï¸ ã‚­ãƒ£ãƒ³ãƒ—', color: '#10b981' },
    { value: 'bbq', label: 'ğŸ– BBQ', color: '#f59e0b' },
    { value: 'sports', label: 'âš½ ã‚¹ãƒãƒ¼ãƒ„', color: '#8b5cf6' },
    { value: 'other', label: 'ğŸ‰ ãã®ä»–', color: '#ec4899' },
  ];

  const activeEvents = events.filter(e => e.status === 'active');
  const closedEvents = events.filter(e => e.status === 'closed').slice(-5);

  const handleSubmit = () => {
    if (!newEvent.title) return;
    if (editingEvent) {
      onEditEvent(editingEvent.id, newEvent);
      setEditingEvent(null);
    } else {
      onCreateEvent(newEvent);
    }
    setNewEvent({ title: '', description: '', date: '', deadline: '', type: 'travel' });
    setShowCreate(false);
  };

  const startEdit = (event) => {
    setNewEvent({ title: event.title, description: event.description || '', date: event.date || '', deadline: event.deadline || '', type: event.type || 'travel' });
    setEditingEvent(event);
    setShowCreate(true);
  };

  const getTypeInfo = (type) => eventTypes.find(t => t.value === type) || eventTypes[4];

  return (
    <div style={S.view}>
      <div style={S.viewHeader}>
        <h3 style={S.viewTitle}>ğŸª ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
        <button style={S.addBtn} onClick={() => { setShowCreate(true); setEditingEvent(null); setNewEvent({ title: '', description: '', date: '', deadline: '', type: 'travel' }); }}>+</button>
      </div>

      {/* æ–°è¦ä½œæˆãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */}
      {showCreate && (
        <div style={{...S.card, background: '#f8fafc', border: '2px solid #0ea5e9'}}>
          <h4 style={S.subTitle}>{editingEvent ? 'âœ ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†' : 'ğŸª ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ'}</h4>
          
          {/* ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— */}
          <div style={{display: 'flex', gap: 6, flexWrap: 'wrap', marginBottom: 12}}>
            {eventTypes.map(t => (
              <button
                key={t.value}
                onClick={() => setNewEvent({...newEvent, type: t.value})}
                style={{
                  padding: '8px 12px',
                  borderRadius: 20,
                  border: newEvent.type === t.value ? `2px solid ${t.color}` : '2px solid #e2e8f0',
                  background: newEvent.type === t.value ? t.color : '#fff',
                  color: newEvent.type === t.value ? '#fff' : '#64748b',
                  fontSize: 13,
                  cursor: 'pointer'
                }}
              >
                {t.label}
              </button>
            ))}
          </div>

          <input 
            type="text" 
            value={newEvent.title} 
            onChange={e => setNewEvent({...newEvent, title: e.target.value})} 
            style={S.input} 
            placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå *ï¼ˆä¾‹: æ²–ç¸„æœ¬å³¶ã‚­ãƒ£ãƒ³ãƒ—ï¼‰" 
          />
          <textarea 
            value={newEvent.description} 
            onChange={e => setNewEvent({...newEvent, description: e.target.value})} 
            style={{...S.input, minHeight: 80, resize: 'vertical'}} 
            placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰" 
          />
          <div style={{display: 'flex', gap: 8}}>
            <div style={{flex: 1}}>
              <label style={S.label}>é–‹å‚¬æ—¥</label>
              <input type="date" value={newEvent.date} onChange={e => setNewEvent({...newEvent, date: e.target.value})} style={S.input} />
            </div>
            <div style={{flex: 1}}>
              <label style={S.label}>å›ç­”ç· åˆ‡</label>
              <input type="date" value={newEvent.deadline} onChange={e => setNewEvent({...newEvent, deadline: e.target.value})} style={S.input} />
            </div>
          </div>
          <div style={S.btnRow}>
            <button style={S.cancelBtn} onClick={() => { setShowCreate(false); setEditingEvent(null); }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style={S.submitBtn} onClick={handleSubmit} disabled={!newEvent.title}>{editingEvent ? 'æ›´æ–°' : 'ä½œæˆ'}</button>
          </div>
        </div>
      )}

      {/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¤ãƒ™ãƒ³ãƒˆ */}
      {activeEvents.length === 0 && !showCreate ? (
        <div style={{...S.card, textAlign: 'center', padding: 40}}>
          <div style={{fontSize: 48, marginBottom: 12}}>ğŸª</div>
          <div style={{color: '#64748b', marginBottom: 16}}>ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
          <button style={S.createBtn} onClick={() => setShowCreate(true)}>ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</button>
        </div>
      ) : (
        activeEvents.map(event => {
          const typeInfo = getTypeInfo(event.type);
          const att = event.attendance || {};
          const counts = {
            yes: Object.values(att).filter(v => v === 'yes').length,
            no: Object.values(att).filter(v => v === 'no').length,
            maybe: Object.values(att).filter(v => v === 'maybe').length,
          };
          const isDeadlinePassed = event.deadline && new Date(event.deadline) < new Date();

          return (
            <div key={event.id} style={{...S.card, borderLeft: `4px solid ${typeInfo.color}`}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12}}>
                <div>
                  <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4}}>
                    <span style={{background: typeInfo.color, color: '#fff', padding: '4px 10px', borderRadius: 12, fontSize: 12}}>{typeInfo.label}</span>
                    {isDeadlinePassed && <span style={{background: '#fee2e2', color: '#dc2626', padding: '4px 8px', borderRadius: 8, fontSize: 11}}>ç· åˆ‡æ¸ˆ</span>}
                  </div>
                  <div style={{fontSize: 18, fontWeight: 700, color: '#1e293b'}}>{event.title}</div>
                </div>
                <div style={{display: 'flex', gap: 6}}>
                  <button style={{...S.editBtn, fontSize: 14}} onClick={() => startEdit(event)}>âœ</button>
                  <button style={{...S.delBtn, fontSize: 14}} onClick={() => onDeleteEvent(event.id)}>Ã—</button>
                </div>
              </div>

              {event.description && <div style={{fontSize: 13, color: '#64748b', marginBottom: 12, whiteSpace: 'pre-wrap'}}>{event.description}</div>}

              <div style={{display: 'flex', gap: 16, fontSize: 13, color: '#64748b', marginBottom: 16}}>
                {event.date && <span>ğŸ“… {event.date}</span>}
                {event.deadline && <span>â° ç· åˆ‡: {event.deadline}</span>}
              </div>

              {/* æŠ•ç¥¨çŠ¶æ³ãƒãƒ¼ */}
              <div style={{marginBottom: 12}}>
                <div style={{display: 'flex', height: 8, borderRadius: 4, overflow: 'hidden', background: '#e2e8f0'}}>
                  <div style={{background: '#10b981', width: `${(counts.yes / group.members.length) * 100}%`}}></div>
                  <div style={{background: '#f59e0b', width: `${(counts.maybe / group.members.length) * 100}%`}}></div>
                  <div style={{background: '#ef4444', width: `${(counts.no / group.members.length) * 100}%`}}></div>
                </div>
                <div style={{display: 'flex', justifyContent: 'center', gap: 16, marginTop: 8, fontSize: 14}}>
                  <span style={{color: '#10b981'}}>â­• {counts.yes}</span>
                  <span style={{color: '#f59e0b'}}>ğŸ”º {counts.maybe}</span>
                  <span style={{color: '#ef4444'}}>âŒ {counts.no}</span>
                  <span style={{color: '#94a3b8'}}>â“ {group.members.length - counts.yes - counts.no - counts.maybe}</span>
                </div>
              </div>

              {/* æŠ•ç¥¨ */}
              <div style={{background: '#f8fafc', padding: 12, borderRadius: 10, marginBottom: 12}}>
                <select value={selectedMemberId} onChange={e => setSelectedMemberId(e.target.value)} style={{...S.input, marginBottom: 8}}>
                  {group.members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                </select>
                <div style={{display: 'flex', gap: 8}}>
                  {['yes', 'maybe', 'no'].map(v => (
                    <button
                      key={v}
                      onClick={() => onVote(event.id, selectedMemberId, v)}
                      style={{
                        flex: 1,
                        padding: '12px 8px',
                        borderRadius: 10,
                        border: 'none',
                        background: att[selectedMemberId] === v 
                          ? (v === 'yes' ? '#10b981' : v === 'maybe' ? '#f59e0b' : '#ef4444') 
                          : '#e2e8f0',
                        color: att[selectedMemberId] === v ? '#fff' : '#64748b',
                        fontSize: 18,
                        cursor: 'pointer'
                      }}
                    >
                      {v === 'yes' ? 'â­•' : v === 'maybe' ? 'ğŸ”º' : 'âŒ'}
                    </button>
                  ))}
                </div>
              </div>

              {/* å‚åŠ è€…ä¸€è¦§ */}
              <div style={{fontSize: 13}}>
                <div style={{marginBottom: 8}}>
                  <span style={{color: '#10b981', fontWeight: 600}}>â­• å‚åŠ  ({counts.yes}): </span>
                  <span style={{color: '#64748b'}}>
                    {Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€') || '-'}
                  </span>
                </div>
                <div style={{marginBottom: 8}}>
                  <span style={{color: '#f59e0b', fontWeight: 600}}>ğŸ”º æœªå®š ({counts.maybe}): </span>
                  <span style={{color: '#64748b'}}>
                    {Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€') || '-'}
                  </span>
                </div>
                <div>
                  <span style={{color: '#ef4444', fontWeight: 600}}>âŒ ä¸å‚åŠ  ({counts.no}): </span>
                  <span style={{color: '#64748b'}}>
                    {Object.entries(att).filter(([_, v]) => v === 'no').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€') || '-'}
                  </span>
                </div>
              </div>

              {/* LINEé€šçŸ¥ãƒ»ç· ã‚åˆ‡ã‚Šãƒœã‚¿ãƒ³ */}
              <div style={{display: 'flex', flexDirection: 'column', gap: 8, marginTop: 16}}>
                <div style={{display: 'flex', gap: 8}}>
                  <button
                    style={{flex: 1, padding: '10px', background: '#06c755', color: '#fff', border: 'none', borderRadius: 10, fontSize: 13, cursor: 'pointer'}}
                    onClick={() => {
                      const yes = Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
                      const maybe = Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
                      const appUrl = window.location.href.split('?')[0] + '?view=events';
                      const msg = `ã€${event.title}ã€‘å‡ºæ¬ ç¢ºèª

ğŸ“… ${event.date || 'æ—¥ç¨‹æœªå®š'}
${event.description ? `\n${event.description}\n` : ''}
â­• å‚åŠ  (${yes.length}å): ${yes.join('ã€') || 'ãªã—'}
ğŸ”º æœªå®š (${maybe.length}å): ${maybe.join('ã€') || 'ãªã—'}

ã¾ã ã®æ–¹ã¯å›ç­”ãŠé¡˜ã„ã—ã¾ã™ï¼
ğŸ‘‡ æŠ•ç¥¨ã¯ã“ã¡ã‚‰
${appUrl}`;
                      if (group.lineGroupUrl) {
                        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`, '_blank');
                      } else {
                        navigator.clipboard?.writeText(msg);
                        notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                      }
                    }}
                  >
                    {group.lineGroupUrl ? 'ğŸ’¬ LINEã§é€ã‚‹' : 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'}
                  </button>
                  <button
                    style={{flex: 1, padding: '10px', background: '#dc2626', color: '#fff', border: 'none', borderRadius: 10, fontSize: 13, cursor: 'pointer'}}
                    onClick={() => {
                      if (confirm(`ã€Œ${event.title}ã€ã‚’ç· ã‚åˆ‡ã‚Šã¾ã™ã‹ï¼Ÿ\n\nç· ã‚åˆ‡ã‚‹ã¨æŠ•ç¥¨ã§ããªããªã‚Šã¾ã™ã€‚`)) {
                        onClose(event.id);
                      }
                    }}
                  >
                    ğŸ”’ ç· ã‚åˆ‡ã‚‹
                  </button>
                </div>
                {!group.lineGroupUrl && (
                  <div style={{fontSize: 11, color: '#94a3b8', textAlign: 'center'}}>
                    ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
                  </div>
                )}
              </div>
            </div>
          );
        })
      )}

      {/* éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆ */}
      {closedEvents.length > 0 && (
        <div style={S.card}>
          <h4 style={S.subTitle}>ğŸ“ éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆ</h4>
          {closedEvents.map(event => {
            const typeInfo = getTypeInfo(event.type);
            const att = event.attendance || {};
            const yesCount = Object.values(att).filter(v => v === 'yes').length;
            const maybeCount = Object.values(att).filter(v => v === 'maybe').length;
            const noCount = Object.values(att).filter(v => v === 'no').length;
            const isExpanded = expandedPastEvent === event.id;
            
            return (
              <div key={event.id} style={{borderBottom: '1px solid #f1f5f9'}}>
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ãƒƒãƒ—ã§å±•é–‹ï¼‰ */}
                <div 
                  style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 0', cursor: 'pointer'}}
                  onClick={() => setExpandedPastEvent(isExpanded ? null : event.id)}
                >
                  <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                    <span style={{fontSize: 12}}>{typeInfo.label.split(' ')[0]}</span>
                    <span style={{fontWeight: 500}}>{event.title}</span>
                    <span style={{fontSize: 16, color: '#94a3b8', transition: 'transform 0.2s', transform: isExpanded ? 'rotate(180deg)' : 'rotate(0)'}}></span>
                  </div>
                  <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                    <span style={{fontSize: 13, color: '#10b981'}}>â­•{yesCount}</span>
                  </div>
                </div>
                
                {/* å±•é–‹æ™‚ã®è©³ç´° */}
                {isExpanded && (
                  <div style={{padding: '0 0 16px 0'}}>
                    {/* æ—¥ç¨‹ãƒ»è©³ç´° */}
                    <div style={{background: '#f8fafc', borderRadius: 10, padding: 12, marginBottom: 12}}>
                      {event.date && <div style={{fontSize: 13, color: '#64748b', marginBottom: 4}}>ğŸ“… {event.date}</div>}
                      {event.description && <div style={{fontSize: 13, color: '#475569', whiteSpace: 'pre-wrap'}}>{event.description}</div>}
                      {!event.date && !event.description && <div style={{fontSize: 13, color: '#94a3b8'}}>è©³ç´°ãªã—</div>}
                    </div>
                    
                    {/* æŠ•ç¥¨çµæœ */}
                    <div style={{marginBottom: 12}}>
                      <div style={{display: 'flex', height: 8, borderRadius: 4, overflow: 'hidden', background: '#e2e8f0', marginBottom: 8}}>
                        <div style={{background: '#10b981', width: `${(yesCount / group.members.length) * 100}%`}}></div>
                        <div style={{background: '#f59e0b', width: `${(maybeCount / group.members.length) * 100}%`}}></div>
                        <div style={{background: '#ef4444', width: `${(noCount / group.members.length) * 100}%`}}></div>
                      </div>
                      <div style={{fontSize: 13}}>
                        <div style={{marginBottom: 4}}>
                          <span style={{color: '#10b981', fontWeight: 600}}>â­• å‚åŠ  ({yesCount}): </span>
                          <span style={{color: '#64748b'}}>
                            {Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€') || '-'}
                          </span>
                        </div>
                        <div style={{marginBottom: 4}}>
                          <span style={{color: '#f59e0b', fontWeight: 600}}>ğŸ”º æœªå®š ({maybeCount}): </span>
                          <span style={{color: '#64748b'}}>
                            {Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€') || '-'}
                          </span>
                        </div>
                        <div>
                          <span style={{color: '#ef4444', fontWeight: 600}}>âŒ ä¸å‚åŠ  ({noCount}): </span>
                          <span style={{color: '#64748b'}}>
                            {Object.entries(att).filter(([_, v]) => v === 'no').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean).join('ã€') || '-'}
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    {/* å†é–‹ãƒœã‚¿ãƒ³ */}
                    <button
                      onClick={() => onReopen(event.id)}
                      style={{
                        width: '100%',
                        padding: '10px',
                        background: '#f0f9ff',
                        color: '#0369a1',
                        border: '1px solid #0ea5e9',
                        borderRadius: 8,
                        fontSize: 13,
                        cursor: 'pointer'
                      }}
                    >
                      ğŸ”“ æŠ•ç¥¨ã‚’å†é–‹ã™ã‚‹
                    </button>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

function PartyView({ group, isAdmin, currentEvent, pastEvents, getNextPartyDate, onCreateEvent, onEditEvent, onDeleteEvent, onAddVenue, onAddVenueFromPast, onDeleteVenue, onDeletePastVenue, onAttendanceVote, onVenueVote, onConfirmEvent, onCompleteEvent, onRecordExpense, onAddPhoto, notify }) {
  const [selectedMemberId, setSelectedMemberId] = React.useState(group.members[0]?.id || '');
  const [showAddVenue, setShowAddVenue] = React.useState(false);
  const [showPastVenues, setShowPastVenues] = React.useState(false);
  const [newVenue, setNewVenue] = React.useState({ name: '', address: '', url: '' });
  const [photoUrl, setPhotoUrl] = React.useState('');

  if (!currentEvent) {
    return (
      <div style={S.view}>
        <div style={S.viewHeader}>
          <h3 style={S.viewTitle}>ğŸ» é£²ã¿ä¼š</h3>
          <button style={S.addBtn} onClick={onCreateEvent}>+</button>
        </div>
        <div style={S.emptyParty}>
          <div style={{fontSize: 56}}>ğŸº</div>
          <p style={{fontSize: 16}}>äºˆå®šãªã—</p>
          {getNextPartyDate() && <p style={{...S.hint, fontSize: 14}}>ğŸ’¡ æ¬¡å›ææ¡ˆ: {getNextPartyDate()}</p>}
          <button style={S.createBtn} onClick={onCreateEvent}>é£²ã¿ä¼šã‚’ä½œæˆ</button>
        </div>
        {pastEvents.length > 0 && (
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ“¸ éå»ã®é£²ã¿ä¼š</h4>
            {pastEvents.map(e => {
              const venue = e.venues.find(v => v.id === e.confirmedVenue);
              const yesCount = Object.values(e.attendance || {}).filter(v => v === 'yes').length;
              return (
                <div key={e.id} style={S.pastRow}>
                  <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                    <span>{e.date}</span>
                    {e.autoArchived && <span style={{fontSize: 11, background: '#e2e8f0', padding: '3px 6px', borderRadius: 4}}>è‡ªå‹•</span>}
                  </div>
                  <span>{venue?.name || '-'}</span>
                  <span style={{fontSize: 13, color: '#64748b'}}>{yesCount}å</span>
                  {e.expense && <span>Â¥{e.expense.perPerson?.toLocaleString()}/äºº</span>}
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  }

  const att = currentEvent.attendance || {};
  const counts = {
    yes: Object.values(att).filter(v => v === 'yes').length,
    no: Object.values(att).filter(v => v === 'no').length,
    maybe: Object.values(att).filter(v => v === 'maybe').length,
  };
  const venueCounts = {};
  Object.values(currentEvent.venueVotes || {}).forEach(vid => { venueCounts[vid] = (venueCounts[vid] || 0) + 1; });
  const confirmedVenue = currentEvent.venues.find(v => v.id === currentEvent.confirmedVenue);
  const isDeadlinePassed = currentEvent.deadline && new Date(currentEvent.deadline) < new Date();

  return (
    <div style={S.view}>
      <div style={S.viewHeader}>
        <h3 style={S.viewTitle}>ğŸ» {currentEvent.date}</h3>
        <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
          {currentEvent.status === 'confirmed' && <span style={S.confirmedTag}>âœ“ç¢ºå®š</span>}
          {currentEvent.status !== 'completed' && (
            <>
              <button style={{...S.editBtn, fontSize: 16}} onClick={() => onEditEvent(currentEvent)}>âœ</button>
              <button style={{...S.delBtn, fontSize: 16}} onClick={() => onDeleteEvent(currentEvent.id)}>Ã—</button>
            </>
          )}
        </div>
      </div>

      {/* åŸºæœ¬æƒ…å ± */}
      <div style={S.partyInfo}>
        <div style={{fontSize: 16}}>ğŸ“… {currentEvent.date} {currentEvent.time}</div>
        {currentEvent.deadline && <div style={{fontSize: 13, color: isDeadlinePassed ? '#dc2626' : '#64748b', marginTop: 4}}>â° ç· åˆ‡: {currentEvent.deadline} {isDeadlinePassed && '(ç· åˆ‡æ¸ˆ)'}</div>}
        {confirmedVenue && (
          <div style={S.confirmedBox}>
            <div style={{fontWeight: 700, fontSize: 16}}>ğŸ“ {confirmedVenue.name}</div>
            {confirmedVenue.address && <div style={{fontSize: 14, marginTop: 4}}>{confirmedVenue.address}</div>}
            {confirmedVenue.url && <a href={confirmedVenue.url} target="_blank" rel="noreferrer" style={S.link}>ğŸ”— è©³ç´°</a>}
          </div>
        )}
      </div>

      {/* å‚åŠ å¯å¦ */}
      <div style={S.card}>
        <h4 style={S.subTitle}>ğŸ—³ï¸ å‚åŠ å¯å¦</h4>
        <div style={S.voteBar}>
          <div style={{...S.voteSection, background: '#10b981', width: `${(counts.yes / group.members.length) * 100}%`}}></div>
          <div style={{...S.voteSection, background: '#f59e0b', width: `${(counts.maybe / group.members.length) * 100}%`}}></div>
          <div style={{...S.voteSection, background: '#ef4444', width: `${(counts.no / group.members.length) * 100}%`}}></div>
        </div>
        <div style={S.voteCounts}>
          <span style={{color: '#10b981'}}>â­•{counts.yes}</span>
          <span style={{color: '#f59e0b'}}>ğŸ”º{counts.maybe}</span>
          <span style={{color: '#ef4444'}}>âŒ{counts.no}</span>
        </div>
        <div style={S.myVote}>
          <select value={selectedMemberId} onChange={e => setSelectedMemberId(e.target.value)} style={S.input}>
            {group.members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
          </select>
          <div style={S.voteBtns}>
            {['yes', 'maybe', 'no'].map(v => (
              <button key={v} style={{...S.voteBtn, background: att[selectedMemberId] === v ? (v === 'yes' ? '#10b981' : v === 'maybe' ? '#f59e0b' : '#ef4444') : '#f1f5f9', color: att[selectedMemberId] === v ? '#fff' : '#64748b'}} onClick={() => onAttendanceVote(currentEvent.id, selectedMemberId, v)}>
                {v === 'yes' ? 'â­•' : v === 'maybe' ? 'ğŸ”º' : 'âŒ'}
              </button>
            ))}
          </div>
        </div>
        <div style={S.attList}>
          {group.members.map(m => (
            <div key={m.id} style={S.attItem}>
              <span>{m.name}</span>
              <span style={{color: att[m.id] === 'yes' ? '#10b981' : att[m.id] === 'maybe' ? '#f59e0b' : att[m.id] === 'no' ? '#ef4444' : '#94a3b8'}}>
                {att[m.id] === 'yes' ? 'â­•' : att[m.id] === 'maybe' ? 'ğŸ”º' : att[m.id] === 'no' ? 'âŒ' : 'âˆ’'}
              </span>
            </div>
          ))}
        </div>
      </div>

      {/* åº—èˆ—å€™è£œ */}
      {currentEvent.status === 'voting' && (
        <div style={S.card}>
          <h4 style={S.subTitle}>ğŸ“ åº—èˆ—å€™è£œ</h4>
          {currentEvent.venues.length === 0 && <div style={S.empty}>å€™è£œãªã—</div>}
          {currentEvent.venues.map(v => {
            const cnt = venueCounts[v.id] || 0;
            const myVote = currentEvent.venueVotes?.[selectedMemberId] === v.id;
            return (
              <div key={v.id} style={{...S.venueCard, borderColor: myVote ? '#0ea5e9' : '#e2e8f0'}}>
                <div style={S.venueTop}>
                  <div style={{flex: 1}}>
                    <div style={{fontWeight: 600, fontSize: 15}}>{v.name}</div>
                    {v.url && (
                      <a 
                        href={v.url} 
                        target="_blank" 
                        rel="noreferrer" 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: 4,
                          marginTop: 6,
                          padding: '6px 12px',
                          background: '#dbeafe',
                          color: '#1d4ed8',
                          borderRadius: 20,
                          fontSize: 12,
                          fontWeight: 600,
                          textDecoration: 'none'
                        }}
                      >
                        ğŸ“ ãŠåº—ã®è©³ç´°ã‚’è¦‹ã‚‹
                      </a>
                    )}
                  </div>
                  <div style={S.voteCount}>{cnt}<span style={{fontSize: 12}}>ç¥¨</span></div>
                </div>
                <div style={S.venueActions}>
                  <button style={{...S.venueVoteBtn, background: myVote ? '#0ea5e9' : '#f1f5f9', color: myVote ? '#fff' : '#64748b'}} onClick={() => onVenueVote(currentEvent.id, selectedMemberId, v.id)}>{myVote ? 'âœ“æŠ•ç¥¨æ¸ˆ' : 'æŠ•ç¥¨'}</button>
                  <button style={S.venueDelBtn} onClick={() => onDeleteVenue(currentEvent.id, v.id)}>ğŸ—‘</button>
                </div>
              </div>
            );
          })}

          {/* åº—èˆ—è¿½åŠ ï¼ˆèª°ã§ã‚‚OKï¼‰ */}
          {showPastVenues ? (
            <div style={S.pastVenuesBox}>
              <div style={{fontWeight: 600, marginBottom: 10, fontSize: 15}}>ğŸ® å€™è£œåº—èˆ—ãƒªã‚¹ãƒˆ</div>
              <div style={{fontSize: 12, color: '#64748b', marginBottom: 10}}>ã‚¿ãƒƒãƒ—ã—ã¦ä»Šå›ã®å€™è£œã«è¿½åŠ </div>
              {(group.pastVenues || []).length === 0 ? <div style={S.empty}>åº—èˆ—ç™»éŒ²ãªã—</div> : (group.pastVenues || []).map(v => (
                <div key={v.id} style={{...S.pastVenueItem, display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                  <div style={{flex: 1, cursor: 'pointer'}} onClick={() => { onAddVenueFromPast(currentEvent.id, v); setShowPastVenues(false); }}>
                    <div style={{fontSize: 14, fontWeight: 500}}>{v.name}</div>
                    <div style={{fontSize: 11, color: '#64748b'}}>{v.usedCount > 0 ? `${v.usedCount}å›åˆ©ç”¨` : 'æœªåˆ©ç”¨'}</div>
                  </div>
                  <button 
                    onClick={(e) => { e.stopPropagation(); onDeletePastVenue(v.id); }}
                    style={{
                      padding: '4px 8px',
                      background: '#fee2e2',
                      color: '#dc2626',
                      border: 'none',
                      borderRadius: 4,
                      fontSize: 12,
                      cursor: 'pointer'
                    }}
                  >
                    å‰Šé™¤
                  </button>
                </div>
              ))}
              <button style={S.linkBtn} onClick={() => setShowPastVenues(false)}>é–‰ã˜ã‚‹</button>
            </div>
          ) : showAddVenue ? (
            <div style={S.addVenueForm}>
              {/* ã‚¨ãƒªã‚¢æ¤œç´¢ãƒœã‚¿ãƒ³ */}
              <div style={{marginBottom: 12}}>
                <div style={{display: 'flex', gap: 8}}>
                  <button 
                    style={{
                      flex: 1,
                      padding: '14px 12px',
                      background: 'linear-gradient(135deg, #4285f4, #34a853)',
                      color: '#fff',
                      border: 'none',
                      borderRadius: 10,
                      fontSize: 14,
                      fontWeight: 600,
                      cursor: 'pointer'
                    }}
                    onClick={() => window.open('https://www.google.com/search?q=' + encodeURIComponent('æµ¦æ·» å±…é…’å±‹'), '_blank')}
                  >
                    ğŸ” æµ¦æ·» å±…é…’å±‹
                  </button>
                  <button 
                    style={{
                      flex: 1,
                      padding: '14px 12px',
                      background: 'linear-gradient(135deg, #4285f4, #34a853)',
                      color: '#fff',
                      border: 'none',
                      borderRadius: 10,
                      fontSize: 14,
                      fontWeight: 600,
                      cursor: 'pointer'
                    }}
                    onClick={() => window.open('https://www.google.com/search?q=' + encodeURIComponent('é‚£è¦‡ å±…é…’å±‹'), '_blank')}
                  >
                    ğŸ” é‚£è¦‡ å±…é…’å±‹
                  </button>
                </div>
              </div>

              {/* ã‹ã‚“ãŸã‚“ç™»éŒ² */}
              <div style={{background: '#ecfdf5', padding: 14, borderRadius: 12, marginBottom: 16, border: '2px solid #10b981'}}>
                <div style={{fontSize: 13, fontWeight: 700, color: '#065f46', marginBottom: 8}}>âš¡ ã‹ã‚“ãŸã‚“ç™»éŒ²</div>
                <div style={{fontSize: 11, color: '#047857', marginBottom: 8}}>Google Maps ã®URLã‚’è²¼ã‚Šä»˜ã‘ â†’ ç™»éŒ²ãƒœã‚¿ãƒ³</div>
                <input 
                  type="text" 
                  id="quickVenueUrl"
                  style={{...S.input, marginBottom: 10, fontSize: 14}} 
                  placeholder="URLã‚’è²¼ã‚Šä»˜ã‘"
                />
                <button
                  style={{
                    width: '100%',
                    padding: '14px',
                    background: '#10b981',
                    color: '#fff',
                    border: 'none',
                    borderRadius: 10,
                    fontSize: 15,
                    fontWeight: 700,
                    cursor: 'pointer'
                  }}
                  onClick={() => {
                    const input = document.getElementById('quickVenueUrl');
                    const url = input?.value;
                    if (!url) {
                      notify('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                      return;
                    }
                    
                    let name = '';
                    try {
                      if (url.includes('google.com/maps/place/')) {
                        const match = url.match(/place\/([^\/]+)/);
                        if (match) {
                          name = decodeURIComponent(match[1].replace(/\+/g, ' '));
                        }
                      }
                    } catch (err) {}
                    
                    if (!name) {
                      name = prompt('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', '');
                    }
                    
                    if (name) {
                      onAddVenue(currentEvent.id, { name: name, url: url, address: '' });
                      input.value = '';
                      notify('åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                    }
                  }}
                >
                  ï¼‹ ã“ã®åº—èˆ—ã‚’è¿½åŠ 
                </button>
              </div>

              {/* è©³ç´°å…¥åŠ›ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ */}
              <details style={{marginBottom: 12}}>
                <summary style={{fontSize: 13, color: '#64748b', cursor: 'pointer', marginBottom: 10}}>ğŸ“ æ‰‹å‹•ã§è©³ã—ãå…¥åŠ›ã™ã‚‹</summary>
                <input type="text" value={newVenue.name} onChange={e => setNewVenue({...newVenue, name: e.target.value})} style={S.input} placeholder="åº—èˆ—å *" />
                <input type="text" value={newVenue.address} onChange={e => setNewVenue({...newVenue, address: e.target.value})} style={S.input} placeholder="ä½æ‰€" />
                <input type="text" value={newVenue.url} onChange={e => setNewVenue({...newVenue, url: e.target.value})} style={S.input} placeholder="URL" />
                <button 
                  style={{...S.submitBtn, width: '100%', marginTop: 8}} 
                  onClick={() => { 
                    if (newVenue.name) {
                      onAddVenue(currentEvent.id, newVenue); 
                      setNewVenue({ name: '', address: '', url: '' }); 
                    }
                  }} 
                  disabled={!newVenue.name}
                >
                  è¿½åŠ 
                </button>
              </details>

              <button style={{...S.cancelBtn, width: '100%'}} onClick={() => setShowAddVenue(false)}>é–‰ã˜ã‚‹</button>
            </div>
          ) : (
            <div style={S.addVenueBtns}>
              <button style={S.addVenueBtn} onClick={() => setShowAddVenue(true)}>+ æ–°è¦è¿½åŠ </button>
              <button style={S.pastVenueBtn} onClick={() => setShowPastVenues(true)}>ğŸ® éå»ã‹ã‚‰é¸ã¶</button>
            </div>
          )}
        </div>
      )}

      {/* ç¢ºå®šãƒœã‚¿ãƒ³ */}
      {currentEvent.status === 'voting' && currentEvent.venues.length > 0 && (
        <div style={S.card}>
          <h4 style={S.subTitle}>ğŸ“¢ äºˆç´„ç¢ºå®š</h4>
          {currentEvent.venues.map(v => (
            <button key={v.id} style={S.confirmBtn} onClick={() => onConfirmEvent(currentEvent.id, v.id)}>{v.name} ã§ç¢ºå®š</button>
          ))}
        </div>
      )}

      {/* ç¢ºå®šå¾Œ */}
      {currentEvent.status === 'confirmed' && (
        <>
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ“¢ LINEé€šçŸ¥</h4>
            <button style={{...S.lineBtn, background: '#06c755'}} onClick={() => {
              const yes = Object.entries(att).filter(([_, v]) => v === 'yes').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
              const maybe = Object.entries(att).filter(([_, v]) => v === 'maybe').map(([id]) => group.members.find(m => m.id === id)?.name).filter(Boolean);
              const appUrl = window.location.href.split('?')[0] + '?view=party';
              const msg = `ğŸŒº æ¨¡åˆé£²ã¿ä¼šã®ãŠçŸ¥ã‚‰ã› ğŸŒº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æ—¥æ™‚: ${currentEvent.date} (${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(currentEvent.date).getDay()]}æ›œæ—¥) ${currentEvent.time}ã€œ

ğŸ“ åº—èˆ—: ${confirmedVenue?.name || 'æœªå®š'}
${confirmedVenue?.address ? `ğŸ“® ä½æ‰€: ${confirmedVenue.address}` : ''}
${confirmedVenue?.url ? `ğŸ”— è©³ç´°: ${confirmedVenue.url}` : ''}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… å‚åŠ  (${yes.length}å):
${yes.join('ã€') || 'ãªã—'}

${maybe.length > 0 ? `ğŸ”º æœªå®š (${maybe.length}å):\n${maybe.join('ã€')}\n` : ''}
ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼ğŸ»

ğŸ‘‡ å‡ºæ¬ å›ç­”ã¯ã“ã¡ã‚‰
${appUrl}`;
              if (group.lineGroupUrl) {
                window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`, '_blank');
              } else {
                navigator.clipboard?.writeText(msg);
                notify('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
              }
            }}>{group.lineGroupUrl ? 'ğŸ’¬ LINEã§é€ã‚‹' : 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'}</button>
            {!group.lineGroupUrl && (
              <div style={{fontSize: 11, color: '#94a3b8', marginTop: 8}}>
                ğŸ’¡ è¨­å®šã§LINEã‚°ãƒ«ãƒ¼ãƒ—URLã‚’ç™»éŒ²ã™ã‚‹ã¨ç›´æ¥é€ã‚Œã¾ã™
              </div>
            )}
          </div>

          {/* ä¼šè¨ˆ */}
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ’¸ ä¼šè¨ˆ</h4>
            {currentEvent.expense ? (
              <div style={{fontSize: 15}}>
                <div style={{marginBottom: 6}}>åˆè¨ˆ: Â¥{currentEvent.expense.total?.toLocaleString()}</div>
                <div style={{fontWeight: 600}}>ä¸€äºº: Â¥{currentEvent.expense.perPerson?.toLocaleString()}</div>
              </div>
            ) : (
              isAdmin && <button style={S.linkBtn} onClick={() => onRecordExpense(currentEvent.id)}>+ ä¼šè¨ˆã‚’è¨˜éŒ²</button>
            )}
          </div>

          {/* å†™çœŸ */}
          <div style={S.card}>
            <h4 style={S.subTitle}>ğŸ“¸ å†™çœŸã‚¢ãƒ«ãƒãƒ </h4>
            <div style={S.photoGrid}>
              {(currentEvent.photos || []).map(p => (
                <a key={p.id} href={p.url} target="_blank" rel="noreferrer" style={S.photoLink}>ğŸ–¼</a>
              ))}
            </div>
            <div style={S.addPhotoRow}>
              <input type="text" value={photoUrl} onChange={e => setPhotoUrl(e.target.value)} style={{...S.input, flex: 1}} placeholder="å†™çœŸURL" />
              <button style={S.addPhotoBtn} onClick={() => { onAddPhoto(currentEvent.id, photoUrl); setPhotoUrl(''); }} disabled={!photoUrl}>è¿½åŠ </button>
            </div>
          </div>

          {/* å®Œäº†ãƒœã‚¿ãƒ³ */}
          {isAdmin && (
            <button style={S.completeBtn} onClick={() => onCompleteEvent(currentEvent.id)}>âœ“ é£²ã¿ä¼šã‚’å®Œäº†ã«ã™ã‚‹</button>
          )}
        </>
      )}
    </div>
  );
}

// ===== ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–ç‰ˆï¼‰ =====
const S = {
  container: { minHeight: '100vh', background: '#f1f5f9', fontFamily: 'system-ui, sans-serif', WebkitTextSizeAdjust: '100%' },
  loading: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', fontSize: 18 },
  header: { background: 'linear-gradient(135deg, #0ea5e9, #0284c7)', padding: '14px 16px', position: 'sticky', top: 0, zIndex: 100 },
  headerInner: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', maxWidth: 600, margin: '0 auto' },
  logo: { display: 'flex', alignItems: 'center', gap: 8, color: '#fff', fontSize: 22 },
  logoText: { fontWeight: 700 },
  adminBadge: { background: 'rgba(255,255,255,0.2)', color: '#fff', border: 'none', padding: '8px 14px', borderRadius: 20, fontSize: 13, cursor: 'pointer', minHeight: 40 },
  loginBadge: { background: '#fff', color: '#0ea5e9', border: 'none', padding: '8px 14px', borderRadius: 20, fontSize: 13, fontWeight: 600, cursor: 'pointer', minHeight: 40 },
  toast: { position: 'fixed', top: 70, left: '50%', transform: 'translateX(-50%)', padding: '12px 24px', borderRadius: 10, color: '#fff', fontSize: 15, zIndex: 200, fontWeight: 500 },
  main: { maxWidth: 600, margin: '0 auto', padding: 14, paddingBottom: 90 },
  infoBadge: { textAlign: 'center', padding: 12, background: '#e0f2fe', borderRadius: 10, fontSize: 15, color: '#0369a1', marginBottom: 14, fontWeight: 600 },
  nav: { display: 'flex', gap: 4, marginBottom: 18, background: '#fff', padding: 6, borderRadius: 14 },
  navBtn: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4, padding: '10px 4px', border: 'none', borderRadius: 12, background: 'transparent', cursor: 'pointer', fontSize: 18, minHeight: 56 },
  navActive: { background: '#0ea5e9', color: '#fff' },
  navLabel: { fontSize: 11, fontWeight: 600 },
  view: { display: 'flex', flexDirection: 'column', gap: 14 },
  viewHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' },
  viewTitle: { fontSize: 18, fontWeight: 700 },
  stats: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 },
  stat: { background: '#fff', padding: '14px 6px', borderRadius: 12, textAlign: 'center' },
  statLabel: { fontSize: 11, color: '#64748b', marginBottom: 4 },
  statVal: { fontSize: 20, fontWeight: 700 },
  partyBanner: { background: 'linear-gradient(135deg, #f59e0b, #d97706)', padding: 14, borderRadius: 14, color: '#fff', display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 15 },
  partyBannerBtn: { background: 'rgba(255,255,255,0.2)', border: 'none', color: '#fff', padding: '10px 16px', borderRadius: 10, fontSize: 14, cursor: 'pointer', fontWeight: 600, minHeight: 44 },
  card: { background: '#fff', padding: 18, borderRadius: 14 },
  cardTitle: { fontSize: 16, fontWeight: 700, marginBottom: 14 },
  monthNavBtn: { padding: '14px 16px', background: '#0ea5e9', color: '#fff', border: 'none', fontSize: 16, cursor: 'pointer', minHeight: 48, fontWeight: 600 },
  subTitle: { fontSize: 15, fontWeight: 600, marginBottom: 10, color: '#334155' },
  row: { display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #f1f5f9', fontSize: 15 },
  unpaidBox: { marginTop: 10, padding: 12, background: '#fef2f2', borderRadius: 8, fontSize: 14, color: '#dc2626', lineHeight: 1.5 },
  quickBtns: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 },
  qBtn: { padding: '14px 8px', background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 12, fontSize: 13, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  lotteryBtn: { width: '100%', padding: 16, background: '#8b5cf6', color: '#fff', border: 'none', borderRadius: 12, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  addBtn: { width: 44, height: 44, background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: '50%', fontSize: 24, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' },
  cancelSmBtn: { padding: '6px 10px', background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: 6, fontSize: 12, cursor: 'pointer', fontWeight: 600, minHeight: 32 },
  exportBtn: { padding: '10px 16px', background: '#10b981', color: '#fff', border: 'none', borderRadius: 8, fontSize: 15, cursor: 'pointer', minHeight: 44 },
  memberCard: { background: '#fff', borderRadius: 14, padding: 16 },
  memberTop: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 },
  memberNum: { width: 36, height: 36, background: '#0ea5e9', color: '#fff', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 14, fontWeight: 700 },
  memberInfo: { flex: 1 },
  memberName: { fontSize: 16, fontWeight: 600 },
  memberMemo: { fontSize: 13, color: '#f59e0b', marginTop: 4 },
  memberBtns: { display: 'flex', gap: 8 },
  editBtn: { width: 40, height: 40, background: '#e0f2fe', color: '#0284c7', border: 'none', borderRadius: '50%', cursor: 'pointer', fontSize: 16 },
  delBtn: { width: 40, height: 40, background: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '50%', cursor: 'pointer', fontSize: 18 },
  memberStats: { display: 'flex', justifyContent: 'space-around', paddingTop: 12, borderTop: '1px solid #f1f5f9', fontSize: 14 },
  mLabel: { color: '#64748b', marginRight: 6 },
  notRecItem: { display: 'flex', justifyContent: 'space-between', padding: '12px 14px', background: '#f8fafc', borderRadius: 8, marginBottom: 8, fontSize: 14 },
  histRow: { display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid #f1f5f9', fontSize: 14 },
  empty: { textAlign: 'center', padding: 30, color: '#94a3b8', fontSize: 15 },
  tableWrap: { overflowX: 'auto', background: '#fff', borderRadius: 12, WebkitOverflowScrolling: 'touch' },
  table: { width: '100%', borderCollapse: 'collapse', fontSize: 13 },
  th: { padding: '12px 6px', background: '#f1f5f9', borderBottom: '2px solid #e2e8f0', fontWeight: 600, textAlign: 'center', whiteSpace: 'nowrap' },
  td: { padding: '10px 6px', borderBottom: '1px solid #f1f5f9', textAlign: 'center', whiteSpace: 'nowrap' },
  bulkInfo: { display: 'flex', justifyContent: 'space-between', padding: 14, background: '#fff', borderRadius: 10, fontWeight: 600, fontSize: 15 },
  bulkBtns: { display: 'flex', gap: 10 },
  selectBtn: { flex: 1, padding: 12, background: '#e2e8f0', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, minHeight: 44 },
  bulkList: { display: 'flex', flexDirection: 'column', gap: 8 },
  bulkItem: { display: 'flex', alignItems: 'center', gap: 12, padding: '14px 16px', borderRadius: 10, cursor: 'pointer', minHeight: 52 },
  fixedBtn: { position: 'fixed', bottom: 24, left: 16, right: 16, maxWidth: 568, margin: '0 auto', padding: 16, background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 14, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  emptyParty: { textAlign: 'center', padding: 50 },
  createBtn: { padding: '14px 28px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: 12, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  pastRow: { display: 'flex', justifyContent: 'space-between', padding: '12px 0', borderBottom: '1px solid #f1f5f9', fontSize: 14 },
  partyInfo: { background: '#fff', padding: 18, borderRadius: 14, borderLeft: '4px solid #f59e0b' },
  confirmedBox: { marginTop: 14, padding: 14, background: '#fefce8', borderRadius: 10 },
  link: { color: '#0ea5e9', fontSize: 14, textDecoration: 'none' },
  confirmedTag: { background: '#d1fae5', color: '#059669', padding: '6px 12px', borderRadius: 8, fontSize: 13, fontWeight: 600 },
  voteBar: { display: 'flex', height: 12, borderRadius: 6, overflow: 'hidden', background: '#e2e8f0', marginBottom: 10 },
  voteSection: { height: '100%' },
  voteCounts: { display: 'flex', justifyContent: 'center', gap: 20, fontSize: 15, marginBottom: 14 },
  myVote: { padding: 14, background: '#f8fafc', borderRadius: 10, marginBottom: 14 },
  voteBtns: { display: 'flex', gap: 10, marginTop: 10 },
  voteBtn: { flex: 1, padding: 14, border: 'none', borderRadius: 10, fontSize: 18, cursor: 'pointer', minHeight: 52 },
  attList: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 6 },
  attItem: { display: 'flex', justifyContent: 'space-between', padding: '10px 12px', background: '#f8fafc', borderRadius: 8, fontSize: 14 },
  venueCard: { padding: 16, border: '2px solid #e2e8f0', borderRadius: 12, marginBottom: 10 },
  venueTop: { display: 'flex', justifyContent: 'space-between', marginBottom: 10 },
  voteCount: { fontSize: 28, fontWeight: 700, color: '#0ea5e9' },
  venueActions: { display: 'flex', gap: 10 },
  venueVoteBtn: { flex: 1, padding: 12, border: 'none', borderRadius: 8, fontSize: 14, fontWeight: 600, cursor: 'pointer', minHeight: 44 },
  venueUrlBtn: { padding: '10px 14px', background: '#f1f5f9', border: 'none', borderRadius: 8, textDecoration: 'none', fontSize: 14, minHeight: 44, display: 'flex', alignItems: 'center' },
  venueDelBtn: { padding: '10px 14px', background: '#fee2e2', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, minHeight: 44 },
  addVenueBtns: { display: 'flex', gap: 10 },
  addVenueBtn: { flex: 1, padding: 14, background: '#f1f5f9', border: '2px dashed #cbd5e1', borderRadius: 10, color: '#64748b', cursor: 'pointer', fontSize: 14, minHeight: 48 },
  pastVenueBtn: { flex: 1, padding: 14, background: '#fef3c7', border: 'none', borderRadius: 10, color: '#92400e', cursor: 'pointer', fontSize: 14, minHeight: 48 },
  addVenueForm: { display: 'flex', flexDirection: 'column', gap: 10, marginTop: 14 },
  pastVenuesBox: { marginTop: 14, padding: 14, background: '#fffbeb', borderRadius: 10 },
  pastVenueItem: { display: 'flex', justifyContent: 'space-between', padding: '12px 14px', background: '#fff', borderRadius: 8, marginBottom: 8, cursor: 'pointer', minHeight: 48, alignItems: 'center' },
  confirmBtn: { width: '100%', padding: 14, background: '#10b981', color: '#fff', border: 'none', borderRadius: 10, fontSize: 15, fontWeight: 600, cursor: 'pointer', marginBottom: 10, minHeight: 48 },
  lineBtn: { width: '100%', padding: 14, background: '#06c755', color: '#fff', border: 'none', borderRadius: 10, fontSize: 16, fontWeight: 600, cursor: 'pointer', marginBottom: 10, minHeight: 52 },
  lineLink: { display: 'block', textAlign: 'center', padding: 14, background: '#f1f5f9', borderRadius: 10, color: '#06c755', fontWeight: 600, textDecoration: 'none', fontSize: 15, minHeight: 48 },
  photoGrid: { display: 'flex', flexWrap: 'wrap', gap: 10, marginBottom: 14 },
  photoLink: { width: 56, height: 56, background: '#f1f5f9', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', textDecoration: 'none', fontSize: 24 },
  addPhotoRow: { display: 'flex', gap: 10 },
  addPhotoBtn: { padding: '12px 18px', background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 10, cursor: 'pointer', fontSize: 14, minHeight: 44 },
  completeBtn: { width: '100%', padding: 14, background: '#64748b', color: '#fff', border: 'none', borderRadius: 10, fontSize: 15, fontWeight: 600, cursor: 'pointer', minHeight: 48 },
  overlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16, zIndex: 300 },
  modal: { background: '#fff', borderRadius: 20, padding: 24, width: '100%', maxWidth: 400, maxHeight: '85vh', overflow: 'auto', WebkitOverflowScrolling: 'touch' },
  form: { display: 'flex', flexDirection: 'column', gap: 14 },
  formTitle: { fontSize: 20, fontWeight: 700, marginBottom: 8 },
  label: { fontSize: 14, fontWeight: 600, color: '#475569', marginTop: 8 },
  input: { padding: 14, fontSize: 16, border: '2px solid #e2e8f0', borderRadius: 10, width: '100%', boxSizing: 'border-box', minHeight: 48 },
  hint: { fontSize: 13, color: '#64748b', marginTop: 4 },
  row2: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 },
  total: { padding: 16, background: '#f0f9ff', borderRadius: 10, textAlign: 'center', fontSize: 18, fontWeight: 700, color: '#0284c7' },
  calcResult: { padding: 16, background: '#f0f9ff', borderRadius: 10, textAlign: 'center', fontSize: 18, fontWeight: 700, color: '#0284c7' },
  btnRow: { display: 'flex', gap: 12, marginTop: 8 },
  cancelBtn: { flex: 1, padding: 14, background: '#f1f5f9', color: '#475569', border: 'none', borderRadius: 10, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  submitBtn: { flex: 1, padding: 14, background: '#0ea5e9', color: '#fff', border: 'none', borderRadius: 10, fontSize: 16, fontWeight: 600, cursor: 'pointer', minHeight: 52 },
  linkBtn: { padding: 12, background: 'transparent', color: '#0ea5e9', border: 'none', fontSize: 15, cursor: 'pointer', textDecoration: 'underline' },
  settingsFab: { position: 'fixed', bottom: 24, right: 20, width: 56, height: 56, background: '#fff', border: '2px solid #e2e8f0', borderRadius: '50%', fontSize: 24, cursor: 'pointer', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center' },
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<MoaiManager />);
  </script>
  
  <!-- PWA Service Worker Registration -->
  <script>
    // Service Workerï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰
    const swCode = `
      const CACHE_NAME = 'moai-v1';
      const urlsToCache = ['/'];
      
      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
        );
        self.skipWaiting();
      });
      
      self.addEventListener('fetch', event => {
        event.respondWith(
          fetch(event.request).catch(() => caches.match(event.request))
        );
      });
    `;
    
    // Service Worker ã‚’Blobã¨ã—ã¦ç™»éŒ²
    if ('serviceWorker' in navigator) {
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(reg => {
        console.log('SW registered:', reg);
      }).catch(err => {
        console.log('SW registration failed:', err);
      });
    }
    
    // PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
      const banner = document.createElement('div');
      banner.id = 'pwa-install-banner';
      banner.innerHTML = `
        <div style="position:fixed;bottom:80px;left:16px;right:16px;background:linear-gradient(135deg,#374151,#111827);color:#fff;padding:16px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;display:flex;align-items:center;gap:12px;">
          <svg width="44" height="44" viewBox="0 0 100 100"><defs><linearGradient id="sBg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#6b7280"/><stop offset="10%" style="stop-color:#374151"/><stop offset="90%" style="stop-color:#111827"/><stop offset="100%" style="stop-color:#1f2937"/></linearGradient><linearGradient id="sTop" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:white;stop-opacity:0"/><stop offset="50%" style="stop-color:white;stop-opacity:0.5"/><stop offset="100%" style="stop-color:white;stop-opacity:0"/></linearGradient></defs><rect width="100" height="100" rx="22" fill="url(#sBg)"/><rect x="10" y="8" width="80" height="3" rx="1.5" fill="url(#sTop)"/><text x="50" y="72" text-anchor="middle" font-size="65" font-weight="900" fill="white" font-family="sans-serif">ãƒ¢</text></svg>
          <div style="flex:1;">
            <div style="font-weight:700;margin-bottom:4px;">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
            <div style="font-size:12px;opacity:0.9;">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãˆã¾ã™</div>
          </div>
          <button id="pwa-install-btn" style="background:#fff;color:#1f2937;border:none;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer;">è¿½åŠ </button>
          <button id="pwa-close-btn" style="background:transparent;color:#fff;border:none;font-size:20px;cursor:pointer;padding:4px;">Ã—</button>
        </div>
      `;
      document.body.appendChild(banner);
      
      document.getElementById('pwa-install-btn').addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log('User choice:', outcome);
          deferredPrompt = null;
          banner.remove();
        }
      });
      
      document.getElementById('pwa-close-btn').addEventListener('click', () => {
        banner.remove();
      });
    });
    
    // iOS Safariç”¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    if (isIOS && !isStandalone) {
      setTimeout(() => {
        const iosBanner = document.createElement('div');
        iosBanner.id = 'ios-install-banner';
        iosBanner.innerHTML = `
          <div style="position:fixed;bottom:80px;left:16px;right:16px;background:linear-gradient(135deg,#374151,#111827);color:#fff;padding:16px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
              <svg width="44" height="44" viewBox="0 0 100 100"><defs><linearGradient id="sBg2" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#6b7280"/><stop offset="10%" style="stop-color:#374151"/><stop offset="90%" style="stop-color:#111827"/><stop offset="100%" style="stop-color:#1f2937"/></linearGradient><linearGradient id="sTop2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:white;stop-opacity:0"/><stop offset="50%" style="stop-color:white;stop-opacity:0.5"/><stop offset="100%" style="stop-color:white;stop-opacity:0"/></linearGradient></defs><rect width="100" height="100" rx="22" fill="url(#sBg2)"/><rect x="10" y="8" width="80" height="3" rx="1.5" fill="url(#sTop2)"/><text x="50" y="72" text-anchor="middle" font-size="65" font-weight="900" fill="white" font-family="sans-serif">ãƒ¢</text></svg>
              <div style="flex:1;">
                <div style="font-weight:700;margin-bottom:4px;">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                <div style="font-size:12px;opacity:0.9;">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãˆã¾ã™</div>
              </div>
              <button id="ios-close-btn" style="background:transparent;color:#fff;border:none;font-size:20px;cursor:pointer;padding:4px;">Ã—</button>
            </div>
            <div style="background:rgba(255,255,255,0.15);padding:12px;border-radius:8px;font-size:13px;">
              â‘  ä¸‹ã® <span style="font-size:18px;">â¬†</span>ï¼ˆå…±æœ‰ï¼‰ã‚’ã‚¿ãƒƒãƒ—<br>
              â‘¡ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ
            </div>
          </div>
        `;
        document.body.appendChild(iosBanner);
        
        document.getElementById('ios-close-btn').addEventListener('click', () => {
          iosBanner.remove();
          localStorage.setItem('ios-banner-closed', 'true');
        });
      }, 3000);
    }
  </script>
</body>
</html>
